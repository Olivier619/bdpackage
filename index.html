<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD Creator - Créez des bandes dessinées avec l'IA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FF9800;
            --dark-color: #333;
            --light-color: #f4f4f4;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --disabled-color: #ccc;
        }

        /* ... (keep all existing CSS styles) ... */

        /* Styles spécifiques pour l'application */
        .scenario-section, .scenario-chapter { /* Keep existing */ }
        .scenario-chapter h4 { /* Keep existing */ }
        .storyboard-page { /* Keep existing */ }
        .prompt-item { /* Keep existing */ }
        .prompt-item pre { /* Keep existing */ }
        .session-controls { /* Keep existing */ }
        .session-controls button { /* Keep existing */ }

        #loading-indicator { /* Keep existing */ }
        .spinner { /* Keep existing */ }
        @keyframes spin { /* Keep existing */ }

        /* New Styles */
        .app-controls {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            display: none; /* Hidden by default */
            gap: 10px;
        }
        .app-controls button {
            margin-right: 10px;
        }
        .modification-area {
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        .modification-area textarea {
            width: 100%;
            min-height: 80px;
            margin-bottom: 0.5rem;
        }
        .tab-btn.disabled {
            color: var(--disabled-color);
            cursor: not-allowed;
            background: #eee;
        }
         .chapter-selector {
            margin-bottom: 1.5rem;
        }
        .storyboard-panel-display {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .storyboard-panel-display h5 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
         .storyboard-panel-details p {
            margin-bottom: 5px;
         }
         .storyboard-visual-placeholder {
             border: 1px dashed #ccc;
             min-height: 100px;
             display: flex;
             align-items: center;
             justify-content: center;
             color: #aaa;
             font-style: italic;
             margin-bottom: 10px;
             background-color: #f0f0f0;
         }
         .progress-indicator {
             display: flex;
             justify-content: space-around;
             margin-bottom: 2rem;
             padding: 1rem;
             background-color: #e9ecef;
             border-radius: 5px;
         }
         .progress-step {
             text-align: center;
             color: #adb5bd;
         }
         .progress-step.active {
             color: var(--primary-color);
             font-weight: bold;
         }
         .progress-step.completed {
             color: var(--success-color);
             font-weight: bold;
         }
         .progress-step .icon {
             display: block;
             font-size: 1.5rem;
             margin-bottom: 0.5rem;
         }
         .input-group-inline {
            display: flex;
            gap: 20px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
         }
         .input-group-inline .input-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
         }

    </style>
</head>
<body>
    <header>
        <!-- Keep existing header -->
        <div class="container">
            <div class="logo">
                <i class="fas fa-book-open"></i>
                <span>BD Creator</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#features">Fonctionnalités</a></li>
                    <li><a href="#how-it-works">Comment ça marche</a></li>
                    <li><a href="#app">Créer ma BD</a></li>
                    <li><a href="#" id="login-btn">Connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero">
         <!-- Keep existing hero -->
        <div class="container">
            <h1>Créez des bandes dessinées incroyables avec l'IA</h1>
            <p>Transformez vos idées en scénarios complets, storyboards détaillés et prompts optimisés pour Midjourney en quelques clics.</p>
            <a href="#app" class="btn">Commencer maintenant</a>
        </div>
    </section>

    <section class="features" id="features">
         <!-- Keep existing features, maybe update text slightly -->
        <div class="container">
            <div class="section-title">
                <h2>Fonctionnalités</h2>
                <p>Découvrez les outils puissants qui vous aideront à créer des bandes dessinées professionnelles sans effort, étape par étape.</p>
            </div>
            <div class="features-grid">
                 <div class="feature-card">
                    <i class="fas fa-lightbulb"></i>
                    <h3>Idée Initiale & Options</h3>
                    <p>Définissez votre idée, choisissez le genre, le style visuel et le ton pour guider l'IA.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-brain"></i>
                    <h3>Génération de Scénario Structuré</h3>
                    <p>Obtenez un scénario détaillé (page/case) avec descriptions et dialogues. Validez ou demandez des modifications.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-pencil-alt"></i>
                    <h3>Storyboard Assisté</h3>
                    <p>Visualisez votre histoire avec des suggestions de cadrage et de composition pour chaque case. Approuvez chapitre par chapitre.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-image"></i>
                    <h3>Prompts Midjourney Optimisés</h3>
                    <p>Générez des prompts en anglais prêts à l'emploi pour Midjourney, basés sur votre storyboard et style.</p>
                </div>
                 <div class="feature-card">
                    <i class="fas fa-tasks"></i>
                    <h3>Workflow Guidé</h3>
                    <p>Suivez un processus étape par étape avec des validations pour garder le contrôle créatif total.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-save"></i>
                    <h3>Sauvegarde de Sessions</h3>
                    <p>Sauvegardez votre progression à tout moment et reprenez votre projet de BD plus tard.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="how-it-works" id="how-it-works">
         <!-- Keep existing how-it-works, update steps -->
        <div class="container">
            <div class="section-title">
                <h2>Comment ça marche</h2>
                <p>Suivez ces étapes simples pour créer votre bande dessinée avec l'aide de l'IA.</p>
            </div>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <h3>Décrivez votre idée</h3>
                    <p>Entrez des mots-clés ou une description. Choisissez le genre, le style visuel et le ton.</p>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <h3>Générez & Validez le Scénario</h3>
                    <p>L'IA crée un scénario structuré. Lisez-le, demandez des modifications si besoin, puis approuvez.</p>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <h3>Approuvez le Storyboard</h3>
                    <p>Pour chaque chapitre, visualisez le storyboard avec suggestions de cadrage/composition. Approuvez.</p>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <h3>Obtenez les Prompts</h3>
                    <p>Recevez les prompts Midjourney optimisés pour chaque case du chapitre approuvé. Copiez et créez !</p>
                </div>
            </div>
        </div>
    </section>

    <section class="app" id="app">
        <div class="container">
            <div class="section-title">
                <h2>Créez votre BD maintenant</h2>
                <p>Utilisez notre application pour transformer vos idées en bandes dessinées complètes.</p>
            </div>

            <div class="session-controls">
                <button class="btn" id="new-session">Nouvelle session</button>
                <button class="btn" id="save-session">Sauvegarder la session</button>
                <button class="btn" id="load-session">Charger une session</button>
            </div>

            <!-- Progress Indicator -->
             <div class="progress-indicator">
                <div class="progress-step active" id="step-idea">
                    <span class="icon"><i class="fas fa-lightbulb"></i></span> Idée
                </div>
                <div class="progress-step" id="step-scenario">
                    <span class="icon"><i class="fas fa-file-alt"></i></span> Scénario
                </div>
                <div class="progress-step" id="step-storyboard">
                     <span class="icon"><i class="fas fa-border-all"></i></span> Storyboard
                </div>
                <div class="progress-step" id="step-prompts">
                    <span class="icon"><i class="fas fa-magic"></i></span> Prompts
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="home">1. Idée & Options</button>
                <button class="tab-btn disabled" data-tab="scenario">2. Scénario</button>
                <button class="tab-btn disabled" data-tab="storyboard">3. Storyboard</button>
                <button class="tab-btn disabled" data-tab="prompts">4. Prompts</button>
            </div>

            <!-- Tab 1: Home / Idea Input -->
            <div class="tab-content active" id="home-content">
                <h3>Entrez les détails de votre projet</h3>
                <p>Commencez par décrire votre idée et choisissez les options pour guider l'IA.</p>

                <div class="input-group">
                    <label for="keywords">Idée initiale (mots-clés, phrase, ou courte histoire)</label>
                    <textarea id="keywords" placeholder="Ex: Aventure spatiale avec des chats pirates cherchant une planète de thon légendaire." rows="3"></textarea>
                </div>

                <div class="input-group-inline">
                     <div class="input-group">
                        <label for="genre">Genre</label>
                        <select id="genre">
                            <option value="Fantastique">Fantastique</option>
                            <option value="Science-Fiction">Science-Fiction</option>
                            <option value="Policier">Policier</option>
                            <option value="Humour">Humour</option>
                            <option value="Drame">Drame</option>
                            <option value="Aventure">Aventure</option>
                            <option value="Slice of Life">Slice of Life</option>
                            <option value="Horreur">Horreur</option>
                            <!-- Add more genres -->
                        </select>
                    </div>

                     <div class="input-group">
                        <label for="style">Style Visuel Cible</label>
                        <select id="style">
                            <option value="Manga">Manga</option>
                            <option value="Franco-Belge">Franco-Belge (Ligne Claire)</option>
                            <option value="Comics US">Comics US (Super-héros)</option>
                            <option value="Réaliste">Réaliste / Peinture Numérique</option>
                            <option value="Cartoon">Cartoon / Animation</option>
                            <option value="Aquarelle">Aquarelle</option>
                             <!-- Add more styles -->
                        </select>
                    </div>

                     <div class="input-group">
                        <label for="tone">Ton</label>
                        <select id="tone">
                            <option value="Épique">Épique</option>
                            <option value="Sérieux">Sérieux</option>
                            <option value="Léger / Humoristique">Léger / Humoristique</option>
                            <option value="Sombre / Mature">Sombre / Mature</option>
                            <option value="Mystérieux">Mystérieux</option>
                            <option value="Poétique">Poétique</option>
                            <!-- Add more tones -->
                        </select>
                    </div>
                </div>

                 <div class="input-group">
                    <label for="details">Détails Optionnels (Personnages principaux, Univers, Éléments clés)</label>
                    <textarea id="details" placeholder="Ex: Capitaine Moustache (chat roux borgne), Second Patte-de-Velours (chat noir agile). Vaisseau: Le Sardine Volante. Cherchent la planète Catlantic." rows="4"></textarea>
                </div>

                <button class="btn btn-primary" id="generate-scenario">Générer le Scénario</button>

                <div id="loading-indicator">
                    <div class="spinner"></div>
                    <p>Génération en cours... L'IA travaille, cela peut prendre plusieurs minutes.</p>
                </div>
            </div>

            <!-- Tab 2: Scenario -->
            <div class="tab-content" id="scenario-content">
                <h3>Votre Scénario</h3>
                <div id="scenario-output">
                    <p>Générez d'abord un scénario depuis l'onglet "Idée & Options".</p>
                    <!-- Scenario content will be loaded here -->
                </div>

                <div class="app-controls" id="scenario-controls">
                    <button class="btn btn-success" id="approve-scenario">Approuver le Scénario</button>
                    <button class="btn btn-primary" id="modify-scenario-request">Demander Modifications</button>
                    <button class="btn btn-danger" id="regenerate-scenario">Régénérer Scénario</button>
                </div>
                <div class="modification-area" id="scenario-modification-area">
                    <label for="scenario-modification-input">Décrivez les modifications souhaitées :</label>
                    <textarea id="scenario-modification-input"></textarea>
                    <button class="btn btn-primary" id="submit-scenario-modification">Soumettre Modification</button>
                </div>
            </div>

            <!-- Tab 3: Storyboard -->
            <div class="tab-content" id="storyboard-content">
                <h3>Votre Storyboard</h3>
                 <div class="chapter-selector">
                     <label for="storyboard-chapter-select">Choisir le chapitre :</label>
                     <select id="storyboard-chapter-select" disabled>
                         <option>Approuvez d'abord le scénario</option>
                     </select>
                 </div>
                <div id="storyboard-output">
                    <p>Approuvez d'abord le scénario pour générer le storyboard.</p>
                    <!-- Storyboard content for the selected chapter will be loaded here -->
                </div>

                 <div class="app-controls" id="storyboard-controls">
                    <button class="btn btn-success" id="approve-storyboard-chapter">Approuver Storyboard Chapitre</button>
                    <button class="btn btn-primary" id="modify-storyboard-request">Demander Modifications Chapitre</button>
                    <button class="btn btn-danger" id="regenerate-storyboard-chapter">Régénérer Storyboard Chapitre</button>
                </div>
                 <div class="modification-area" id="storyboard-modification-area">
                    <label for="storyboard-modification-input">Décrivez les modifications souhaitées pour ce chapitre :</label>
                    <textarea id="storyboard-modification-input"></textarea>
                    <button class="btn btn-primary" id="submit-storyboard-modification">Soumettre Modification</button>
                </div>
            </div>

            <!-- Tab 4: Prompts -->
            <div class="tab-content" id="prompts-content">
                <h3>Vos Prompts Midjourney</h3>
                 <div class="chapter-selector">
                     <label for="prompts-chapter-select">Choisir le chapitre :</label>
                     <select id="prompts-chapter-select" disabled>
                         <option>Approuvez d'abord le storyboard</option>
                     </select>
                 </div>
                <div id="prompts-output">
                    <p>Approuvez d'abord le storyboard d'un chapitre pour générer les prompts.</p>
                    <!-- Prompts for the selected chapter will be loaded here -->
                </div>
                 <!-- Add export/copy all button maybe -->
            </div>
        </div>
    </section>

    <footer>
         <!-- Keep existing footer -->
        <div class="container">
            <p>© 2025 BD Creator. Tous droits réservés.</p>
            <div class="social-links">
                <a href="#"><i class="fab fa-facebook"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-youtube"></i></a>
            </div>
            <div class="footer-links">
                <a href="#">À propos</a>
                <a href="#">Confidentialité</a>
                <a href="#">Conditions d'utilisation</a>
                <a href="#">Contact</a>
                <a href="#" id="create-website-btn">Créer mon site web</a>
            </div>
        </div>
    </footer>

    <!-- Load Transformers.js library -->
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.0"></script>
    <!-- Load your custom story generator logic -->
    <script src="story_generator.js"></script>
    <!-- Inline script for UI interactions and workflow management -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const loadingIndicator = document.getElementById('loading-indicator');
            const keywordsInput = document.getElementById('keywords');
            const genreSelect = document.getElementById('genre');
            const styleSelect = document.getElementById('style');
            const toneSelect = document.getElementById('tone');
            const detailsInput = document.getElementById('details');
            const generateScenarioBtn = document.getElementById('generate-scenario');

            const scenarioOutput = document.getElementById('scenario-output');
            const scenarioControls = document.getElementById('scenario-controls');
            const approveScenarioBtn = document.getElementById('approve-scenario');
            const modifyScenarioRequestBtn = document.getElementById('modify-scenario-request');
            const regenerateScenarioBtn = document.getElementById('regenerate-scenario');
            const scenarioModificationArea = document.getElementById('scenario-modification-area');
            const scenarioModificationInput = document.getElementById('scenario-modification-input');
            const submitScenarioModificationBtn = document.getElementById('submit-scenario-modification');

            const storyboardChapterSelect = document.getElementById('storyboard-chapter-select');
            const storyboardOutput = document.getElementById('storyboard-output');
            const storyboardControls = document.getElementById('storyboard-controls');
            const approveStoryboardChapterBtn = document.getElementById('approve-storyboard-chapter');
            // ... (add buttons for storyboard modification/regeneration)

            const promptsChapterSelect = document.getElementById('prompts-chapter-select');
            const promptsOutput = document.getElementById('prompts-output');

            const progressSteps = {
                idea: document.getElementById('step-idea'),
                scenario: document.getElementById('step-scenario'),
                storyboard: document.getElementById('step-storyboard'),
                prompts: document.getElementById('step-prompts'),
            };

            const tabs = {
                home: document.querySelector('[data-tab="home"]'),
                scenario: document.querySelector('[data-tab="scenario"]'),
                storyboard: document.querySelector('[data-tab="storyboard"]'),
                prompts: document.querySelector('[data-tab="prompts"]'),
            }

            // --- Application State ---
            let appState = {
                currentStep: 'idea', // idea, scenario_generated, scenario_approved, storyboard_chapter_approved, prompts_generated
                scenarioData: null, // Will hold the structured scenario object
                storyboardData: {}, // Keyed by chapter index
                promptsData: {},    // Keyed by chapter index
                approvedChapters: [], // List of approved chapter indices for storyboard/prompts
                keywords: '',
                genre: '',
                style: '',
                tone: '',
                details: '',
                activeTab: 'home'
            };

            // --- Functions ---

            function updateUI() {
                // Update Progress Indicator
                Object.values(progressSteps).forEach(step => step.classList.remove('active', 'completed'));
                if (appState.currentStep === 'idea') {
                    progressSteps.idea.classList.add('active');
                } else {
                     progressSteps.idea.classList.add('completed');
                }
                if (appState.currentStep.startsWith('scenario')) {
                     progressSteps.scenario.classList.add('active');
                } else if (appState.currentStep !== 'idea') {
                    progressSteps.scenario.classList.add('completed');
                }
                 if (appState.currentStep.startsWith('storyboard')) {
                     progressSteps.storyboard.classList.add('active');
                 } else if (!appState.currentStep.startsWith('idea') && !appState.currentStep.startsWith('scenario')) {
                     progressSteps.storyboard.classList.add('completed');
                 }
                 if (appState.currentStep.startsWith('prompts')) {
                     progressSteps.prompts.classList.add('active');
                 } else if (appState.currentStep === 'completed') { // Assuming a final state
                    progressSteps.prompts.classList.add('completed');
                 }


                // Update Tabs Enabled/Disabled State & Active Tab
                tabBtns.forEach(btn => {
                    const tab = btn.getAttribute('data-tab');
                    btn.classList.remove('active');
                    btn.classList.add('disabled'); // Disable all first

                    if (tab === 'home') btn.classList.remove('disabled'); // Home always enabled
                    if (appState.currentStep !== 'idea' && tab === 'scenario') btn.classList.remove('disabled');
                    if (appState.currentStep.includes('approved') || appState.currentStep.startsWith('storyboard') || appState.currentStep.startsWith('prompts') && tab === 'storyboard') btn.classList.remove('disabled');
                    // Enable prompts tab only if at least one storyboard chapter is approved
                    if ((appState.currentStep.includes('storyboard_chapter_approved') || appState.currentStep.startsWith('prompts')) && appState.approvedChapters.length > 0 && tab === 'prompts') {
                         btn.classList.remove('disabled');
                    }

                    if (tab === appState.activeTab) {
                        btn.classList.add('active');
                    }
                });
                 tabContents.forEach(content => content.classList.remove('active'));
                 document.getElementById(`${appState.activeTab}-content`).classList.add('active');


                // Update Scenario Tab Content & Controls
                if (appState.scenarioData) {
                    displayScenario(appState.scenarioData);
                    scenarioControls.style.display = appState.currentStep === 'scenario_generated' ? 'flex' : 'none';
                     scenarioModificationArea.style.display = 'none'; // Hide modification area by default
                } else {
                    scenarioOutput.innerHTML = '<p>Générez d\'abord un scénario depuis l\'onglet "Idée & Options".</p>';
                    scenarioControls.style.display = 'none';
                }


                 // Update Storyboard Tab
                 updateChapterSelect(storyboardChapterSelect, 'storyboard');
                 if (appState.currentStep.startsWith('storyboard') || appState.currentStep.startsWith('prompts') || appState.currentStep === 'scenario_approved') {
                      storyboardChapterSelect.disabled = false;
                      const selectedChapterIndex = parseInt(storyboardChapterSelect.value);
                      if (!isNaN(selectedChapterIndex) && appState.storyboardData[selectedChapterIndex]) {
                          displayStoryboardChapter(selectedChapterIndex);
                           storyboardControls.style.display = !appState.approvedChapters.includes(selectedChapterIndex) ? 'flex' : 'none';
                      } else if (!isNaN(selectedChapterIndex)) {
                          storyboardOutput.innerHTML = `<p>Storyboard pour le chapitre ${selectedChapterIndex + 1} pas encore généré ou approuvé.</p><button class='btn btn-primary generate-storyboard-btn' data-chapter='${selectedChapterIndex}'>Générer Storyboard Chapitre ${selectedChapterIndex + 1}</button>`;
                          storyboardControls.style.display = 'none';
                           // Add listener for dynamically created button
                           document.querySelector('.generate-storyboard-btn')?.addEventListener('click', handleGenerateStoryboardChapter);
                      } else {
                           storyboardOutput.innerHTML = '<p>Sélectionnez un chapitre pour voir ou générer le storyboard.</p>';
                           storyboardControls.style.display = 'none';
                      }
                 } else {
                     storyboardOutput.innerHTML = '<p>Approuvez d\'abord le scénario pour générer le storyboard.</p>';
                     storyboardChapterSelect.disabled = true;
                      storyboardControls.style.display = 'none';
                 }


                // Update Prompts Tab
                 updateChapterSelect(promptsChapterSelect, 'prompts');
                 if (appState.approvedChapters.length > 0 && (appState.currentStep.startsWith('prompts') || appState.currentStep.includes('storyboard_chapter_approved'))) {
                     promptsChapterSelect.disabled = false;
                     const selectedChapterIndex = parseInt(promptsChapterSelect.value);
                      if (!isNaN(selectedChapterIndex) && appState.promptsData[selectedChapterIndex]) {
                          displayPromptsChapter(selectedChapterIndex);
                      } else if (!isNaN(selectedChapterIndex) && appState.approvedChapters.includes(selectedChapterIndex)) {
                           promptsOutput.innerHTML = `<p>Prompts pour le chapitre ${selectedChapterIndex + 1} pas encore générés.</p><button class='btn btn-primary generate-prompts-btn' data-chapter='${selectedChapterIndex}'>Générer Prompts Chapitre ${selectedChapterIndex + 1}</button>`;
                           // Add listener for dynamically created button
                           document.querySelector('.generate-prompts-btn')?.addEventListener('click', handleGeneratePromptsChapter);
                      } else if (!isNaN(selectedChapterIndex)) {
                           promptsOutput.innerHTML = '<p>Approuvez d\'abord le storyboard de ce chapitre pour générer les prompts.</p>';
                      } else {
                           promptsOutput.innerHTML = '<p>Sélectionnez un chapitre dont le storyboard est approuvé.</p>';
                      }
                 } else {
                     promptsOutput.innerHTML = '<p>Approuvez d\'abord le storyboard d\'un chapitre pour générer les prompts.</p>';
                     promptsChapterSelect.disabled = true;
                 }


                // Hide loading indicator
                loadingIndicator.style.display = 'none';
            }

            function displayScenario(scenario) {
                 // Check if scenario is the expected structured object
                 if (!scenario || typeof scenario !== 'object' || !scenario.title || !Array.isArray(scenario.chapters)) {
                     scenarioOutput.innerHTML = '<p class="text-danger">Erreur : Le format du scénario généré est incorrect.</p>';
                     console.error("Invalid scenario structure:", scenario);
                     return;
                 }

                let html = `<h3>${scenario.title}</h3>`;
                if(scenario.synopsis) {
                     html += `<div class="scenario-section"><h4>Synopsis</h4><p>${scenario.synopsis.replace(/\n/g, '<br>')}</p></div>`;
                }

                 scenario.chapters.forEach((chapter, index) => {
                     html += `<div class="scenario-chapter"><h4>Chapitre ${index + 1}: ${chapter.title || ''}</h4>`;
                     if (chapter.summary) {
                          html += `<p><strong>Résumé :</strong> ${chapter.summary.replace(/\n/g, '<br>')}</p>`;
                     }
                     if (Array.isArray(chapter.pages)) {
                          chapter.pages.forEach(page => {
                               html += `<div class="scenario-page" style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 15px; margin-top:10px;"><h5>Page ${page.pageNumber}</h5>`;
                               if(Array.isArray(page.panels)) {
                                    page.panels.forEach(panel => {
                                         html += `<div class="scenario-panel" style="margin-left: 20px; margin-bottom: 5px;"><strong>Case ${panel.panelNumber}:</strong> `;
                                         html += `<em>${panel.description || 'Pas de description.'}</em>`;
                                         if(panel.dialogue) {
                                              html += ` Dialogue: "${panel.dialogue}"`;
                                         }
                                         html += `</div>`;
                                    });
                               }
                               html += `</div>`; // Close scenario-page
                          });
                     } else {
                          html += `<p><em>(Détail des pages/cases non disponible dans ce format)</em></p>`;
                     }
                     html += `</div>`; // Close scenario-chapter
                 });
                scenarioOutput.innerHTML = html;
            }

             function updateChapterSelect(selectElement, type) {
                 selectElement.innerHTML = ''; // Clear existing options
                 if (!appState.scenarioData || !Array.isArray(appState.scenarioData.chapters)) {
                     const defaultOption = document.createElement('option');
                      if (type === 'storyboard') defaultOption.textContent = 'Générez d\'abord le scénario';
                      else defaultOption.textContent = 'Approuvez d\'abord le storyboard';
                     selectElement.appendChild(defaultOption);
                     selectElement.disabled = true;
                     return;
                 }

                 if (type === 'prompts' && appState.approvedChapters.length === 0) {
                     const defaultOption = document.createElement('option');
                     defaultOption.textContent = 'Approuvez d\'abord un storyboard';
                     selectElement.appendChild(defaultOption);
                     selectElement.disabled = true;
                     return;
                 }

                 appState.scenarioData.chapters.forEach((chapter, index) => {
                     // Only add chapter to prompts select if its storyboard is approved
                     if (type === 'prompts' && !appState.approvedChapters.includes(index)) {
                         return;
                     }

                     const option = document.createElement('option');
                     option.value = index;
                     option.textContent = `Chapitre ${index + 1}: ${chapter.title || `Chapitre ${index + 1}`}`;
                      if (appState.approvedChapters.includes(index)) {
                          option.textContent += " (Storyboard Approuvé)";
                      }
                     selectElement.appendChild(option);
                 });

                 selectElement.disabled = selectElement.options.length === 0;
             }

             function displayStoryboardChapter(chapterIndex) {
                const chapterData = appState.storyboardData[chapterIndex];
                 if (!chapterData) {
                     storyboardOutput.innerHTML = `<p>Erreur: Données du storyboard non trouvées pour le chapitre ${chapterIndex + 1}.</p>`;
                     return;
                 }

                 let html = `<h4>Storyboard - Chapitre ${chapterIndex + 1}</h4>`;
                 chapterData.forEach(panel => {
                     html += `
                        <div class="storyboard-panel-display">
                            <h5>Page ${panel.pageNumber} / Case ${panel.panelNumber}</h5>
                             <div class="storyboard-visual-placeholder">
                                 (Visualisation: ${panel.framing || 'Non défini'} - ${panel.composition || 'Non défini'})
                             </div>
                            <div class="storyboard-panel-details">
                                <p><strong>Description Scénario:</strong> ${panel.scenarioDesc || 'N/A'}</p>
                                <p><strong>Cadrage Suggéré:</strong> ${panel.framing || 'N/A'}</p>
                                <p><strong>Composition Suggérée:</strong> ${panel.composition || 'N/A'}</p>
                             </div>
                         </div>
                     `;
                 });
                 storyboardOutput.innerHTML = html;
             }

             function displayPromptsChapter(chapterIndex) {
                 const chapterPrompts = appState.promptsData[chapterIndex];
                 if (!chapterPrompts || !Array.isArray(chapterPrompts)) {
                     promptsOutput.innerHTML = `<p>Erreur: Données des prompts non trouvées pour le chapitre ${chapterIndex + 1}.</p>`;
                     return;
                 }

                 let html = `<h4>Prompts Midjourney - Chapitre ${chapterIndex + 1}</h4>`;
                 chapterPrompts.forEach((promptData, index) => {
                     html += `
                        <div class="prompt-item">
                            <h5>Page ${promptData.pageNumber} / Case ${promptData.panelNumber}</h5>
                            <p><strong>Description:</strong> ${promptData.description || 'N/A'}</p>
                             <pre>${promptData.prompt || 'Erreur: Prompt non généré.'}</pre>
                            <button class="btn btn-sm btn-secondary copy-prompt-btn" data-prompt="${escape(promptData.prompt || '')}">Copier</button>
                         </div>
                     `;
                 });
                 promptsOutput.innerHTML = html;

                 // Add listeners for copy buttons
                 document.querySelectorAll('.copy-prompt-btn').forEach(btn => {
                     btn.addEventListener('click', function() {
                         const promptText = unescape(this.getAttribute('data-prompt'));
                         navigator.clipboard.writeText(promptText).then(() => {
                             alert('Prompt copié dans le presse-papiers !');
                         }).catch(err => {
                             console.error('Erreur de copie:', err);
                             alert('Erreur lors de la copie du prompt.');
                         });
                     });
                 });
             }

            async function handleGenerateScenario() {
                appState.keywords = keywordsInput.value.trim();
                appState.genre = genreSelect.value;
                appState.style = styleSelect.value;
                appState.tone = toneSelect.value;
                appState.details = detailsInput.value.trim();

                if (!appState.keywords) {
                    alert('Veuillez entrer une idée initiale (mots-clés, phrase...).');
                    return;
                }

                loadingIndicator.style.display = 'block';
                generateScenarioBtn.disabled = true;

                try {
                    // Call the actual generation function from story_generator.js
                    appState.scenarioData = await generateStory(appState.keywords, appState.genre, appState.style, appState.tone, appState.details);
                    appState.currentStep = 'scenario_generated';
                    appState.activeTab = 'scenario'; // Switch to scenario tab
                    // Reset storyboard and prompts if scenario is regenerated
                    appState.storyboardData = {};
                    appState.promptsData = {};
                    appState.approvedChapters = [];
                } catch (error) {
                    console.error("Scenario generation error:", error);
                    scenarioOutput.innerHTML = `<p class="text-danger">Erreur lors de la génération du scénario : ${error.message}. Essayez de simplifier l'idée ou vérifiez la console.</p>`;
                    appState.currentStep = 'idea'; // Revert state on error
                } finally {
                    loadingIndicator.style.display = 'none';
                    generateScenarioBtn.disabled = false;
                    updateUI(); // Update UI based on new state
                }
            }

            function handleApproveScenario() {
                if (!appState.scenarioData) return;
                appState.currentStep = 'scenario_approved';
                appState.activeTab = 'storyboard'; // Move to storyboard tab
                updateUI();
                 // Automatically select the first chapter for storyboard generation
                 if (storyboardChapterSelect.options.length > 0) {
                     storyboardChapterSelect.selectedIndex = 0;
                     storyboardChapterSelect.dispatchEvent(new Event('change')); // Trigger change event
                 }
            }

            function handleModifyScenarioRequest() {
                 scenarioModificationArea.style.display = 'block';
                 scenarioControls.style.display = 'none'; // Hide main controls when modifying
            }

            async function handleSubmitScenarioModification() {
                 const modificationRequest = scenarioModificationInput.value.trim();
                 if (!modificationRequest) {
                     alert("Veuillez décrire les modifications souhaitées.");
                     return;
                 }
                 alert("Fonctionnalité de modification non implémentée dans cette version.\nDans une version complète, cela enverrait une nouvelle requête à l'IA avec le scénario actuel et la demande de modification.");
                  // In a full implementation:
                  // loadingIndicator.style.display = 'block';
                  // try {
                  //    appState.scenarioData = await modifyScenario(appState.scenarioData, modificationRequest, appState.genre, ...);
                  //    appState.currentStep = 'scenario_generated'; // Back to needing approval
                  // } catch (error) { ... } finally { ... }
                  // scenarioModificationArea.style.display = 'none';
                  // updateUI();
            }

             async function handleGenerateStoryboardChapter(event) {
                 const targetButton = event.target;
                 const chapterIndex = parseInt(targetButton.getAttribute('data-chapter'));
                 if (isNaN(chapterIndex) || !appState.scenarioData || !appState.scenarioData.chapters[chapterIndex]) {
                     alert("Erreur: Impossible de trouver les données du scénario pour ce chapitre.");
                     return;
                 }

                 loadingIndicator.style.display = 'block';
                 targetButton.disabled = true;

                 try {
                     const scenarioChapter = appState.scenarioData.chapters[chapterIndex];
                     // Need to extract relevant page/panel data for the chapter
                     const chapterPanelData = [];
                      scenarioChapter.pages?.forEach(page => {
                          page.panels?.forEach(panel => {
                              chapterPanelData.push({
                                   pageNumber: page.pageNumber,
                                   panelNumber: panel.panelNumber,
                                   description: panel.description,
                                   dialogue: panel.dialogue
                              });
                          });
                      });

                     appState.storyboardData[chapterIndex] = await generateStoryboardChapter(chapterPanelData, appState.style, appState.tone);
                     appState.currentStep = 'storyboard_chapter_generated'; // Or keep as scenario_approved? Decide state flow.
                     displayStoryboardChapter(chapterIndex); // Update display immediately
                 } catch (error) {
                      console.error(`Storyboard generation error for chapter ${chapterIndex + 1}:`, error);
                     storyboardOutput.innerHTML = `<p class="text-danger">Erreur lors de la génération du storyboard pour le chapitre ${chapterIndex + 1}: ${error.message}.</p>`;
                 } finally {
                      loadingIndicator.style.display = 'none';
                      targetButton.disabled = false; // Re-enable button or hide it depending on state logic
                      updateUI();
                 }
             }


            function handleApproveStoryboardChapter() {
                const selectedChapterIndex = parseInt(storyboardChapterSelect.value);
                 if (isNaN(selectedChapterIndex) || !appState.storyboardData[selectedChapterIndex]) {
                      alert("Veuillez sélectionner un chapitre avec un storyboard généré.");
                      return;
                 }

                 if (!appState.approvedChapters.includes(selectedChapterIndex)) {
                     appState.approvedChapters.push(selectedChapterIndex);
                 }
                 appState.currentStep = 'storyboard_chapter_approved'; // Or a state indicating how many are approved
                 appState.activeTab = 'prompts';
                 updateUI();
                  // Automatically select the newly approved chapter in the prompts tab
                  if (promptsChapterSelect.options.length > 0) {
                      // Find the option corresponding to the approved chapter
                      const optionToSelect = Array.from(promptsChapterSelect.options).find(opt => parseInt(opt.value) === selectedChapterIndex);
                      if(optionToSelect) {
                           promptsChapterSelect.value = selectedChapterIndex;
                           promptsChapterSelect.dispatchEvent(new Event('change'));
                      } else {
                           // If it's the first approved chapter, refresh the select and select it
                           updateChapterSelect(promptsChapterSelect, 'prompts');
                           promptsChapterSelect.value = selectedChapterIndex;
                           promptsChapterSelect.dispatchEvent(new Event('change'));
                      }
                  }
            }

             async function handleGeneratePromptsChapter(event) {
                 const targetButton = event.target;
                 const chapterIndex = parseInt(targetButton.getAttribute('data-chapter'));
                  if (isNaN(chapterIndex) || !appState.storyboardData[chapterIndex]) {
                     alert("Erreur: Impossible de trouver les données du storyboard pour ce chapitre.");
                     return;
                 }

                 loadingIndicator.style.display = 'block';
                 targetButton.disabled = true;

                 try {
                     appState.promptsData[chapterIndex] = await generatePromptsForChapter(appState.storyboardData[chapterIndex], appState.style, appState.tone);
                     appState.currentStep = 'prompts_generated'; // Or track per chapter
                      displayPromptsChapter(chapterIndex); // Update display
                 } catch (error) {
                      console.error(`Prompts generation error for chapter ${chapterIndex + 1}:`, error);
                     promptsOutput.innerHTML = `<p class="text-danger">Erreur lors de la génération des prompts pour le chapitre ${chapterIndex + 1}: ${error.message}.</p>`;
                 } finally {
                      loadingIndicator.style.display = 'none';
                      targetButton.disabled = false; // Or hide
                      updateUI();
                 }
             }


            // --- Event Listeners ---
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return; // Prevent clicking disabled tabs
                    const tabId = this.getAttribute('data-tab');
                    appState.activeTab = tabId;
                    updateUI(); // Use updateUI to manage active classes
                });
            });

            generateScenarioBtn.addEventListener('click', handleGenerateScenario);
            approveScenarioBtn.addEventListener('click', handleApproveScenario);
            modifyScenarioRequestBtn.addEventListener('click', handleModifyScenarioRequest);
            submitScenarioModificationBtn.addEventListener('click', handleSubmitScenarioModification);
             // TODO: Add listener for regenerateScenarioBtn

             storyboardChapterSelect.addEventListener('change', function() {
                  updateUI(); // Refresh storyboard display on chapter change
             });
            approveStoryboardChapterBtn.addEventListener('click', handleApproveStoryboardChapter);
             // TODO: Add listeners for storyboard modification/regeneration

             promptsChapterSelect.addEventListener('change', function() {
                  updateUI(); // Refresh prompts display on chapter change
             });

             // Session Management Listeners (Adapted)
             document.getElementById('new-session').addEventListener('click', function() {
                 if (confirm('Êtes-vous sûr de vouloir créer une nouvelle session ? Toutes les données non sauvegardées seront perdues.')) {
                      // Reset state to initial
                      appState = {
                          currentStep: 'idea', scenarioData: null, storyboardData: {}, promptsData: {}, approvedChapters: [],
                          keywords: '', genre: '', style: '', tone: '', details: '', activeTab: 'home'
                      };
                      // Clear inputs
                      keywordsInput.value = '';
                      genreSelect.selectedIndex = 0;
                      styleSelect.selectedIndex = 0;
                      toneSelect.selectedIndex = 0;
                      detailsInput.value = '';
                      // Reset outputs
                      scenarioOutput.innerHTML = '<p>Générez d\'abord un scénario...</p>';
                      storyboardOutput.innerHTML = '<p>Approuvez d\'abord le scénario...</p>';
                      promptsOutput.innerHTML = '<p>Approuvez d\'abord le storyboard...</p>';
                      updateUI();
                 }
             });

            document.getElementById('save-session').addEventListener('click', function() {
                 // Include appState in session data
                const sessionData = {
                    inputs: {
                        keywords: keywordsInput.value,
                        genre: genreSelect.value,
                        style: styleSelect.value,
                        tone: toneSelect.value,
                        details: detailsInput.value
                    },
                    state: appState // Save the entire state object
                };

                const sessionName = prompt('Donnez un nom à cette session:');
                if (sessionName) {
                    try {
                         localStorage.setItem(`bdcreator_session_${sessionName}`, JSON.stringify(sessionData));
                         alert(`Session "${sessionName}" sauvegardée avec succès!`);
                    } catch (e) {
                         alert(`Erreur lors de la sauvegarde: ${e.message}. L'espace de stockage est peut-être plein.`);
                         console.error("Local storage save error:", e);
                    }
                }
            });

             document.getElementById('load-session').addEventListener('click', function() {
                 const sessions = [];
                 for (let i = 0; i < localStorage.length; i++) {
                     const key = localStorage.key(i);
                     if (key.startsWith('bdcreator_session_')) {
                         sessions.push(key.replace('bdcreator_session_', ''));
                     }
                 }

                 if (sessions.length === 0) {
                     alert('Aucune session sauvegardée trouvée.');
                     return;
                 }

                 const sessionName = prompt(`Choisissez une session à charger (${sessions.join(', ')}):`, sessions[0]);
                 if (sessionName && sessions.includes(sessionName)) {
                     try {
                          const sessionData = JSON.parse(localStorage.getItem(`bdcreator_session_${sessionName}`));

                          // Restore inputs
                          keywordsInput.value = sessionData.inputs.keywords || '';
                          genreSelect.value = sessionData.inputs.genre || 'Fantastique';
                          styleSelect.value = sessionData.inputs.style || 'Manga';
                          toneSelect.value = sessionData.inputs.tone || 'Épique';
                          detailsInput.value = sessionData.inputs.details || '';

                          // Restore state
                          appState = sessionData.state;

                          alert(`Session "${sessionName}" chargée avec succès!`);
                          updateUI(); // Update UI with loaded state
                     } catch (e) {
                          alert(`Erreur lors du chargement de la session "${sessionName}": ${e.message}`);
                          console.error("Load session error:", e);
                     }
                 }
             });


            // Correction du lien "Create my website"
            document.getElementById('create-website-btn').addEventListener('click', function(e) {
                e.preventDefault();
                alert('Cette fonctionnalité de création de site externe n\'est pas incluse dans BD Creator.');
            });

            // --- Initial UI Setup ---
            updateUI();

        });
    </script>

</body>
</html>
