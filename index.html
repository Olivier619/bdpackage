<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD Creator - Créez des bandes dessinées avec l'IA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- Styles CSS (identiques à avant, y compris les styles pour #outline-display-area, #chapter-detail-area, etc.) --- */
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FF9800;
            --dark-color: #333;
            --light-color: #f4f4f4;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --disabled-color: #ccc;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; background-color: #f8f9fa; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header { background-color: var(--primary-color); color: white; padding: 1rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo { font-size: 1.8rem; font-weight: bold; display: flex; align-items: center; margin-bottom: 0.5rem; }
        .logo i { margin-right: 10px; font-size: 2rem; }
        nav ul { display: flex; list-style: none; flex-wrap: wrap; justify-content: center; }
        nav ul li { margin-left: 10px; margin-right: 10px; margin-bottom: 0.5rem; }
        nav ul li a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s; }
        nav ul li a:hover { color: var(--secondary-color); }
        .hero { background: linear-gradient(135deg, var(--primary-color) 0%, #64b5f6 100%); color: white; padding: 4rem 0; text-align: center; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        .hero p { font-size: 1.2rem; max-width: 800px; margin: 0 auto 2rem; }
        .btn { display: inline-block; background: var(--secondary-color); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; transition: background 0.3s, transform 0.2s; text-decoration: none; font-weight: 500; }
        .btn:hover { background: #e68a00; transform: translateY(-2px); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        .btn-primary { background: var(--primary-color); }
        .btn-primary:hover { background: #0b7dda; }
        .btn-primary:disabled { background-color: #a0cff8; }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .features { padding: 4rem 0; background-color: white; }
        .section-title { text-align: center; margin-bottom: 3rem; }
        .section-title h2 { font-size: 2rem; color: var(--dark-color); margin-bottom: 1rem; }
        .section-title p { color: #666; max-width: 800px; margin: 0 auto; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .feature-card { background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; text-align: center; }
        .feature-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .feature-card i { font-size: 3rem; color: var(--primary-color); margin-bottom: 1.5rem; }
        .feature-card h3 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--dark-color); }
        .feature-card p { color: #666; }
        .how-it-works { padding: 4rem 0; background-color: #f8f9fa; }
        .steps { display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem; margin-top: 3rem; }
        .step { flex: 1; min-width: 250px; max-width: 350px; text-align: center; position: relative; }
        .step-number { width: 50px; height: 50px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; margin: 0 auto 1.5rem; }
        .step h3 { margin-bottom: 1rem; color: var(--dark-color); }
        .step p { color: #666; }
        .app { padding: 4rem 0; background-color: white; }
        .tabs { display: flex; justify-content: center; margin-bottom: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 1rem; flex-wrap: wrap; }
        .tab-btn { background: none; border: none; padding: 0.8rem 1.5rem; margin: 0 0.5rem 0.5rem 0.5rem; font-size: 1rem; cursor: pointer; border-radius: 5px 5px 0 0; transition: background 0.3s, color 0.3s; font-weight: 500; }
        .tab-btn.active { background-color: var(--primary-color); color: white; }
        .tab-content { display: none; padding: 2rem; background: white; border-radius: 0 0 8px 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); min-height: 200px; }
        .tab-content.active { display: block; }
        .input-group { margin-bottom: 1.5rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; font-family: inherit; }
        .input-group textarea { min-height: 80px; resize: vertical; }
        footer { background-color: var(--dark-color); color: white; padding: 2rem 0; text-align: center; margin-top: 4rem; }
        footer p { margin-bottom: 1rem; }
        .social-links { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
        .social-links a { color: white; font-size: 1.5rem; transition: color 0.3s; }
        .social-links a:hover { color: var(--secondary-color); }
        .footer-links { display: flex; justify-content: center; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1rem; }
        .footer-links a { color: #ddd; text-decoration: none; transition: color 0.3s; }
        .footer-links a:hover { color: var(--secondary-color); }
        /* Application Specific Styles */
        .scenario-section, .scenario-chapter, .storyboard-page, .prompt-item { margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border-left: 4px solid var(--primary-color); }
        #outline-display-area { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        #outline-display-area h4 { margin-bottom: 15px; color: var(--dark-color); }
        #outline-display-area ul { list-style: none; padding-left: 0; }
        #outline-display-area li { padding: 10px; border: 1px solid #e0e0e0; margin-bottom: 10px; border-radius: 5px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        #outline-display-area li div { flex-grow: 1; margin-right: 10px; margin-bottom: 5px; }
        #outline-display-area li button { flex-shrink: 0; }
        #chapter-detail-area { margin-top: 20px; padding: 15px; background-color: #f0f8ff; border-radius: 5px; border: 1px solid #d1e7fd; display: none; }
        #chapter-detail-area h4 { color: var(--primary-color); margin-bottom: 10px; }
        #chapter-detail-area pre { white-space: pre-wrap; background-color: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px; max-height: 500px; overflow-y: auto; margin-top: 10px; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; font-size: 0.9em; }
        .storyboard-page { margin-bottom: 20px; padding: 15px; background-color: #fffaf0; border-radius: 8px; border-left: 4px solid var(--secondary-color); }
        .storyboard-page h5 { color: var(--secondary-color); margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .storyboard-panel-display { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #fafafa; }
        .storyboard-panel-display h6 { color: var(--dark-color); margin-bottom: 8px; }
        .storyboard-panel-details p { margin-bottom: 5px; font-size: 0.95em; }
        .storyboard-panel-details p strong { color: var(--dark-color); }
        .storyboard-visual-placeholder { border: 1px dashed #ccc; min-height: 100px; display: flex; align-items: center; justify-content: center; color: #aaa; font-style: italic; margin-top: 10px; background-color: #f0f0f0; border-radius: 4px; padding: 10px; text-align: center; }
        .prompt-item { border-left-color: var(--success-color); }
        .prompt-item pre { background-color: #333; color: white; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 10px; white-space: pre-wrap; word-break: break-all; }
        .session-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .session-controls button { flex: 1 1 auto; min-width: 150px; }
        #loading-indicator, #storyboard-loading-indicator { display: none; text-align: center; margin: 20px 0; padding: 15px; background-color: rgba(255, 255, 255, 0.8); border-radius: 8px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .app-controls { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; display: none; gap: 10px; flex-wrap: wrap; }
        .app-controls button { margin-right: 10px; margin-bottom: 10px; }
        .modification-area { margin-top: 1rem; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa; display: none; }
        .modification-area label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modification-area textarea { width: 100%; min-height: 80px; margin-bottom: 0.5rem; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .tab-btn.disabled { color: var(--disabled-color); cursor: not-allowed; background: #eee; }
        .chapter-selector { margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .chapter-selector label { margin-bottom: 0; font-weight: 500; white-space: nowrap; }
        .chapter-selector select { flex-grow: 1; max-width: 400px; padding: 0.6rem; }
        .chapter-selector button { flex-shrink: 0; }
        .progress-indicator { display: flex; justify-content: space-around; margin-bottom: 2rem; padding: 1rem; background-color: #e9ecef; border-radius: 5px; flex-wrap: wrap; gap: 10px; }
        .progress-step { text-align: center; color: #adb5bd; flex: 1; min-width: 80px; }
        .progress-step.active { color: var(--primary-color); font-weight: bold; }
        .progress-step.completed { color: var(--success-color); font-weight: bold; }
        .progress-step .icon { display: block; font-size: 1.5rem; margin-bottom: 0.5rem; }
        .input-group-inline { display: flex; gap: 20px; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .input-group-inline .input-group { flex: 1; min-width: 200px; margin-bottom: 0; }
        .text-danger { color: var(--danger-color); font-weight: bold; }
        /* Media Queries */
        @media (max-width: 768px) {
             header .container { flex-direction: column; text-align: center; }
             nav ul { margin-top: 1rem; justify-content: center; }
             nav ul li { margin-left: 10px; margin-right: 10px; }
            .hero h1 { font-size: 2rem; } .hero p { font-size: 1rem; }
            .features-grid { grid-template-columns: 1fr; }
            .steps { flex-direction: column; align-items: center; }
            .step { margin-bottom: 2rem; max-width: 90%; }
            .tabs { justify-content: flex-start; }
            .tab-btn { flex-grow: 1; margin-left: 0; margin-right: 0; }
            .session-controls { justify-content: center; }
            .input-group-inline { flex-direction: column; gap: 1rem; }
            .chapter-selector { flex-direction: column; align-items: flex-start; gap: 5px;}
            .chapter-selector select { max-width: 100%; }
             .chapter-selector button { width: 100%; margin-top: 5px; }
            .progress-indicator { gap: 5px; } .progress-step .icon { font-size: 1.2rem; }
            #outline-display-area li { flex-direction: column; align-items: flex-start;}
            #outline-display-area li div { margin-right: 0; }
            #outline-display-area li button { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-book-open"></i>
                <span>BD Creator</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#features">Fonctionnalités</a></li>
                    <li><a href="#how-it-works">Comment ça marche</a></li>
                    <li><a href="#app">Créer ma BD</a></li>
                    <li><a href="#" id="login-btn">Connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <h1>Créez des bandes dessinées incroyables avec l'IA</h1>
            <p>Transformez vos idées en scénarios complets, storyboards détaillés et prompts optimisés en quelques clics grâce à l'IA côté serveur.</p>
            <a href="#app" class="btn">Commencer maintenant</a>
        </div>
    </section>

    <section class="features" id="features">
        <!-- Contenu des fonctionnalités -->
         <div class="container">
             <div class="section-title"><h2>Fonctionnalités</h2><p>Découvrez ce que BD Creator peut faire pour vous.</p></div>
             <div class="features-grid">
                 <div class="feature-card"><i class="fas fa-lightbulb"></i><h3>Idée Initiale & Options</h3><p>Démarrez avec une simple idée, phrase ou mots-clés. Choisissez le genre, le style visuel et le ton pour guider l'IA.</p></div>
                 <div class="feature-card"><i class="fas fa-server"></i><h3>Génération Scénario via API</h3><p>Notre IA côté serveur transforme votre idée en une ossature complète (titre, chapitres, résumés), puis génère le détail de chaque chapitre.</p></div>
                 <div class="feature-card"><i class="fas fa-pencil-alt"></i><h3>Storyboard Assisté</h3><p>Visualisez votre histoire avec des suggestions de cadrage, composition et style pour chaque case, basées sur le scénario détaillé.</p></div>
                 <div class="feature-card"><i class="fas fa-image"></i><h3>Prompts Optimisés (Bientôt)</h3><p>Générez des prompts prêts pour Midjourney, Dall-E ou Stable Diffusion, basés sur votre storyboard et le style visuel choisi.</p></div>
                 <div class="feature-card"><i class="fas fa-tasks"></i><h3>Workflow Guidé</h3><p>Suivez un processus étape par étape, de l'idée initiale à la génération des prompts, avec des indicateurs de progression clairs.</p></div>
                 <div class="feature-card"><i class="fas fa-save"></i><h3>Sauvegarde de Sessions</h3><p>Ne perdez jamais votre travail. Sauvegardez et chargez vos sessions de création directement dans votre navigateur.</p></div>
             </div>
         </div>
    </section>

    <section class="how-it-works" id="how-it-works">
        <!-- Comment ça marche -->
         <div class="container">
             <div class="section-title"><h2>Comment ça marche</h2><p>Un processus simple en 4 étapes pour donner vie à vos histoires.</p></div>
             <div class="steps">
                 <div class="step"><div class="step-number">1</div><h3>Décrivez votre idée</h3><p>Fournissez le concept de base de votre BD et sélectionnez les options clés (genre, style, ton).</p></div>
                 <div class="step"><div class="step-number">2</div><h3>Générez & Validez l'Ossature</h3><p>L'IA crée l'ossature (titres, résumés). Générez ensuite le détail des chapitres qui vous intéressent.</p></div>
                 <div class="step"><div class="step-number">3</div><h3>Générez le Storyboard</h3><p>Pour chaque chapitre détaillé, obtenez des suggestions visuelles (plan, angle...) pour chaque case clé.</p></div>
                 <div class="step"><div class="step-number">4</div><h3>Obtenez les Prompts (Bientôt)</h3><p>Recevez les prompts d'IA générative d'image optimisés pour chaque case du storyboard approuvé.</p></div>
             </div>
         </div>
    </section>

    <section class="app" id="app">
        <div class="container">
            <div class="section-title">
                <h2>Créez votre BD maintenant</h2>
                <p>Utilisez notre application pour transformer vos idées en bandes dessinées complètes.</p>
            </div>

            <div class="session-controls">
                <button class="btn" id="new-session">Nouvelle session</button>
                <button class="btn" id="save-session">Sauvegarder la session</button>
                <button class="btn" id="load-session">Charger une session</button>
            </div>

            <!-- Progress Indicator -->
             <div class="progress-indicator">
                <div class="progress-step active" id="step-idea"><span class="icon"><i class="fas fa-lightbulb"></i></span>Idée</div>
                <div class="progress-step" id="step-scenario"><span class="icon"><i class="fas fa-file-alt"></i></span>Scénario</div>
                <div class="progress-step" id="step-storyboard"><span class="icon"><i class="fas fa-border-all"></i></span>Storyboard</div>
                <div class="progress-step" id="step-prompts"><span class="icon"><i class="fas fa-magic"></i></span>Prompts</div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="home">1. Idée & Options</button>
                <button class="tab-btn disabled" data-tab="scenario">2. Scénario</button>
                <button class="tab-btn disabled" data-tab="storyboard">3. Storyboard</button>
                <button class="tab-btn disabled" data-tab="prompts">4. Prompts</button>
            </div>

            <!-- Tab 1: Home / Idea Input -->
            <div class="tab-content active" id="home-content">
                <h3>Entrez les détails de votre projet</h3>
                <p>Commencez par décrire votre idée et choisissez les options pour guider l'IA.</p>
                <div class="input-group">
                    <label for="keywords">Idée initiale (mots-clés, phrase, ou courte histoire)</label>
                    <textarea id="keywords" placeholder="Ex: Aventure spatiale avec des chats pirates cherchant une planète de thon légendaire." rows="3"></textarea>
                </div>
                <div class="input-group-inline">
                     <div class="input-group"><label for="genre">Genre</label><select id="genre"><option value="Fantastique">Fantastique</option><option value="Science-Fiction">Science-Fiction</option><option value="Policier">Policier</option><option value="Humour">Humour</option><option value="Drame">Drame</option><option value="Aventure">Aventure</option><option value="Slice of Life">Slice of Life</option><option value="Horreur">Horreur</option><option value="Historique">Historique</option><option value="Western">Western</option></select></div>
                     <div class="input-group"><label for="style">Style Visuel Cible</label><select id="style"><option value="Manga">Manga</option><option value="Franco-Belge">Franco-Belge (Ligne Claire)</option><option value="Comics US">Comics US (Super-héros)</option><option value="Réaliste">Réaliste / Peinture Numérique</option><option value="Cartoon">Cartoon / Animation</option><option value="Aquarelle">Aquarelle</option><option value="Pixel Art">Pixel Art</option><option value="Noir et Blanc">Noir et Blanc (Ink)</option></select></div>
                     <div class="input-group"><label for="tone">Ton</label><select id="tone"><option value="Épique">Épique</option><option value="Sérieux">Sérieux</option><option value="Léger / Humoristique">Léger / Humoristique</option><option value="Sombre / Mature">Sombre / Mature</option><option value="Mystérieux">Mystérieux</option><option value="Poétique">Poétique</option><option value="Satirique">Satirique</option><option value="Action">Action</option></select></div>
                </div>
                 <div class="input-group">
                    <label for="details">Détails Optionnels (Personnages principaux, Univers, Éléments clés)</label>
                    <textarea id="details" placeholder="Ex: Capitaine Moustache (chat roux borgne), Second Patte-de-Velours (chat noir agile). Vaisseau: Le Sardine Volante. Cherchent la planète Catlantic." rows="4"></textarea>
                </div>
                <button class="btn btn-primary" id="generate-scenario">Générer l'Ossature</button>
                <div id="loading-indicator"><div class="spinner"></div><p>Génération en cours via l'API...</p></div>
            </div>

            <!-- Tab 2: Scenario -->
            <div class="tab-content" id="scenario-content">
                <h3>Votre Ossature / Scénario</h3>
                <div id="scenario-output">
                    <div id="outline-display-area"><p>L'ossature de votre scénario (titre, chapitres, résumés) s'affichera ici après la génération initiale.</p></div>
                    <hr style="margin: 20px 0;">
                    <div id="chapter-detail-area"><p>Le contenu détaillé du chapitre sélectionné s'affichera ici après sa génération.</p></div>
                </div>
                <div class="app-controls" id="scenario-controls">
                    <button class="btn btn-success" id="approve-scenario">Passer au Storyboard</button> <!-- Texte simplifié -->
                    <button class="btn btn-primary" id="modify-scenario-request">Demander Modifications (Ossature)</button>
                    <button class="btn btn-danger" id="regenerate-scenario">Régénérer Ossature</button>
                </div>
                <div class="modification-area" id="scenario-modification-area">
                    <label for="scenario-modification-input">Décrivez les modifications souhaitées pour l'ossature :</label>
                    <textarea id="scenario-modification-input"></textarea>
                    <button class="btn btn-primary" id="submit-scenario-modification">Soumettre Modification</button>
                </div>
            </div>

            <!-- Tab 3: Storyboard -->
             <div class="tab-content" id="storyboard-content">
                 <h3>Votre Storyboard</h3>
                 <div class="chapter-selector" id="storyboard-chapter-selector-container" style="display: none;">
                     <label for="storyboard-chapter-select">Choisir le chapitre :</label>
                     <select id="storyboard-chapter-select"><option value="">-- Sélectionnez --</option></select>
                     <button class="btn btn-primary btn-sm" id="generate-storyboard-btn" disabled>Générer Storyboard Chapitre</button>
                 </div>
                 <div id="storyboard-loading-indicator" style="display: none; margin-top: 15px;">
                     <div class="spinner"></div>
                     <p>Génération du storyboard pour ce chapitre...</p>
                 </div>
                 <div id="storyboard-output">
                     <p>Sélectionnez un chapitre dont le détail a été généré, puis cliquez sur "Générer Storyboard Chapitre".</p>
                 </div>
             </div>


            <!-- Tab 4: Prompts -->
            <div class="tab-content" id="prompts-content">
                <h3>Vos Prompts Midjourney (Bientôt Disponible)</h3>
                <div id="prompts-output">
                    <p>Générez et approuvez d'abord le storyboard d'un chapitre.</p>
                    <p>La fonctionnalité de génération de prompts sera ajoutée prochainement.</p>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <!-- Contenu du footer -->
         <div class="container">
            <p>© 2025 BD Creator. Tous droits réservés.</p>
            <div class="social-links">
                <a href="#" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
            </div>
            <div class="footer-links">
                <a href="#">Politique de confidentialité</a>
                <a href="#">Conditions d'utilisation</a>
                <a href="#">Contact</a>
            </div>
        </div>
    </footer>

    <!-- Inline script includes all necessary JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const loadingIndicator = document.getElementById('loading-indicator');
            const keywordsInput = document.getElementById('keywords');
            const genreSelect = document.getElementById('genre');
            const styleSelect = document.getElementById('style');
            const toneSelect = document.getElementById('tone');
            const detailsInput = document.getElementById('details');
            const generateScenarioBtn = document.getElementById('generate-scenario'); // Now generates Outline

            // Scenario/Outline Tab Elements
            const scenarioOutput = document.getElementById('scenario-output');
            const outlineDisplayArea = document.getElementById('outline-display-area');
            const chapterDetailArea = document.getElementById('chapter-detail-area');
            const scenarioControls = document.getElementById('scenario-controls');
            const approveScenarioBtn = document.getElementById('approve-scenario');
            const modifyScenarioRequestBtn = document.getElementById('modify-scenario-request');
            const regenerateScenarioBtn = document.getElementById('regenerate-scenario');
            const scenarioModificationArea = document.getElementById('scenario-modification-area');
            const scenarioModificationInput = document.getElementById('scenario-modification-input');
            const submitScenarioModificationBtn = document.getElementById('submit-scenario-modification');

            // Storyboard Tab Elements
            const storyboardChapterSelectorContainer = document.getElementById('storyboard-chapter-selector-container');
            const storyboardChapterSelect = document.getElementById('storyboard-chapter-select');
            const generateStoryboardBtn = document.getElementById('generate-storyboard-btn');
            const storyboardLoadingIndicator = document.getElementById('storyboard-loading-indicator');
            const storyboardOutput = document.getElementById('storyboard-output');

            // Prompts Tab Elements
            const promptsOutput = document.getElementById('prompts-output');

            // Progress Indicator Steps
            const progressSteps = {
                idea: document.getElementById('step-idea'),
                scenario: document.getElementById('step-scenario'),
                storyboard: document.getElementById('step-storyboard'),
                prompts: document.getElementById('step-prompts'),
            };

            // Tab Buttons Map
            const tabs = {
                home: document.querySelector('[data-tab="home"]'),
                scenario: document.querySelector('[data-tab="scenario"]'),
                storyboard: document.querySelector('[data-tab="storyboard"]'),
                prompts: document.querySelector('[data-tab="prompts"]'),
            };

            // --- Application State ---
             let appState = {
                 currentStep: 'idea', // idea, outline_generated, chapter_detail_generated, outline_approved, storyboard_generated, ...
                 outlineData: null, // { title: '...', chapters: [{chapter: 1, title: '...', summary: '...'}, ...] }
                 chapterDetailData: {}, // { 1: {scenarioText: '...'}, 2: {error: '...'}, ... }
                 storyboardData: {}, // { 1: [{page:1, panel:1, ...}, ...], 2: {error: '...'}, ...}
                 lastInputData: null, // { keywords, genre, style, tone, details }
                 activeTab: 'home'
             };

            // --- Helper Functions ---

            // Simple HTML Escaping
            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return unsafe;
                return unsafe
                     .replace(/&/g, "&") // Use & for ampersand
                     .replace(/</g, "<")
                     .replace(/>/g, ">")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "'"); // Use numeric entity for single quote
             }

             // Show/Hide Generic Loading Indicator
             function showLoadingIndicator(show) {
                 if (loadingIndicator) {
                     loadingIndicator.style.display = show ? 'block' : 'none';
                 }
             }
             // Show/Hide Storyboard Specific Loading Indicator
             function showStoryboardLoading(show) {
                 if (storyboardLoadingIndicator) {
                    storyboardLoadingIndicator.style.display = show ? 'block' : 'none';
                 }
             }

            // --- Display Functions ---

            function displayOutline(outlineData) {
                 outlineDisplayArea.innerHTML = '';
                 if (!outlineData) { outlineDisplayArea.innerHTML = '<p>Aucune donnée d\'ossature à afficher.</p>'; return; }

                 if (outlineData.parsingError) {
                     console.warn("Backend outline parsing failed:", outlineData.parsingError);
                     outlineDisplayArea.innerHTML = `<h4>Erreur d'Analyse de l'Ossature</h4><p>L'IA a répondu, mais le format n'a pas pu être analysé automatiquement. Voici le texte brut :</p><pre style="white-space: pre-wrap; background-color: #eee; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;">${escapeHtml(outlineData.rawText || 'N/A')}</pre>`;
                     chapterDetailArea.innerHTML = '';
                     chapterDetailArea.style.display = 'none';
                     return;
                 }

                 const globalTitle = outlineData.title || "Titre non défini";
                 const titleElement = document.createElement('h4');
                 titleElement.style.marginBottom = '15px';
                 titleElement.textContent = `Titre Global : ${globalTitle}`;
                 outlineDisplayArea.appendChild(titleElement);

                 const chaptersArray = outlineData.chapters;
                 if (Array.isArray(chaptersArray) && chaptersArray.length > 0) {
                     const chapterList = document.createElement('ul');
                     chaptersArray.forEach(chapter => {
                         const listItem = document.createElement('li');
                         const chapterInfo = document.createElement('div');
                         chapterInfo.innerHTML = `<b>Chapitre ${chapter.chapter}: ${escapeHtml(chapter.title || '')}</b><br><small><i>${escapeHtml(chapter.summary || 'Résumé non fourni.')}</i></small>`;
                         listItem.appendChild(chapterInfo);

                         const generateButton = document.createElement('button');
                         generateButton.textContent = `Générer Détail`;
                         generateButton.classList.add('btn', 'btn-sm', 'btn-secondary');
                         generateButton.dataset.chapterNumber = chapter.chapter;
                         generateButton.dataset.chapterTitle = chapter.title || '';
                         generateButton.onclick = handleGenerateChapterDetail;
                         listItem.appendChild(generateButton);
                         chapterList.appendChild(listItem);
                     });
                     outlineDisplayArea.appendChild(chapterList);
                     chapterDetailArea.innerHTML = '<p>Sélectionnez un chapitre ci-dessus pour générer son contenu détaillé.</p>';
                     chapterDetailArea.style.display = 'block';
                 } else {
                     outlineDisplayArea.innerHTML += '<p>Aucun chapitre trouvé dans l\'ossature.</p>';
                     chapterDetailArea.innerHTML = '';
                     chapterDetailArea.style.display = 'none';
                 }
             }

            // --- *** VERSION SIMPLE DE displayChapterDetail POUR TESTER *** ---
            function displayChapterDetail(chapterNumber, detailData) {
                console.log("Début displayChapterDetail pour chap:", chapterNumber, "Data:", detailData); // Log 1

                // 1. TROUVER LA ZONE D'AFFICHAGE
                const chapterDetailOutputArea = document.getElementById('chapter-detail-area');

                if (!chapterDetailOutputArea) {
                     console.error("ERREUR CRITIQUE: Impossible de trouver #chapter-detail-area !"); // Log 2a
                     return;
                }
                console.log("Zone #chapter-detail-area trouvée:", chapterDetailOutputArea); // Log 2b

                // 2. VIDER ET RENDRE VISIBLE
                chapterDetailOutputArea.innerHTML = '';
                chapterDetailOutputArea.style.display = 'block';
                console.log("Zone vidée et display mis à 'block'."); // Log 3

                // 3. AJOUTER LE TITRE
                try {
                     const titleElement = document.createElement('h4');
                     titleElement.textContent = `Détail Simple - Chapitre ${chapterNumber}`; // Corrected: Removed invalid catch
                     chapterDetailOutputArea.appendChild(titleElement);
                     console.log("Titre H4 ajouté."); // Log 4
                } catch (e) {
                     console.error("Erreur lors de l'ajout du H4:", e); // Log 4 Erreur
                }


                // 4. VÉRIFIER ET AFFICHER LE TEXTE OU L'ERREUR
                if (detailData && detailData.scenarioText) {
                     try {
                          const preElement = document.createElement('pre');
                          preElement.textContent = detailData.scenarioText;
                          // Styles visibles (optional, can use CSS instead)
                          preElement.style.border = "1px solid #ddd"; // More subtle border
                          preElement.style.padding = "10px";
                          preElement.style.margin = "10px 0";
                          preElement.style.backgroundColor = "#fff"; // White background usually better
                          preElement.style.color = "#333"; // Dark text
                          preElement.style.minHeight = "50px";
                          preElement.style.whiteSpace = "pre-wrap";
                          preElement.style.maxHeight = "500px";
                          preElement.style.overflowY = "auto";
                          preElement.style.fontFamily = "Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace"; // Match CSS
                          preElement.style.fontSize = "0.9em"; // Match CSS
                          chapterDetailOutputArea.appendChild(preElement);
                          console.log("Texte du scénario (<pre>) ajouté à la page."); // Log 5a
                     } catch (e) {
                          console.error("Erreur lors de l'ajout du <pre>:", e); // Log 5a Erreur
                     }

                } else if (detailData && detailData.error) {
                    try {
                         const errorElement = document.createElement('p');
                         errorElement.style.color = 'red';
                         errorElement.textContent = `Erreur reçue du serveur : ${detailData.error} ${detailData.details ? '(' + detailData.details + ')' : ''}`; // Corrected: Removed invalid catch
                         chapterDetailOutputArea.appendChild(errorElement);
                         console.error("Erreur serveur affichée:", detailData); // Log 5b Erreur Serveur
                    } catch (e) {
                         console.error("Erreur lors de l'ajout du <p> d'erreur serveur:", e);
                    }
                } else {
                     try {
                          const errorElement = document.createElement('p');
                          errorElement.style.color = 'orange';
                          errorElement.textContent = `Impossible d'afficher le détail : données reçues inattendues ou vides.`;
                          chapterDetailOutputArea.appendChild(errorElement);
                          console.warn("Données inattendues reçues:", detailData); // Log 5c Données Inattendues
                     } catch (e) {
                          console.error("Erreur lors de l'ajout du <p> de données inattendues:", e);
                     }
                }
                console.log("Fin de displayChapterDetail."); // Log 6
            }
            // --- *** FIN DE LA VERSION SIMPLE *** ---

             function displayStoryboard(chapterNumber, storyboardData) {
                storyboardOutput.innerHTML = ''; // Clear placeholder/previous

                if (!storyboardData) {
                    storyboardOutput.innerHTML = `<p class="text-danger">Aucune donnée de storyboard reçue pour le chapitre ${chapterNumber}.</p>`;
                    return;
                }
                // Handle parsing error from backend
                if (storyboardData.parsingError) {
                     storyboardOutput.innerHTML = `<h4>Erreur d'Analyse du Storyboard (Chap. ${chapterNumber})</h4>
                                                <p>L'IA a répondu, mais le format n'a pas pu être analysé automatiquement. Voici le texte brut reçu :</p>
                                                <pre style="white-space: pre-wrap; background-color: #eee; padding: 10px; border-radius: 4px; max-height: 400px; overflow-y: auto;">${escapeHtml(storyboardData.rawText || 'N/A')}</pre>`;
                     return;
                }

                // Assume storyboardData is the array of panel objects
                let currentPage = -1;
                let pageContainer = null;

                if (Array.isArray(storyboardData) && storyboardData.length > 0) {
                     storyboardData.forEach(panelData => {
                          if (panelData.page !== currentPage) {
                               currentPage = panelData.page;
                               pageContainer = document.createElement('div');
                               pageContainer.classList.add('storyboard-page');
                               pageContainer.innerHTML = `<h5>Page ${currentPage}</h5>`;
                               storyboardOutput.appendChild(pageContainer);
                          }
                          if(pageContainer) {
                               const panelElement = document.createElement('div');
                               panelElement.classList.add('storyboard-panel-display');
                               panelElement.innerHTML = `
                                   <h6>Case ${panelData.panel}</h6>
                                   <div class="storyboard-panel-details">
                                       <p><strong>Description:</strong> ${escapeHtml(panelData.description || 'N/A')}</p>
                                       <p><strong>Type Plan:</strong> ${escapeHtml(panelData.shotType || 'N/A')}</p>
                                       <p><strong>Angle:</strong> ${escapeHtml(panelData.angle || 'N/A')}</p>
                                       ${panelData.notes ? `<p><i>Notes: ${escapeHtml(panelData.notes)}</i></p>` : ''}
                                   </div>
                                   <div class="storyboard-visual-placeholder">
                                       [ Emplacement Visuel Case ${currentPage}-${panelData.panel} ]
                                   </div>
                               `;
                               pageContainer.appendChild(panelElement);
                          }
                     });
                } else if (Array.isArray(storyboardData) && storyboardData.length === 0) {
                     storyboardOutput.innerHTML = `<p>Aucune case de storyboard n'a pu être extraite pour le chapitre ${chapterNumber}.</p>`;
                 } else {
                      // Fallback for unexpected format, display as JSON
                      storyboardOutput.innerHTML = `<h4>Storyboard Chapitre ${chapterNumber} (Format Inconnu)</h4><pre>${escapeHtml(JSON.stringify(storyboardData, null, 2))}</pre>`;
                 }
            }


             // --- UI Update Logic ---
            function updateUI() {
                console.log("Updating UI, current step:", appState.currentStep, "active tab:", appState.activeTab);

                // Progress Indicator
                Object.values(progressSteps).forEach(step => step.classList.remove('active', 'completed'));
                const stepsCompleted = ['idea'];
                if (appState.currentStep === 'outline_generated' || appState.currentStep === 'chapter_detail_generated' || appState.currentStep === 'outline_approved' || appState.currentStep === 'storyboard_generated') {
                    stepsCompleted.push('scenario');
                }
                 if (appState.currentStep === 'outline_approved' || appState.currentStep === 'storyboard_generated') {
                     stepsCompleted.push('storyboard'); // Mark storyboard step itself if approved or generated
                 }
                 // Add 'prompts' later if needed:
                 // if (appState.currentStep === 'prompts_generated') {
                 //    stepsCompleted.push('prompts');
                 // }

                 stepsCompleted.forEach(step => {
                    if(progressSteps[step]) progressSteps[step].classList.add('completed');
                 });
                 // Set active step
                 if (appState.currentStep === 'idea') progressSteps.idea.classList.add('active');
                 else if (appState.currentStep === 'outline_generated' || appState.currentStep === 'chapter_detail_generated') progressSteps.scenario.classList.add('active');
                 else if (appState.currentStep === 'outline_approved' || appState.currentStep === 'storyboard_generated') progressSteps.storyboard.classList.add('active');
                 // Add prompts later:
                 // else if (appState.currentStep === 'prompts_generated') progressSteps.prompts.classList.add('active');


                // Tabs Activation/Disabling
                const hasValidOutline = !!appState.outlineData && !appState.outlineData.parsingError;
                const hasGeneratedAnyDetails = Object.values(appState.chapterDetailData).some(detail => detail && !detail.error);
                // Allow activating storyboard tab if outline is approved OR if at least one detail was successfully generated
                const canAccessStoryboard = hasValidOutline && (appState.currentStep === 'outline_approved' || hasGeneratedAnyDetails);
                // Define when prompts can be accessed (e.g., after at least one storyboard is generated)
                const hasGeneratedAnyStoryboard = Object.values(appState.storyboardData).some(sb => sb && !sb.error && !sb.parsingError && Array.isArray(sb) && sb.length > 0);
                const canAccessPrompts = hasGeneratedAnyStoryboard; // Update this logic as needed

                tabs.scenario.classList.toggle('disabled', !appState.outlineData);
                tabs.storyboard.classList.toggle('disabled', !canAccessStoryboard);
                tabs.prompts.classList.toggle('disabled', !canAccessPrompts); // TODO: Adjust based on storyboard state

                // Tab Content Display
                tabContents.forEach(content => { content.style.display = content.id === `${appState.activeTab}-content` ? 'block' : 'none'; });
                tabBtns.forEach(btn => { btn.classList.toggle('active', btn.getAttribute('data-tab') === appState.activeTab); });

                // --- Scenario/Outline Tab Specific Updates ---
                if (appState.activeTab === 'scenario') { // <<< IF Principal pour l'onglet
                    const hasValidOutline = !!appState.outlineData && !appState.outlineData.parsingError;

                    if (appState.outlineData) { // <<< IF imbriqué : SI on a une ossature
                        // 1. Afficher l'ossature
                        displayOutline(appState.outlineData);

                        // 2. Gérer la visibilité/placeholder de la zone détail
                        const isDetailAlreadyDisplayed = chapterDetailArea.querySelector('h4')?.textContent.includes('Détail Simple - Chapitre');
                        if (!isDetailAlreadyDisplayed) {
                             if (chapterDetailArea.textContent.includes('Sélectionnez un chapitre') || chapterDetailArea.innerHTML === '') {
                                chapterDetailArea.innerHTML = '<p>Sélectionnez un chapitre ci-dessus pour générer son contenu détaillé.</p>';
                                chapterDetailArea.style.display = 'block';
                                console.log("updateUI: Placeholder détail affiché.");
                             } else {
                                  // If there's existing content (maybe an error message), leave it visible
                                  chapterDetailArea.style.display = 'block';
                                  console.log("updateUI: Contenu existant (erreur?) dans zone détail laissé tel quel.");
                             }
                        } else {
                             // If detail is already displayed, ensure the area stays visible
                             chapterDetailArea.style.display = 'block';
                             console.log("updateUI: Détail déjà affiché, zone détail reste visible.");
                        }

                        // 3. Gérer les contrôles SI on a une ossature
                        scenarioControls.style.display = 'flex';
                        scenarioModificationArea.style.display = 'none'; // Ensure mod area is hidden initially when controls are shown
                        approveScenarioBtn.disabled = !hasValidOutline || appState.currentStep === 'outline_approved';
                        modifyScenarioRequestBtn.disabled = !hasValidOutline;
                        regenerateScenarioBtn.disabled = false; // Always allow regeneration if outline exists

                    } else { // <<< ELSE correspondant au IF imbriqué : SI on n'a PAS d'ossature
                        // Pas d'ossature
                        outlineDisplayArea.innerHTML = '<p>Générez d\'abord une ossature depuis l\'onglet "Idée & Options".</p>';
                        chapterDetailArea.innerHTML = ''; // Vide si pas d'ossature
                        chapterDetailArea.style.display = 'none'; // Caché si pas d'ossature
                        scenarioControls.style.display = 'none'; // Cacher contrôles
                        scenarioModificationArea.style.display = 'none'; // Cacher mods
                    } // <<< FIN du ELSE imbriqué

                } else { // <<< ELSE correspondant au IF Principal : SI l'onglet actif N'EST PAS 'scenario'
                      // Cacher les contrôles spécifiques à l'onglet scénario si on quitte l'onglet
                      if(scenarioControls) scenarioControls.style.display = 'none';
                      if(scenarioModificationArea) scenarioModificationArea.style.display = 'none';
                      // Optionnel: Décider si cacher la zone détail en quittant l'onglet scénario
                      // if (chapterDetailArea) chapterDetailArea.style.display = 'none';
                } // <<< FIN du ELSE Principal
                // --- FIN Scenario/Outline Tab Specific Updates ---


                // --- Storyboard Tab Specific Updates ---
                const storyboardChapterSelectorContainer = document.getElementById('storyboard-chapter-selector-container'); // Re-get reference
                const storyboardChapterSelect = document.getElementById('storyboard-chapter-select');
                const generateStoryboardBtn = document.getElementById('generate-storyboard-btn');

                if (appState.activeTab === 'storyboard' && canAccessStoryboard && storyboardChapterSelectorContainer) {
                    storyboardChapterSelectorContainer.style.display = 'flex'; // Show selector container

                    const previouslySelected = storyboardChapterSelect.value; // Store current selection
                    storyboardChapterSelect.innerHTML = '<option value="">-- Sélectionnez --</option>'; // Reset options

                    let hasChaptersWithDetails = false;
                    if (appState.outlineData && appState.outlineData.chapters) {
                        appState.outlineData.chapters.forEach(chapter => {
                            // Only list chapters for which detail exists and is not an error
                            if (appState.chapterDetailData[chapter.chapter] && !appState.chapterDetailData[chapter.chapter].error) {
                                const option = document.createElement('option');
                                option.value = chapter.chapter;
                                option.textContent = `Chapitre ${chapter.chapter}: ${escapeHtml(chapter.title || 'Sans titre')}`;
                                storyboardChapterSelect.appendChild(option);
                                hasChaptersWithDetails = true;
                            }
                        });
                    }

                    if (!hasChaptersWithDetails) { // No chapters with details found
                         storyboardChapterSelect.innerHTML = '<option value="">Générez d\'abord le détail d\'un chapitre</option>';
                         generateStoryboardBtn.disabled = true; // Disable button
                    } else {
                         // Try to restore previous selection if it's still valid
                         if (Array.from(storyboardChapterSelect.options).some(opt => opt.value === previouslySelected)) {
                             storyboardChapterSelect.value = previouslySelected;
                         } else {
                             storyboardChapterSelect.value = ""; // Reset if previous selection is gone
                         }
                         generateStoryboardBtn.disabled = !storyboardChapterSelect.value; // Disable if "-- Sélectionnez --" is chosen
                    }

                     // Manage placeholder text in storyboard output area based on selection
                     if (!storyboardChapterSelect.value && storyboardOutput.innerHTML.includes('Sélectionnez un chapitre')) {
                         // Keep the default placeholder if nothing is selected
                     } else if (storyboardChapterSelect.value && storyboardOutput.innerHTML.includes('Prêt à générer')) {
                         // Keep the "ready" placeholder if a chapter is selected but not generated yet
                     } else if (!storyboardChapterSelect.value && !hasChaptersWithDetails) {
                         storyboardOutput.innerHTML = '<p>Générez d\'abord le détail d\'un chapitre dans l\'onglet Scénario.</p>';
                     } else if (!storyboardChapterSelect.value && hasChaptersWithDetails) {
                         storyboardOutput.innerHTML = '<p>Sélectionnez un chapitre ci-dessus pour générer son storyboard.</p>';
                     }


                } else if (storyboardChapterSelectorContainer) {
                    storyboardChapterSelectorContainer.style.display = 'none'; // Hide selector if not on tab or not ready
                }

                // Clear storyboard output if navigating away? (Optional - might be better to keep it)
                // if(appState.activeTab !== 'storyboard' && storyboardOutput.innerHTML !== '' ) {
                //     storyboardOutput.innerHTML = '';
                // }


                // --- Prompts Tab Specific Updates ---
                if (appState.activeTab === 'prompts') {
                     if (canAccessPrompts) {
                        // TODO: Implement prompt display logic here
                        promptsOutput.innerHTML = '<p>La fonctionnalité d\'affichage des prompts sera ajoutée ici.</p><p>Sélectionnez un chapitre dont le storyboard a été généré.</p>';
                        // Potentially add a chapter selector similar to the storyboard tab
                     } else {
                        promptsOutput.innerHTML = '<p>Générez et approuvez d\'abord le storyboard d\'un chapitre.</p><p>La fonctionnalité de génération de prompts sera ajoutée prochainement.</p>';
                     }
                 }

                console.log("UI Update finished.");
            }

            // --- Backend Call Functions ---

            async function handleGenerateOutline() {
                 appState.lastInputData = { keywords: keywordsInput.value.trim(), genre: genreSelect.value, style: styleSelect.value, tone: toneSelect.value, details: detailsInput.value.trim() };
                 if (!appState.lastInputData.keywords) { alert('Veuillez entrer une idée initiale.'); return; }
                 showLoadingIndicator(true); generateScenarioBtn.disabled = true;
                 appState.outlineData = null; appState.chapterDetailData = {}; appState.storyboardData = {}; // Clear all downstream data
                 appState.activeTab = 'scenario'; updateUI(); // Switch tab immediately
                 outlineDisplayArea.innerHTML = '<p>Envoi de la requête pour l\'ossature...</p>'; chapterDetailArea.style.display = 'none';

                 try {
                     const response = await fetch('/api/generate-story', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }, // Corrected: Removed invalid catch
                        body: JSON.stringify(appState.lastInputData) // Corrected: Removed invalid catch
                    });
                     if (!response.ok) {
                         let errorMsg = `Erreur HTTP: ${response.status} ${response.statusText}`;
                         try {
                             const errorBody = await response.json();
                             let detailsPart = errorBody.details ? ` (${errorBody.details})` : ''; // Corrected: Removed invalid catch
                             errorMsg += ` - ${errorBody.error || 'Erreur serveur.'}${detailsPart}`;
                         } catch (parseError) { console.error("Could not parse error response body:", parseError); }
                         throw new Error(errorMsg);
                     }
                     const result = await response.json();
                     if (result.outline) {
                         appState.outlineData = result.outline;
                         appState.currentStep = 'outline_generated';
                         // Check for parsing errors passed from backend
                         if (result.outline.parsingError) {
                             console.warn("Backend reported parsing error for outline:", result.outline.parsingError);
                         }
                     }
                     else if (result.error) { throw new Error(`Erreur API: ${result.error} ${result.details ? `(${result.details})` : ''}`); }
                     else { throw new Error("Réponse inattendue du serveur (clé 'outline' manquante)."); }
                 } catch (error) {
                     console.error("Error handleGenerateOutline:", error);
                     // Display error in the outline area itself
                     outlineDisplayArea.innerHTML = `<p class="text-danger">Erreur lors de la génération de l'ossature : ${escapeHtml(error.message)}.</p>`;
                     chapterDetailArea.style.display = 'none';
                     appState.outlineData = null; // Ensure outlineData is null on error
                     appState.currentStep = 'idea'; // Revert step
                 } finally {
                     showLoadingIndicator(false); generateScenarioBtn.disabled = false;
                     updateUI(); // Update UI after everything (success or failure)
                 }
            }

            async function handleGenerateChapterDetail(event) {
                 const button = event.target;
                 const chapterNumber = button.dataset.chapterNumber;
                 const chapterTitle = button.dataset.chapterTitle;
                 if (!chapterNumber || !appState.outlineData || !appState.lastInputData) { console.error("Missing data for chapter detail generation"); alert("Erreur interne: Données manquantes pour générer le détail."); return; }
                 const chapterSummary = appState.outlineData.chapters?.find(ch => ch.chapter == chapterNumber)?.summary || '';
                 console.log(`Requesting detail for Chapter ${chapterNumber}`);
                 chapterDetailArea.innerHTML = `<p>Génération du détail pour le Chapitre ${chapterNumber} (${escapeHtml(chapterTitle)})...</p>`; chapterDetailArea.style.display = 'block';
                 button.disabled = true; button.textContent = 'Génération...';

                 const requestData = {
                    ...appState.lastInputData,
                    globalTitle: appState.outlineData.title,
                    totalChapters: appState.outlineData.chapters.length,
                    chapterNumber: parseInt(chapterNumber, 10),
                    chapterTitle: chapterTitle,
                    chapterSummary: chapterSummary
                 };

                 try {
                     const response = await fetch('/api/generate-chapter-detail', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' }, // Corrected: Removed invalid catch
                         body: JSON.stringify(requestData) // Corrected: Removed invalid catch
                     });
                     if (!response.ok) {
                         let errorMsg = `Erreur HTTP: ${response.status} ${response.statusText}`;
                         try {
                             const errorBody = await response.json();
                             let detailsPart = errorBody.details ? ` (${errorBody.details})` : '';
                             errorMsg += ` - ${errorBody.error || 'Erreur serveur.'}${detailsPart}`;
                         } catch (parseError) { console.error("Could not parse error response body:", parseError); }
                         throw new Error(errorMsg);
                     }
                     const result = await response.json();
                     // Store result whether it's success or error from API
                     appState.chapterDetailData[chapterNumber] = result;
                     if (!result.error) { // Only update step if successful
                        appState.currentStep = 'chapter_detail_generated';
                     }
                     displayChapterDetail(chapterNumber, result); // Display result (text or error)
                 } catch (error) {
                     console.error(`Error handleGenerateChapterDetail Chapter ${chapterNumber}:`, error);
                     // Store the network/fetch error
                     appState.chapterDetailData[chapterNumber] = { error: error.message };
                     displayChapterDetail(chapterNumber, { error: error.message }); // Display network error
                 } finally {
                     button.disabled = false; button.textContent = 'Générer Détail';
                     // Update UI to potentially enable storyboard tab/options
                     updateUI();
                 }
            }

            async function handleGenerateStoryboard() {
                const selectedChapterNumber = storyboardChapterSelect.value;
                if (!selectedChapterNumber) { alert("Veuillez sélectionner un chapitre."); return; }

                const chapterDetail = appState.chapterDetailData[selectedChapterNumber];
                if (!chapterDetail || chapterDetail.error || !chapterDetail.scenarioText) {
                    alert(`Le scénario détaillé pour le chapitre ${selectedChapterNumber} n'est pas disponible ou contient une erreur. Veuillez le (re)générer.`);
                    return;
                }

                console.log(`Requesting storyboard for Chapter ${selectedChapterNumber}`);
                showStoryboardLoading(true);
                storyboardOutput.innerHTML = `<p>Génération du storyboard pour le chapitre ${selectedChapterNumber}...</p>`;
                generateStoryboardBtn.disabled = true;
                storyboardChapterSelect.disabled = true; // Disable select during generation

                const requestData = {
                    ...appState.lastInputData, // Includes genre, style, tone etc.
                    globalTitle: appState.outlineData.title,
                    chapterNumber: parseInt(selectedChapterNumber, 10),
                    chapterTitle: appState.outlineData.chapters.find(ch => ch.chapter == selectedChapterNumber)?.title || '',
                    detailedScenarioText: chapterDetail.scenarioText // Send the generated detail
                };

                try {
                     const response = await fetch('/api/generate-storyboard-chapter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }, // Corrected: Removed invalid catch
                        body: JSON.stringify(requestData) // Corrected: Removed invalid catch
                     });
                     if (!response.ok) {
                         let errorMsg = `Erreur HTTP: ${response.status} ${response.statusText}`;
                         try {
                             const errorBody = await response.json();
                             let detailsPart = errorBody.details ? ` (${errorBody.details})` : '';
                             errorMsg += ` - ${errorBody.error || 'Erreur serveur.'}${detailsPart}`;
                         } catch (parseError) { console.error("Could not parse error response body:", parseError); }
                         throw new Error(errorMsg);
                     }
                     const result = await response.json();
                     console.log("Storyboard data received from API:", result);

                     // Store result (could contain storyboard array or error/parsingError)
                     appState.storyboardData[selectedChapterNumber] = result.storyboard;

                     // Check for parsing error reported by backend
                     if (result.storyboard && result.storyboard.parsingError) {
                         console.warn(`Backend reported parsing error for storyboard Chapter ${selectedChapterNumber}:`, result.storyboard.parsingError);
                     }

                     displayStoryboard(selectedChapterNumber, result.storyboard); // Display whatever was received

                     // Update step only if storyboard seems valid (no error and not a parsing error object)
                     if (result.storyboard && !result.storyboard.error && !result.storyboard.parsingError) {
                        appState.currentStep = 'storyboard_generated';
                     }
                } catch(error) {
                     console.error(`Error handleGenerateStoryboard Chapter ${selectedChapterNumber}:`, error);
                     // Store network/fetch error
                     appState.storyboardData[selectedChapterNumber] = { error: error.message };
                     storyboardOutput.innerHTML = `<p class="text-danger">Erreur lors de la génération du storyboard : ${escapeHtml(error.message)}</p>`;
                } finally {
                     showStoryboardLoading(false);
                     generateStoryboardBtn.disabled = false; // Re-enable button
                     storyboardChapterSelect.disabled = false; // Re-enable select
                     updateUI(); // Update UI (e.g., potentially enable prompts tab)
                }
            }

            // --- Event Handlers ---
            function handleApproveOutline() {
                if (!appState.outlineData || appState.outlineData.parsingError) {
                     alert("Impossible d'approuver une ossature invalide ou contenant des erreurs d'analyse.");
                     return;
                }
                // Check if any details have been generated
                const hasAnyDetails = Object.values(appState.chapterDetailData).some(detail => detail && !detail.error);
                if (!hasAnyDetails) {
                    if (!confirm("Aucun détail de chapitre n'a encore été généré. Voulez-vous quand même passer au Storyboard ? Vous devrez générer les détails avant de pouvoir créer un storyboard.")) {
                        return;
                    }
                }

                appState.currentStep = 'outline_approved';
                appState.activeTab = 'storyboard'; // Move user to storyboard tab
                updateUI(); // Update UI to reflect new state and active tab

                // Try to pre-select the first chapter with generated details in the storyboard tab dropdown
                const firstDetailKey = Object.keys(appState.chapterDetailData).find(key => appState.chapterDetailData[key] && !appState.chapterDetailData[key].error);
                if (firstDetailKey && storyboardChapterSelect) {
                    storyboardChapterSelect.value = firstDetailKey;
                    generateStoryboardBtn.disabled = false; // Enable the generate button since a chapter is selected
                     storyboardOutput.innerHTML = '<p>Prêt à générer le storyboard pour ce chapitre.</p>'; // Update placeholder text
                } else if (storyboardChapterSelect && storyboardChapterSelect.options.length > 1) {
                    // If there are options but none were pre-selected (e.g., page reload)
                    storyboardOutput.innerHTML = '<p>Sélectionnez un chapitre ci-dessus pour générer son storyboard.</p>';
                } else {
                     // If no details were generated yet
                     storyboardOutput.innerHTML = '<p>Générez d\'abord le détail d\'un chapitre dans l\'onglet Scénario.</p>';
                 }
            }

            function handleModifyOutlineRequest() {
                scenarioModificationArea.style.display = 'block'; // Show mod area
                scenarioControls.style.display = 'none'; // Hide regular controls
            }

            async function handleSubmitOutlineModification() {
                 const modificationRequest = scenarioModificationInput.value.trim();
                 if (!modificationRequest) {
                     alert("Veuillez décrire les modifications souhaitées.");
                     return;
                 }
                 // TODO: Implement API call for modification
                 console.warn("Modification submission not implemented yet. Request:", modificationRequest);
                 alert("Fonctionnalité de modification non implémentée pour le moment.");
                 // For now, just hide the area and show controls again
                 scenarioModificationInput.value = ''; // Clear input
                 scenarioModificationArea.style.display = 'none';
                 updateUI(); // Restore UI (will show controls again based on state)
            }

            function handleRegenerateOutline() {
                 if (confirm("Êtes-vous sûr de vouloir régénérer l'ossature complète ? Le scénario et le storyboard actuels seront perdus.")) {
                    if(appState.lastInputData) {
                        // Re-use the last input data to generate a new outline
                        handleGenerateOutline();
                    } else {
                        alert("Impossible de régénérer : les données d'entrée initiales n'ont pas été trouvées. Veuillez remplir l'onglet 'Idée & Options'.");
                        appState.activeTab = 'home'; // Send user back to input tab
                        updateUI();
                    }
                 }
            }

            // --- Event Listeners Setup ---
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return; // Don't switch if disabled
                    appState.activeTab = this.getAttribute('data-tab');
                    updateUI(); // Update UI when tab changes
                });
            });
            generateScenarioBtn.addEventListener('click', handleGenerateOutline);
            approveScenarioBtn.addEventListener('click', handleApproveOutline);
            modifyScenarioRequestBtn.addEventListener('click', handleModifyOutlineRequest);
            submitScenarioModificationBtn.addEventListener('click', handleSubmitOutlineModification);
            regenerateScenarioBtn.addEventListener('click', handleRegenerateOutline);

            // Storyboard Listeners
            if(storyboardChapterSelect) {
                storyboardChapterSelect.addEventListener('change', function() {
                    generateStoryboardBtn.disabled = !this.value; // Disable button if "-- Select --" is chosen
                    if(this.value) {
                        // If a chapter is selected, check if storyboard data exists for it
                        if (appState.storyboardData[this.value] && !appState.storyboardData[this.value].error && !appState.storyboardData[this.value].parsingError) {
                            displayStoryboard(this.value, appState.storyboardData[this.value]); // Show existing storyboard
                        } else if (appState.storyboardData[this.value] && (appState.storyboardData[this.value].error || appState.storyboardData[this.value].parsingError)) {
                            displayStoryboard(this.value, appState.storyboardData[this.value]); // Show existing error/parsing error message
                        } else {
                             storyboardOutput.innerHTML = '<p>Prêt à générer le storyboard pour ce chapitre.</p>'; // Reset placeholder if no data/error exists yet
                         }
                    } else {
                        storyboardOutput.innerHTML = '<p>Sélectionnez un chapitre ci-dessus.</p>'; // Placeholder for "-- Select --"
                    }
                });
            }
            if(generateStoryboardBtn) {
                generateStoryboardBtn.addEventListener('click', handleGenerateStoryboard);
            }

             // Session Management Listeners
             document.getElementById('new-session').addEventListener('click', function() {
                 if (confirm('Commencer une nouvelle session ? Tout travail non sauvegardé sera perdu.')) {
                     // Reset state completely
                     appState = { currentStep: 'idea', outlineData: null, chapterDetailData: {}, storyboardData: {}, lastInputData: null, activeTab: 'home' };
                     // Clear inputs
                     keywordsInput.value = '';
                     genreSelect.selectedIndex = 0;
                     styleSelect.selectedIndex = 0;
                     toneSelect.selectedIndex = 0;
                     detailsInput.value = '';
                     // Clear output areas
                     if(outlineDisplayArea) outlineDisplayArea.innerHTML = '<p>Générez une ossature...</p>'; // Reset placeholder
                     if(chapterDetailArea) { chapterDetailArea.innerHTML = ''; chapterDetailArea.style.display = 'none'; }
                     if(scenarioOutput && !outlineDisplayArea) scenarioOutput.innerHTML = '<p>Générez une ossature...</p>'; // Fallback scenario placeholder
                     if(storyboardOutput) storyboardOutput.innerHTML = '<p>Sélectionnez un chapitre...</p>'; // Reset placeholder
                     if(promptsOutput) promptsOutput.innerHTML = '<p>Approuvez...</p>'; // Reset placeholder
                     // Update UI to reflect reset state (tabs, progress, etc.)
                     updateUI();
                 }
             });
            document.getElementById('save-session').addEventListener('click', function() {
                // Capture current input values *before* saving
                appState.lastInputData = { keywords: keywordsInput.value.trim(), genre: genreSelect.value, style: styleSelect.value, tone: toneSelect.value, details: detailsInput.value.trim() };
                const sessionName = prompt('Entrez un nom pour cette session :', `Session_${new Date().toISOString().slice(0,10)}`);
                if (sessionName) {
                    try {
                        // Attempt to stringify (might fail for very large/complex states)
                        const sessionDataString = JSON.stringify(appState);
                        // Basic check for size (localStorage limit is typically 5-10MB)
                        if (sessionDataString.length > 4 * 1024 * 1024) { // Warn over 4MB
                            alert("Attention : La taille de la session est importante, la sauvegarde pourrait échouer ou ralentir le navigateur.");
                        }
                        localStorage.setItem(`bdcreator_session_${sessionName}`, sessionDataString);
                        alert(`Session "${sessionName}" sauvegardée avec succès.`);
                    } catch (e) {
                        alert(`Erreur lors de la sauvegarde de la session : ${e.message}. Vérifiez l'espace disponible dans le stockage local et la console pour plus de détails.`);
                        console.error("Save session error:", e);
                    }
                }
             });
            document.getElementById('load-session').addEventListener('click', function() {
                 const sessions = [];
                 try {
                     for (let i = 0; i < localStorage.length; i++) {
                         const key = localStorage.key(i);
                         if (key && key.startsWith('bdcreator_session_')) {
                             sessions.push(key.replace('bdcreator_session_', ''));
                         }
                     }
                 } catch(e) {
                     alert("Erreur lors de l'accès au stockage local pour lister les sessions.");
                     console.error("LocalStorage access error:", e);
                     return;
                 }

                 if (sessions.length === 0) {
                     alert('Aucune session sauvegardée trouvée.');
                     return;
                 }

                 const sessionName = prompt(`Choisissez une session à charger :\n\n${sessions.join('\n')}`, sessions[0]);

                 if (sessionName && sessions.includes(sessionName)) {
                     try {
                         const sessionString = localStorage.getItem(`bdcreator_session_${sessionName}`); // Corrected: Removed invalid catch
                         if (!sessionString) throw new Error("Les données de la session sont vides ou n'ont pas pu être récupérées.");

                         const loadedState = JSON.parse(sessionString);
                         // Basic validation of loaded state
                         if (!loadedState || typeof loadedState.currentStep === 'undefined' || typeof loadedState.activeTab === 'undefined') {
                            throw new Error("Le format des données de la session est invalide ou corrompu.");
                         }

                         // Restore state
                         appState = loadedState;

                         // Restore input fields from saved lastInputData (if available)
                         const inputsToRestore = appState.lastInputData || {}; // Use empty object if lastInputData wasn't saved
                         keywordsInput.value = inputsToRestore.keywords || '';
                         genreSelect.value = inputsToRestore.genre || 'Fantastique'; // Default fallback
                         styleSelect.value = inputsToRestore.style || 'Manga';       // Default fallback
                         toneSelect.value = inputsToRestore.tone || 'Épique';       // Default fallback
                         detailsInput.value = inputsToRestore.details || '';

                         alert(`Session "${sessionName}" chargée avec succès !`);

                         // Clear dynamic output areas before updating UI to avoid showing stale data briefly
                         if(outlineDisplayArea) outlineDisplayArea.innerHTML = '';
                         if(chapterDetailArea) { chapterDetailArea.innerHTML = ''; chapterDetailArea.style.display = 'none';}
                         if(scenarioOutput && !outlineDisplayArea) scenarioOutput.innerHTML = '';
                         if(storyboardOutput) storyboardOutput.innerHTML = '';
                         if(promptsOutput) promptsOutput.innerHTML = '';

                         // Update the entire UI based on the loaded state
                         updateUI();

                         // Specifically re-render outline/details/storyboard if data exists
                         if(appState.activeTab === 'scenario' && appState.outlineData) {
                             displayOutline(appState.outlineData);
                             // Optionally display the last viewed chapter detail? Needs more state saving.
                         }
                         if(appState.activeTab === 'storyboard' && storyboardChapterSelect.value && appState.storyboardData[storyboardChapterSelect.value]) {
                            displayStoryboard(storyboardChapterSelect.value, appState.storyboardData[storyboardChapterSelect.value]);
                         }


                     } catch (e) {
                         alert(`Erreur lors du chargement de la session "${sessionName}" : ${e.message}. La session est peut-être corrompue.`);
                         console.error("Load session error:", e);
                     }
                 } else if (sessionName) {
                    alert(`Nom de session invalide : "${sessionName}"`);
                 }
             });

            // --- Initial UI Setup ---
            updateUI(); // Set initial state of the UI based on default appState

        });
    </script>

</body>
</html>
