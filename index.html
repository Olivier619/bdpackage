<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD Creator - Créez des bandes dessinées avec l'IA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- Styles CSS (identiques à avant, y compris les styles pour #outline-display-area, #chapter-detail-area, etc.) --- */
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FF9800;
            --dark-color: #333;
            --light-color: #f4f4f4;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --disabled-color: #ccc;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; background-color: #f8f9fa; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header { background-color: var(--primary-color); color: white; padding: 1rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo { font-size: 1.8rem; font-weight: bold; display: flex; align-items: center; margin-bottom: 0.5rem; }
        .logo i { margin-right: 10px; font-size: 2rem; }
        nav ul { display: flex; list-style: none; flex-wrap: wrap; justify-content: center; }
        nav ul li { margin-left: 10px; margin-right: 10px; margin-bottom: 0.5rem; }
        nav ul li a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s; }
        nav ul li a:hover { color: var(--secondary-color); }
        .hero { background: linear-gradient(135deg, var(--primary-color) 0%, #64b5f6 100%); color: white; padding: 4rem 0; text-align: center; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        .hero p { font-size: 1.2rem; max-width: 800px; margin: 0 auto 2rem; }
        .btn { display: inline-block; background: var(--secondary-color); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; transition: background 0.3s, transform 0.2s; text-decoration: none; font-weight: 500; }
        .btn:hover { background: #e68a00; transform: translateY(-2px); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        .btn-primary { background: var(--primary-color); }
        .btn-primary:hover { background: #0b7dda; }
        .btn-primary:disabled { background-color: #a0cff8; }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-info { background-color: #17a2b8; color: white; } /* Style pour bouton Copier Dialogue */
        .btn-info:hover { background-color: #138496; }
        .btn-info:disabled { background-color: #ccc; }
        .features { padding: 4rem 0; background-color: white; }
        .section-title { text-align: center; margin-bottom: 3rem; }
        .section-title h2 { font-size: 2rem; color: var(--dark-color); margin-bottom: 1rem; }
        .section-title p { color: #666; max-width: 800px; margin: 0 auto; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .feature-card { background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; text-align: center; }
        .feature-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .feature-card i { font-size: 3rem; color: var(--primary-color); margin-bottom: 1.5rem; }
        .feature-card h3 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--dark-color); }
        .feature-card p { color: #666; }
        .how-it-works { padding: 4rem 0; background-color: #f8f9fa; }
        .steps { display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem; margin-top: 3rem; }
        .step { flex: 1; min-width: 250px; max-width: 350px; text-align: center; position: relative; }
        .step-number { width: 50px; height: 50px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; margin: 0 auto 1.5rem; }
        .step h3 { margin-bottom: 1rem; color: var(--dark-color); }
        .step p { color: #666; }
        .app { padding: 4rem 0; background-color: white; }
        .tabs { display: flex; justify-content: center; margin-bottom: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 1rem; flex-wrap: wrap; }
        .tab-btn { background: none; border: none; padding: 0.8rem 1.5rem; margin: 0 0.5rem 0.5rem 0.5rem; font-size: 1rem; cursor: pointer; border-radius: 5px 5px 0 0; transition: background 0.3s, color 0.3s; font-weight: 500; }
        .tab-btn.active { background-color: var(--primary-color); color: white; }
        .tab-content { display: none; padding: 2rem; background: white; border-radius: 0 0 8px 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); min-height: 200px; }
        .tab-content.active { display: block; }
        .input-group { margin-bottom: 1.5rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; font-family: inherit; }
        .input-group textarea { min-height: 80px; resize: vertical; }
        footer { background-color: var(--dark-color); color: white; padding: 2rem 0; text-align: center; margin-top: 4rem; }
        footer p { margin-bottom: 1rem; }
        .social-links { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
        .social-links a { color: white; font-size: 1.5rem; transition: color 0.3s; }
        .social-links a:hover { color: var(--secondary-color); }
        .footer-links { display: flex; justify-content: center; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1rem; }
        .footer-links a { color: #ddd; text-decoration: none; transition: color 0.3s; }
        .footer-links a:hover { color: var(--secondary-color); }
        /* Application Specific Styles */
        .scenario-section, .scenario-chapter, .storyboard-page, .prompt-item { margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border-left: 4px solid var(--primary-color); }
        #outline-display-area { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        #outline-display-area h4 { margin-bottom: 15px; color: var(--dark-color); }
        #outline-display-area ul { list-style: none; padding-left: 0; }
        #outline-display-area li { padding: 10px; border: 1px solid #e0e0e0; margin-bottom: 10px; border-radius: 5px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        #outline-display-area li div { flex-grow: 1; margin-right: 10px; margin-bottom: 5px; }
        #outline-display-area li button { flex-shrink: 0; }
        #chapter-detail-area { margin-top: 20px; padding: 15px; background-color: #f0f8ff; border-radius: 5px; border: 1px solid #d1e7fd; display: none; }
        #chapter-detail-area h4 { color: var(--primary-color); margin-bottom: 10px; }
        #chapter-detail-area pre { white-space: pre-wrap; background-color: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px; max-height: 500px; overflow-y: auto; margin-top: 10px; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; font-size: 0.9em; }
        .storyboard-page { margin-bottom: 20px; padding: 15px; background-color: #fffaf0; border-radius: 8px; border-left: 4px solid var(--secondary-color); }
        .storyboard-page h5 { color: var(--secondary-color); margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .storyboard-panel-display { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #fafafa; }
        .storyboard-panel-display h6 { color: var(--dark-color); margin-bottom: 8px; }
        .storyboard-panel-details p { margin-bottom: 5px; font-size: 0.95em; }
        .storyboard-panel-details p strong { color: var(--dark-color); }
        /* .storyboard-visual-placeholder removed */
        .prompt-item { border-left-color: var(--success-color); }
        .prompt-item h6 { color: var(--success-color); margin-bottom: 8px; }
        .prompt-item pre { background-color: #333; color: white; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 10px; margin-bottom: 10px; white-space: pre-wrap; word-break: break-all; }
        .prompt-item button { margin-right: 5px; margin-top: 5px; } /* Espacement boutons copier */
        .prompt-item button.copy-prompt-btn { background-color: var(--secondary-color); border: none; color: white; }
        .prompt-item button.copy-prompt-btn:hover { background-color: #e68a00; }
        .prompt-item button.copy-prompt-btn:disabled { background-color: #ccc; }
        .prompt-item .dialogue-display { margin-top: 10px; padding: 8px; background-color: #e9ecef; border-radius: 4px; font-size: 0.9em; border: 1px solid #dee2e6; }
        .prompt-item .dialogue-display strong { color: var(--dark-color); }
        .session-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .session-controls button { flex: 1 1 auto; min-width: 150px; }
        #loading-indicator, #storyboard-loading-indicator, #prompts-loading-indicator { display: none; text-align: center; margin: 20px 0; padding: 15px; background-color: rgba(255, 255, 255, 0.8); border-radius: 8px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .app-controls { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; display: none; gap: 10px; flex-wrap: wrap; }
        .app-controls button { margin-right: 10px; margin-bottom: 10px; }
        .modification-area { margin-top: 1rem; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa; display: none; }
        .modification-area label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modification-area textarea { width: 100%; min-height: 80px; margin-bottom: 0.5rem; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .tab-btn.disabled { color: var(--disabled-color); cursor: not-allowed; background: #eee; }
        .chapter-selector { margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .chapter-selector label { margin-bottom: 0; font-weight: 500; white-space: nowrap; }
        .chapter-selector select { flex-grow: 1; max-width: 400px; padding: 0.6rem; }
        .chapter-selector button { flex-shrink: 0; }
        .progress-indicator { display: flex; justify-content: space-around; margin-bottom: 2rem; padding: 1rem; background-color: #e9ecef; border-radius: 5px; flex-wrap: wrap; gap: 10px; }
        .progress-step { text-align: center; color: #adb5bd; flex: 1; min-width: 80px; }
        .progress-step.active { color: var(--primary-color); font-weight: bold; }
        .progress-step.completed { color: var(--success-color); font-weight: bold; }
        .progress-step .icon { display: block; font-size: 1.5rem; margin-bottom: 0.5rem; }
        .input-group-inline { display: flex; gap: 20px; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .input-group-inline .input-group { flex: 1; min-width: 200px; margin-bottom: 0; }
        .text-danger { color: var(--danger-color); font-weight: bold; }
        /* Media Queries */
        @media (max-width: 768px) {
             header .container { flex-direction: column; text-align: center; }
             nav ul { margin-top: 1rem; justify-content: center; }
             nav ul li { margin-left: 10px; margin-right: 10px; }
            .hero h1 { font-size: 2rem; } .hero p { font-size: 1rem; }
            .features-grid { grid-template-columns: 1fr; }
            .steps { flex-direction: column; align-items: center; }
            .step { margin-bottom: 2rem; max-width: 90%; }
            .tabs { justify-content: flex-start; }
            .tab-btn { flex-grow: 1; margin-left: 0; margin-right: 0; }
            .session-controls { justify-content: center; }
            .input-group-inline { flex-direction: column; gap: 1rem; }
            .chapter-selector { flex-direction: column; align-items: flex-start; gap: 5px;}
            .chapter-selector select { max-width: 100%; }
             .chapter-selector button { width: 100%; margin-top: 5px; }
            .progress-indicator { gap: 5px; } .progress-step .icon { font-size: 1.2rem; }
            #outline-display-area li { flex-direction: column; align-items: flex-start;}
            #outline-display-area li div { margin-right: 0; }
            #outline-display-area li button { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-book-open"></i>
                <span>BD Creator</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#features">Fonctionnalités</a></li>
                    <li><a href="#how-it-works">Comment ça marche</a></li>
                    <li><a href="#app">Créer ma BD</a></li>
                    <li><a href="#" id="login-btn">Connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <h1>Créez des bandes dessinées incroyables avec l'IA</h1>
            <p>Transformez vos idées en scénarios complets, storyboards détaillés et prompts optimisés en quelques clics grâce à l'IA côté serveur.</p>
            <a href="#app" class="btn">Commencer maintenant</a>
        </div>
    </section>

    <section class="features" id="features">
         <div class="container">
             <div class="section-title"><h2>Fonctionnalités</h2><p>Découvrez ce que BD Creator peut faire pour vous.</p></div>
             <div class="features-grid">
                 <div class="feature-card"><i class="fas fa-lightbulb"></i><h3>Idée Initiale & Options</h3><p>Démarrez avec une simple idée, phrase ou mots-clés. Choisissez le genre, le style visuel et le ton pour guider l'IA.</p></div>
                 <div class="feature-card"><i class="fas fa-server"></i><h3>Génération Scénario via API</h3><p>Notre IA transforme votre idée en ossature (titre, chapitres, résumés), puis génère le détail de chaque chapitre (format texte).</p></div>
                 <div class="feature-card"><i class="fas fa-pencil-alt"></i><h3>Storyboard Assisté</h3><p>Visualisez votre histoire avec des suggestions de cadrage, composition et style pour chaque case, basées sur le scénario détaillé.</p></div>
                 <div class="feature-card"><i class="fas fa-image"></i><h3>Prompts Optimisés</h3><p>Générez des prompts en anglais prêts pour Midjourney, basés sur le storyboard, le style visuel et vos détails de personnages/lieux.</p></div>
                 <div class="feature-card"><i class="fas fa-comments"></i><h3>Extraction Dialogue</h3><p>Affiche automatiquement les dialogues sous les prompts correspondants pour faciliter la référence et la copie.</p></div>
                 <div class="feature-card"><i class="fas fa-save"></i><h3>Sauvegarde de Sessions</h3><p>Ne perdez jamais votre travail. Sauvegardez et chargez vos sessions de création directement dans votre navigateur.</p></div>
             </div>
         </div>
    </section>

    <section class="how-it-works" id="how-it-works">
         <div class="container">
             <div class="section-title"><h2>Comment ça marche</h2><p>Un processus simple en 4+1 étapes pour donner vie à vos histoires.</p></div>
             <div class="steps">
                 <div class="step"><div class="step-number">1</div><h3>Décrivez votre idée</h3><p>Fournissez le concept, les options clés (genre, style, ton) et les détails sur vos personnages/lieux.</p></div>
                 <div class="step"><div class="step-number">2</div><h3>Générez & Validez</h3><p>Obtenez l'ossature, puis générez le détail (texte brut) des chapitres. Ajoutez/Modifiez les détails si l'IA introduit de nouveaux éléments.</p></div>
                 <div class="step"><div class="step-number">3</div><h3>Générez le Storyboard</h3><p>Pour chaque chapitre détaillé, obtenez des suggestions visuelles (plan, angle...) pour chaque case.</p></div>
                 <div class="step"><div class="step-number">4</div><h3>Obtenez les Prompts</h3><p>Recevez les prompts optimisés (anglais), tenant compte de vos détails mis à jour, pour chaque case.</p></div>
                  <div class="step"><div class="step-number">5</div><h3>Copiez & Créez</h3><p>Copiez facilement les prompts pour vos outils d'IA image, et copiez les dialogues associés pour le lettrage.</p></div>
            </div>
         </div>
    </section>

    <section class="app" id="app">
        <div class="container">
            <div class="section-title">
                <h2>Créez votre BD maintenant</h2>
                <p>Utilisez notre application pour transformer vos idées en bandes dessinées complètes.</p>
            </div>

            <div class="session-controls">
                <button class="btn" id="new-session">Nouvelle session</button>
                <button class="btn" id="save-session">Sauvegarder la session</button>
                <button class="btn" id="load-session">Charger une session</button>
            </div>

            <!-- Progress Indicator -->
             <div class="progress-indicator">
                <div class="progress-step active" id="step-idea"><span class="icon"><i class="fas fa-lightbulb"></i></span>Idée</div>
                <div class="progress-step" id="step-scenario"><span class="icon"><i class="fas fa-file-alt"></i></span>Scénario</div>
                <div class="progress-step" id="step-storyboard"><span class="icon"><i class="fas fa-border-all"></i></span>Storyboard</div>
                <div class="progress-step" id="step-prompts"><span class="icon"><i class="fas fa-magic"></i></span>Prompts</div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="home">1. Idée & Options</button>
                <button class="tab-btn disabled" data-tab="scenario">2. Scénario</button>
                <button class="tab-btn disabled" data-tab="storyboard">3. Storyboard</button>
                <button class="tab-btn disabled" data-tab="prompts">4. Prompts</button>
            </div>

            <!-- Tab 1: Home / Idea Input -->
            <div class="tab-content active" id="home-content">
                <h3>Entrez les détails de votre projet</h3>
                <p>Commencez par décrire votre idée et choisissez les options pour guider l'IA. **Important :** Décrivez bien vos personnages/lieux principaux dans "Détails Optionnels" pour assurer la cohérence visuelle dans les prompts.</p>
                <div class="input-group">
                    <label for="keywords">Idée initiale (mots-clés, phrase, ou courte histoire)</label>
                    <textarea id="keywords" placeholder="Ex: Aventure spatiale avec des chats pirates cherchant une planète de thon légendaire." rows="3"></textarea>
                </div>
                <div class="input-group-inline">
                     <div class="input-group"><label for="genre">Genre</label><select id="genre"><option value="Fantastique">Fantastique</option><option value="Science-Fiction">Science-Fiction</option><option value="Policier">Policier</option><option value="Humour">Humour</option><option value="Drame">Drame</option><option value="Aventure">Aventure</option><option value="Slice of Life">Slice of Life</option><option value="Horreur">Horreur</option><option value="Historique">Historique</option><option value="Western">Western</option></select></div>
                     <div class="input-group"><label for="style">Style Visuel Cible</label><select id="style"><option value="Manga">Manga</option><option value="Franco-Belge">Franco-Belge (Ligne Claire)</option><option value="Comics US">Comics US (Super-héros)</option><option value="Réaliste">Réaliste / Peinture Numérique</option><option value="Cartoon">Cartoon / Animation</option><option value="Aquarelle">Aquarelle</option><option value="Pixel Art">Pixel Art</option><option value="Noir et Blanc">Noir et Blanc (Ink)</option></select></div>
                     <div class="input-group"><label for="tone">Ton</label><select id="tone"><option value="Épique">Épique</option><option value="Sérieux">Sérieux</option><option value="Léger / Humoristique">Léger / Humoristique</option><option value="Sombre / Mature">Sombre / Mature</option><option value="Mystérieux">Mystérieux</option><option value="Poétique">Poétique</option><option value="Satirique">Satirique</option><option value="Action">Action</option></select></div>
                </div>
                 <div class="input-group">
                    <label for="details">Détails Optionnels (Personnages principaux, Univers, Éléments clés)</label>
                    <textarea id="details" placeholder="Ex:
- Capitaine Moustache: Chat roux borgne, grand, corpulent, air bourru mais cœur d'or. Veste de pirate usée, cache-œil noir.
- Patte-de-Velours: Chatte noire agile, fine, yeux verts vifs. Bandana rouge. Intelligente, rapide.
- Vaisseau Le Sardine Volante: Vaisseau rouillé en forme de poisson, réacteurs bricolés.
- Planète Catlantic: Jungle luxuriante, cascades de lait, arbres à souris." rows="6"></textarea>
                </div>
                <button class="btn btn-primary" id="generate-scenario">Générer l'Ossature</button>
                <div id="loading-indicator"><div class="spinner"></div><p>Génération en cours via l'API...</p></div>
            </div>

            <!-- Tab 2: Scenario -->
            <div class="tab-content" id="scenario-content">
                <h3>Votre Ossature / Scénario</h3>
                <p>Si l'IA introduit de nouveaux personnages/lieux importants, pensez à mettre à jour le champ "Détails Optionnels" dans l'onglet 1 avant de générer les prompts des chapitres suivants.</p>
                <div id="scenario-output">
                    <div id="outline-display-area"><p>L'ossature de votre scénario (titre, chapitres, résumés) s'affichera ici après la génération initiale.</p></div>
                    <hr style="margin: 20px 0;">
                    <div id="chapter-detail-area"><p>Le contenu détaillé du chapitre sélectionné s'affichera ici après sa génération.</p></div>
                </div>

                <div style="text-align: right; margin-top: 15px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" id="copy-all-details-btn" disabled>
                        <i class="fas fa-copy"></i> Copier Tous les Détails Générés
                    </button>
                </div>

                <div class="app-controls" id="scenario-controls">
                    <button class="btn btn-success" id="approve-scenario">Passer au Storyboard</button>
                    <button class="btn btn-primary" id="modify-scenario-request">Demander Modifications (Ossature)</button>
                    <button class="btn btn-danger" id="regenerate-scenario">Régénérer Ossature</button>
                </div>
                <div class="modification-area" id="scenario-modification-area">
                    <label for="scenario-modification-input">Décrivez les modifications souhaitées pour l'ossature :</label>
                    <textarea id="scenario-modification-input"></textarea>
                    <button class="btn btn-primary" id="submit-scenario-modification">Soumettre Modification</button>
                </div>
            </div>

            <!-- Tab 3: Storyboard -->
             <div class="tab-content" id="storyboard-content">
                 <h3>Votre Storyboard</h3>
                 <div class="chapter-selector" id="storyboard-chapter-selector-container" style="display: none;">
                     <label for="storyboard-chapter-select">Choisir le chapitre :</label>
                     <select id="storyboard-chapter-select"><option value="">-- Sélectionnez --</option></select>
                     <button class="btn btn-primary btn-sm" id="generate-storyboard-btn" disabled>Générer Storyboard Chapitre</button>
                 </div>
                 <div id="storyboard-loading-indicator" style="display: none; margin-top: 15px;">
                     <div class="spinner"></div>
                     <p>Génération du storyboard pour ce chapitre...</p>
                 </div>
                 <div id="storyboard-output">
                     <p>Sélectionnez un chapitre dont le détail a été généré, puis cliquez sur "Générer Storyboard Chapitre".</p>
                 </div>
             </div>


             <!-- Tab 4: Prompts -->
             <div class="tab-content" id="prompts-content">
                 <h3>Vos Prompts Midjourney & Dialogues</h3>
                 <!-- Sélecteur de Chapitre pour Prompts -->
                 <div class="chapter-selector" id="prompts-chapter-selector-container" style="display: none;">
                     <label for="prompts-chapter-select">Choisir le chapitre :</label>
                     <select id="prompts-chapter-select"><option value="">-- Sélectionnez --</option></select>
                     <button class="btn btn-primary btn-sm" id="generate-prompts-btn" disabled>Générer Prompts Chapitre</button>
                 </div>
                 <!-- Indicateur de Chargement pour Prompts -->
                 <div id="prompts-loading-indicator" style="display: none; margin-top: 15px;">
                     <div class="spinner" style="border-left-color: var(--success-color);"></div> <!-- Spinner vert -->
                     <p>Génération des prompts pour ce chapitre...</p>
                 </div>
                 <!-- Zone d'Affichage des Prompts -->
                 <div id="prompts-output" style="margin-top: 20px;">
                     <p>Sélectionnez un chapitre dont le storyboard a été généré, puis cliquez sur "Générer Prompts Chapitre". Les dialogues associés s'afficheront automatiquement.</p>
                     <!-- Les prompts générés et les dialogues s'afficheront ici -->
                 </div>
             </div>
        </div>
    </section>

    <footer>
         <div class="container">
            <p>© 2025 BD Creator. Tous droits réservés.</p>
            <div class="social-links">
                <a href="#" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
            </div>
            <div class="footer-links">
                <a href="#">Politique de confidentialité</a>
                <a href="#">Conditions d'utilisation</a>
                <a href="#">Contact</a>
            </div>
        </div>
    </footer>

    <!-- Inline script includes all necessary JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const loadingIndicator = document.getElementById('loading-indicator');
            const keywordsInput = document.getElementById('keywords');
            const genreSelect = document.getElementById('genre');
            const styleSelect = document.getElementById('style');
            const toneSelect = document.getElementById('tone');
            const detailsInput = document.getElementById('details');
            const generateScenarioBtn = document.getElementById('generate-scenario');

            // Scenario/Outline Tab Elements
            const scenarioOutput = document.getElementById('scenario-output');
            const outlineDisplayArea = document.getElementById('outline-display-area');
            const chapterDetailArea = document.getElementById('chapter-detail-area');
            const scenarioControls = document.getElementById('scenario-controls');
            const approveScenarioBtn = document.getElementById('approve-scenario');
            const modifyScenarioRequestBtn = document.getElementById('modify-scenario-request');
            const regenerateScenarioBtn = document.getElementById('regenerate-scenario');
            const scenarioModificationArea = document.getElementById('scenario-modification-area');
            const scenarioModificationInput = document.getElementById('scenario-modification-input');
            const submitScenarioModificationBtn = document.getElementById('submit-scenario-modification');
            const copyAllDetailsBtn = document.getElementById('copy-all-details-btn'); // Bouton copier tout

            // Storyboard Tab Elements
            const storyboardChapterSelectorContainer = document.getElementById('storyboard-chapter-selector-container');
            const storyboardChapterSelect = document.getElementById('storyboard-chapter-select');
            const generateStoryboardBtn = document.getElementById('generate-storyboard-btn');
            const storyboardLoadingIndicator = document.getElementById('storyboard-loading-indicator');
            const storyboardOutput = document.getElementById('storyboard-output');

            // Prompts Tab Elements
            const promptsChapterSelectorContainer = document.getElementById('prompts-chapter-selector-container');
            const promptsChapterSelect = document.getElementById('prompts-chapter-select');
            const generatePromptsBtn = document.getElementById('generate-prompts-btn');
            const promptsLoadingIndicator = document.getElementById('prompts-loading-indicator');
            const promptsOutput = document.getElementById('prompts-output');

            // Progress Indicator Steps
            const progressSteps = { idea: document.getElementById('step-idea'), scenario: document.getElementById('step-scenario'), storyboard: document.getElementById('step-storyboard'), prompts: document.getElementById('step-prompts'), };
            // Tab Buttons Map
            const tabs = { home: document.querySelector('[data-tab="home"]'), scenario: document.querySelector('[data-tab="scenario"]'), storyboard: document.querySelector('[data-tab="storyboard"]'), prompts: document.querySelector('[data-tab="prompts"]'), };

            // --- Application State ---
             let appState = {
                 currentStep: 'idea',
                 outlineData: null,
                 chapterDetailData: {}, // Stocke réponse brute detail { scenarioText: "..." } ou { error: "..." }
                 chapterStructuredDetailData: {}, // Stocke résultat parsing client [{page, panel, desc, dialogues, thoughts}, ...] ou { parsingError, rawText }
                 storyboardData: {},
                 promptData: {},
                 lastInputData: null,
                 activeTab: 'home'
             };

            // --- Helper Functions ---
            function escapeHtml(unsafe) { if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, """).replace(/'/g, "'"); }
            function showLoadingIndicator(show) { if (loadingIndicator) loadingIndicator.style.display = show ? 'block' : 'none'; }
            function showStoryboardLoading(show) { if (storyboardLoadingIndicator) storyboardLoadingIndicator.style.display = show ? 'block' : 'none'; }
            function showPromptsLoading(show) { if (promptsLoadingIndicator) promptsLoadingIndicator.style.display = show ? 'block' : 'none'; }

            // *** FONCTION pour parser le texte brut du scénario détaillé ***
            function parseScenarioText(scenarioText) {
                console.log("Parsing scenario text...");
                const panelsData = []; const lines = scenarioText.replace(/\r\n/g, '\n').split('\n');
                let currentPage = null; let currentPanel = null; let currentDescription = ""; let currentDialogues = []; let currentThoughts = [];
                const pageRegex = /^\s*PAGE\s+(\d+)\s*$/i; const panelRegex = /^\s*(?:Case|CASE)\s+(\d+)\s*:(.*)/i; const dialogueRegex = /^\s*([A-Z][A-Z0-9_ -]+)\s*:\s*"(.*)"\s*$/; const thoughtRegex = /^\s*\((.*)\)\s*$/;
                function saveCurrentPanel() { if (currentPage !== null && currentPanel !== null) { currentDescription = currentDescription.split('\n').map(line => line.trim()).filter(line => line.length > 0).join('\n'); panelsData.push({ page: currentPage, panel: currentPanel, description: currentDescription, dialogues: [...currentDialogues], thoughts: [...currentThoughts] }); } currentDescription = ""; currentDialogues = []; currentThoughts = []; }
                for (const line of lines) { const pageMatch = line.match(pageRegex); const panelMatch = line.match(panelRegex); const dialogueMatch = line.match(dialogueRegex); const thoughtMatch = line.match(thoughtRegex); if (pageMatch) { saveCurrentPanel(); currentPage = parseInt(pageMatch[1], 10); currentPanel = null; console.log(`---> Found Page ${currentPage}`); continue; } if (panelMatch) { saveCurrentPanel(); currentPanel = parseInt(panelMatch[1], 10); currentDescription = (panelMatch[2] || "").trim() + "\n"; console.log(`---> Found Panel ${currentPanel} on Page ${currentPage}`); continue; } if (currentPage !== null && currentPanel !== null) { if (dialogueMatch) { currentDialogues.push({ character: dialogueMatch[1].trim().toUpperCase(), line: dialogueMatch[2] }); } else if (thoughtMatch) { currentThoughts.push(thoughtMatch[1]); } else if (line.trim().length > 0 && !line.startsWith('---') && !line.startsWith('===') ) { currentDescription += line + "\n"; } } } saveCurrentPanel(); console.log(`Finished parsing. Found ${panelsData.length} panels.`); return panelsData;
            }

            // --- Display Functions ---
            function displayOutline(outlineData) { outlineDisplayArea.innerHTML = ''; if (!outlineData) { outlineDisplayArea.innerHTML = '<p>Aucune ossature.</p>'; return; } if (outlineData.parsingError) { console.warn("Outline parsing failed:", outlineData.parsingError); outlineDisplayArea.innerHTML = `<h4>Erreur Analyse Ossature</h4><p>Format IA non reconnu. Texte brut :</p><pre style="max-height:300px; overflow-y:auto; background:#eee; padding:10px;">${escapeHtml(outlineData.rawText||'N/A')}</pre>`; return; } const title = outlineData.title || "?"; outlineDisplayArea.innerHTML = `<h4 style="margin-bottom:15px;">Titre Global : ${escapeHtml(title)}</h4>`; const chapters = outlineData.chapters; if (Array.isArray(chapters) && chapters.length > 0) { const ul = document.createElement('ul'); chapters.forEach(ch => { const li = document.createElement('li'); const info = document.createElement('div'); info.innerHTML = `<b>Chapitre ${ch.chapter}: ${escapeHtml(ch.title||'')}</b><br><small><i>${escapeHtml(ch.summary||'Pas de résumé.')}</i></small>`; li.appendChild(info); const btn = document.createElement('button'); btn.textContent = `Générer Détail`; btn.classList.add('btn','btn-sm','btn-secondary'); btn.dataset.chapterNumber = ch.chapter; btn.dataset.chapterTitle = ch.title||''; btn.onclick = handleGenerateChapterDetail; li.appendChild(btn); ul.appendChild(li); }); outlineDisplayArea.appendChild(ul); } else { outlineDisplayArea.innerHTML += '<p>Aucun chapitre trouvé.</p>'; } }
            function displayChapterDetail(chapterNumber, detailData) { console.log(`Display detail C${chapterNumber}`); const area = chapterDetailArea; if (!area) { console.error("!#chapter-detail-area"); return; } area.innerHTML = ''; area.style.display = 'block'; try { const h4 = document.createElement('h4'); h4.textContent = `Détail Chapitre ${chapterNumber}`; area.appendChild(h4); } catch (e) { console.error("H4 err:", e); } if (detailData?.scenarioText) { try { const pre = document.createElement('pre'); pre.textContent = detailData.scenarioText; area.appendChild(pre); } catch (e) { console.error("<pre> err:", e); } } else if (detailData?.error) { try { const p = document.createElement('p'); p.classList.add('text-danger'); p.textContent = `Erreur: ${detailData.error} ${detailData.details?`(${detailData.details})`:''}`; area.appendChild(p); if (detailData.rawText) { const pre = document.createElement('pre'); pre.style.cssText = 'margin-top:10px; border:1px dashed orange; padding:5px; max-height:300px; overflow:auto;'; pre.textContent = `--- Texte Brut Reçu ---\n${detailData.rawText}`; area.appendChild(pre); } } catch (e) { console.error("Err <p> err:", e); } } else { try { const p = document.createElement('p'); p.style.color = 'orange'; p.textContent = `Données détail inattendues.`; area.appendChild(p); } catch (e) { console.error("Err <p> unexpected:", e); } } console.log("End displayDetail."); }
            function displayStoryboard(chapterNumber, storyboardData) { storyboardOutput.innerHTML = ''; if (!storyboardData) { storyboardOutput.innerHTML = `<p class="text-danger">Aucune donnée storyboard C${chapterNumber}.</p>`; return; } if (storyboardData.parsingError) { storyboardOutput.innerHTML = `<h4>Erreur Analyse Storyboard C${chapterNumber}</h4><p>Format IA non reconnu. Texte brut:</p><pre style="max-height:400px; overflow-y:auto; background:#eee; padding:10px;">${escapeHtml(storyboardData.rawText||'N/A')}</pre>`; return; } if (Array.isArray(storyboardData) && storyboardData.length > 0) { let currentPage = -1; let pageContainer = null; storyboardData.forEach(pData => { if (pData.page !== currentPage) { currentPage = pData.page; pageContainer = document.createElement('div'); pageContainer.classList.add('storyboard-page'); pageContainer.innerHTML = `<h5>Page ${currentPage}</h5>`; storyboardOutput.appendChild(pageContainer); } if(pageContainer) { const panel = document.createElement('div'); panel.classList.add('storyboard-panel-display'); panel.innerHTML = `<h6>Case ${pData.panel}</h6><div class="storyboard-panel-details"><p><strong>Description:</strong> ${escapeHtml(pData.description||'N/A')}</p><p><strong>Type Plan:</strong> ${escapeHtml(pData.shotType||'N/A')}</p><p><strong>Angle:</strong> ${escapeHtml(pData.angle||'N/A')}</p>${pData.notes?`<p><i>Notes: ${escapeHtml(pData.notes)}</i></p>`:''}</div>`; pageContainer.appendChild(panel); } }); } else if (Array.isArray(storyboardData) && storyboardData.length === 0) { storyboardOutput.innerHTML = `<p>Aucune case storyboard extraite C${chapterNumber}.</p>`; } else { storyboardOutput.innerHTML = `<h4>Storyboard C${chapterNumber} (Format Inconnu)</h4><pre>${escapeHtml(JSON.stringify(storyboardData, null, 2))}</pre>`; } }
            function displayPrompts(chapterNumber, promptData) {
                 promptsOutput.innerHTML = ''; if (!promptData) { promptsOutput.innerHTML = `<p class="text-danger">Aucune donnée prompt C${chapterNumber}.</p>`; return; } if (promptData.parsingError) { promptsOutput.innerHTML = `<h4>Erreur Analyse Prompts C${chapterNumber}</h4><p>Format IA non reconnu (attendait "PAGE X - CASE Y PROMPT: ..."). Texte brut:</p><pre style="max-height:400px; overflow-y:auto; background:#eee; padding:10px;">${escapeHtml(promptData.rawText||'N/A')}</pre>`; return; } if (promptData.error) { promptsOutput.innerHTML = `<p class="text-danger">Erreur prompts C${chapterNumber}: ${escapeHtml(promptData.error)} ${promptData.details?`(${escapeHtml(promptData.details)})`:''}</p>`; return; }
                 if (Array.isArray(promptData) && promptData.length > 0) {
                     const structuredScenario = appState.chapterStructuredDetailData?.[chapterNumber]; let scenarioParsingFailed = false;
                     if (!structuredScenario || !Array.isArray(structuredScenario)) { console.warn(`Données scénario structurées C${chapterNumber} non trouvées/invalides.`); if (structuredScenario?.parsingError) { scenarioParsingFailed = true; /* Optionnel: Afficher erreur globale ici */ } }
                     promptData.forEach(item => { if (item.page === undefined || item.panel === undefined) return; const promptEl = document.createElement('div'); promptEl.classList.add('prompt-item'); const promptTxt = item.prompt || 'Prompt vide.'; let dialogueHtml = ''; let dialogueTxt = '';
                         if (!scenarioParsingFailed && structuredScenario) { const panelDetail = structuredScenario.find(p => p.page === item.page && p.panel === item.panel); if (panelDetail?.dialogues?.length > 0) { dialogueHtml += `<div class="dialogue-display"><strong>Dialogues:</strong><br>`; panelDetail.dialogues.forEach(dlg => { const line = `${dlg.character}: "${dlg.line}"`; dialogueHtml += `${escapeHtml(line)}<br>`; dialogueTxt += line + "\n"; }); dialogueHtml += `</div>`; dialogueTxt = dialogueTxt.trim(); } }
                         promptEl.innerHTML = `<h6>Page ${item.page} - Case ${item.panel} Prompt:</h6><pre>${escapeHtml(promptTxt)}</pre><button class="btn btn-sm btn-secondary copy-prompt-btn" data-prompt="${escapeHtml(promptTxt)}"><i class="fas fa-copy"></i> Copier Prompt</button>${dialogueHtml}${dialogueTxt?`<button class="btn btn-sm btn-info copy-dialogue-btn" data-dialogue="${escapeHtml(dialogueTxt)}"><i class="fas fa-comments"></i> Copier Dialogue</button>`:''}`;
                         promptsOutput.appendChild(promptEl);
                     }); addCopyButtonListeners();
                 } else if (Array.isArray(promptData) && promptData.length === 0) { promptsOutput.innerHTML = `<p>Aucun prompt extrait C${chapterNumber}.</p>`; }
                 else { promptsOutput.innerHTML = `<h4>Prompts C${chapterNumber} (Format Inconnu)</h4><pre>${escapeHtml(JSON.stringify(promptData, null, 2))}</pre>`; }
            }
            function addCopyButtonListeners() { promptsOutput.querySelectorAll('.copy-prompt-btn').forEach(btn => { btn.replaceWith(btn.cloneNode(true)); }); promptsOutput.querySelectorAll('.copy-prompt-btn').forEach(btn => { btn.addEventListener('click', handleCopyPrompt); }); promptsOutput.querySelectorAll('.copy-dialogue-btn').forEach(btn => { btn.replaceWith(btn.cloneNode(true)); }); promptsOutput.querySelectorAll('.copy-dialogue-btn').forEach(btn => { btn.addEventListener('click', handleCopyDialogue); }); }
            async function handleCopyPrompt(event) { const button = event.currentTarget; const promptToCopy = button.dataset.prompt; if (!promptToCopy) return; try { await navigator.clipboard.writeText(promptToCopy); const o = button.innerHTML; button.innerHTML = '<i class="fas fa-check"></i> Copié !'; button.disabled = true; setTimeout(() => { button.innerHTML = o; button.disabled = false; }, 1500); } catch (err) { console.error('Erreur copie prompt:', err); } }
            async function handleCopyDialogue(event) { const button = event.currentTarget; const dialogueToCopy = button.dataset.dialogue; if (!dialogueToCopy) return; try { await navigator.clipboard.writeText(dialogueToCopy); const o = button.innerHTML; button.innerHTML = '<i class="fas fa-check"></i> Copié !'; button.disabled = true; setTimeout(() => { button.innerHTML = o; button.disabled = false; }, 1500); } catch (err) { console.error('Erreur copie dialogue: ', err); alert('Erreur copie.'); } }

            // --- UI Update Logic ---
            function updateUI() {
                 console.log("Updating UI, current step:", appState.currentStep, "active tab:", appState.activeTab);
                 Object.values(progressSteps).forEach(s=>s.classList.remove('active','completed')); const stepsCompleted=['idea']; if(['outline_generated','chapter_detail_generated','outline_approved','storyboard_generated','prompts_generated'].includes(appState.currentStep))stepsCompleted.push('scenario'); if(['outline_approved','storyboard_generated','prompts_generated'].includes(appState.currentStep))stepsCompleted.push('storyboard'); if(appState.currentStep==='prompts_generated')stepsCompleted.push('prompts'); stepsCompleted.forEach(s=>{if(progressSteps[s])progressSteps[s].classList.add('completed');}); if(appState.currentStep==='idea')progressSteps.idea.classList.add('active'); else if(['outline_generated','chapter_detail_generated'].includes(appState.currentStep))progressSteps.scenario.classList.add('active'); else if(['outline_approved','storyboard_generated'].includes(appState.currentStep))progressSteps.storyboard.classList.add('active'); else if(appState.currentStep==='prompts_generated')progressSteps.prompts.classList.add('active');
                 const hasValidOutline=!!appState.outlineData&&!appState.outlineData.parsingError; const hasAnyDetails=Object.values(appState.chapterDetailData).some(d=>d&&!d.error); const canAccessStoryboard=hasValidOutline&&(appState.currentStep==='outline_approved'||hasAnyDetails); const hasAnyValidSB=Object.values(appState.storyboardData).some(sb=>sb&&!sb.error&&!sb.parsingError&&Array.isArray(sb)&&sb.length>0); const canAccessPrompts=hasAnyValidSB;
                 tabs.scenario.classList.toggle('disabled',!appState.outlineData); tabs.storyboard.classList.toggle('disabled',!canAccessStoryboard); tabs.prompts.classList.toggle('disabled',!canAccessPrompts);
                 tabContents.forEach(c=>{c.style.display=c.id===`${appState.activeTab}-content`?'block':'none';}); tabBtns.forEach(b=>{b.classList.toggle('active',b.getAttribute('data-tab')===appState.activeTab);});
                 if(appState.activeTab==='scenario'){if(appState.outlineData){displayOutline(appState.outlineData);if(Object.keys(appState.chapterDetailData).length>0||chapterDetailArea.innerHTML!==''){chapterDetailArea.style.display='block';}else{chapterDetailArea.innerHTML='<p>Sélectionnez un chapitre...</p>';chapterDetailArea.style.display='block';}scenarioControls.style.display='flex';scenarioModificationArea.style.display='none';approveScenarioBtn.disabled=!hasValidOutline||appState.currentStep==='outline_approved';modifyScenarioRequestBtn.disabled=!hasValidOutline;regenerateScenarioBtn.disabled=false;}else{outlineDisplayArea.innerHTML='<p>Générez une ossature...</p>';chapterDetailArea.innerHTML='';chapterDetailArea.style.display='none';scenarioControls.style.display='none';scenarioModificationArea.style.display='none';}}else{if(scenarioControls)scenarioControls.style.display='none';if(scenarioModificationArea)scenarioModificationArea.style.display='none';}
                 if(appState.activeTab==='storyboard'&&canAccessStoryboard&&storyboardChapterSelectorContainer){storyboardChapterSelectorContainer.style.display='flex';const prevSel=storyboardChapterSelect.value;storyboardChapterSelect.innerHTML='<option value="">-- Sélectionnez --</option>';let hasDetails=false;if(appState.outlineData?.chapters){appState.outlineData.chapters.forEach(ch=>{if(appState.chapterDetailData[ch.chapter]&&!appState.chapterDetailData[ch.chapter].error){const opt=document.createElement('option');opt.value=ch.chapter;opt.textContent=`Chapitre ${ch.chapter}: ${escapeHtml(ch.title||'?')}`;storyboardChapterSelect.appendChild(opt);hasDetails=true;}});}if(!hasDetails){storyboardChapterSelect.innerHTML='<option value="">Générez détail d\'abord</option>';generateStoryboardBtn.disabled=true;}else{if(Array.from(storyboardChapterSelect.options).some(o=>o.value===prevSel))storyboardChapterSelect.value=prevSel;else storyboardChapterSelect.value="";generateStoryboardBtn.disabled=!storyboardChapterSelect.value;}if(!storyboardChapterSelect.value&&storyboardOutput.innerHTML.includes('Sélectionnez')){}else if(storyboardChapterSelect.value&&storyboardOutput.innerHTML.includes('Prêt')){}else if(!storyboardChapterSelect.value&&!hasDetails)storyboardOutput.innerHTML='<p>Générez détail d\'abord.</p>';else if(!storyboardChapterSelect.value&&hasDetails)storyboardOutput.innerHTML='<p>Sélectionnez chapitre.</p>';}else if(storyboardChapterSelectorContainer)storyboardChapterSelectorContainer.style.display='none';
                 if(appState.activeTab==='prompts'){if(canAccessPrompts&&promptsChapterSelectorContainer){promptsChapterSelectorContainer.style.display='flex';const prevSel=promptsChapterSelect.value;promptsChapterSelect.innerHTML='<option value="">-- Sélectionnez --</option>';let hasSB=false;if(appState.outlineData?.chapters){appState.outlineData.chapters.forEach(ch=>{const sb=appState.storyboardData[ch.chapter];if(sb&&!sb.error&&!sb.parsingError&&Array.isArray(sb)&&sb.length>0){const opt=document.createElement('option');opt.value=ch.chapter;opt.textContent=`Chapitre ${ch.chapter}: ${escapeHtml(ch.title||'?')}`;promptsChapterSelect.appendChild(opt);hasSB=true;}});}if(!hasSB){promptsChapterSelect.innerHTML='<option value="">Générez storyboard d\'abord</option>';generatePromptsBtn.disabled=true;}else{if(Array.from(promptsChapterSelect.options).some(o=>o.value===prevSel))promptsChapterSelect.value=prevSel;else promptsChapterSelect.value="";generatePromptsBtn.disabled=!promptsChapterSelect.value;}const selCh=promptsChapterSelect.value;if(!selCh&&promptsOutput.innerHTML.includes('Sélectionnez')){}else if(selCh&&!appState.promptData[selCh])promptsOutput.innerHTML='<p>Prêt à générer prompts.</p>';else if(!selCh&&!hasSB)promptsOutput.innerHTML='<p>Générez storyboard valide d\'abord.</p>';else if(!selCh&&hasSB)promptsOutput.innerHTML='<p>Sélectionnez chapitre.</p>';}else if(promptsChapterSelectorContainer){promptsChapterSelectorContainer.style.display='none';promptsOutput.innerHTML='<p>Générez storyboard valide d\'abord.</p>';}}else if(promptsChapterSelectorContainer)promptsChapterSelectorContainer.style.display='none';
                 console.log("UI Update finished."); updateCopyAllButtonState();
            }

            // --- Backend Call Functions ---
            async function handleGenerateOutline() { appState.lastInputData={keywords:keywordsInput.value.trim(),genre:genreSelect.value,style:styleSelect.value,tone:toneSelect.value,details:detailsInput.value.trim()};if(!appState.lastInputData.keywords){alert('Idée initiale?');return;} showLoadingIndicator(true);generateScenarioBtn.disabled=true;appState.outlineData=null;appState.chapterDetailData={};appState.chapterStructuredDetailData={};appState.storyboardData={};appState.promptData={};appState.activeTab='scenario';updateUI();outlineDisplayArea.innerHTML='<p>Génération ossature...</p>';chapterDetailArea.style.display='none'; try { const response = await fetch('/api/generate-story',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(appState.lastInputData)}); if(!response.ok){let e=`HTTP Error: ${response.status}`;try{const b=await response.json();e+=` - ${b.error||'Server Error'}${b.details?` (${b.details})`:''}`}catch(p){}throw new Error(e);} const result=await response.json(); if(result.outline){appState.outlineData=result.outline;appState.currentStep='outline_generated';if(result.outline.parsingError)console.warn("Outline parse error:",result.outline.parsingError);}else if(result.error){throw new Error(`API Error: ${result.error}${result.details?` (${result.details})`:''}`);}else{throw new Error("Unexpected response.");}} catch(error){console.error("Error outline:",error);outlineDisplayArea.innerHTML=`<p class="text-danger">Erreur: ${escapeHtml(error.message)}</p>`;chapterDetailArea.style.display='none';appState.outlineData=null;appState.currentStep='idea';} finally {showLoadingIndicator(false);generateScenarioBtn.disabled=false;updateUI();} } // updateUI appelle updateCopyAllButtonState
            async function handleGenerateChapterDetail(event) { const button=event.target;const chapterNumber=button.dataset.chapterNumber;const chapterTitle=button.dataset.chapterTitle; if(!chapterNumber||!appState.outlineData){console.error("Data missing for detail gen");alert("Internal error.");return;} const currentInputs={keywords:keywordsInput.value.trim(),genre:genreSelect.value,style:styleSelect.value,tone:toneSelect.value,details:detailsInput.value.trim()}; appState.lastInputData=currentInputs; const chapterSummary=appState.outlineData.chapters?.find(ch=>ch.chapter==chapterNumber)?.summary||''; console.log(`Requesting detail C${chapterNumber}`);chapterDetailArea.innerHTML=`<p>Génération détail C${chapterNumber}...</p>`;chapterDetailArea.style.display='block';button.disabled=true;button.textContent='...'; const requestData={...currentInputs,globalTitle:appState.outlineData.title,totalChapters:appState.outlineData.chapters.length,chapterNumber:parseInt(chapterNumber,10),chapterTitle,chapterSummary}; try{const response=await fetch('/api/generate-chapter-detail',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestData)}); const result=await response.json(); appState.chapterDetailData[chapterNumber]=result; if(!response.ok){console.error(`API Error C${chapterNumber} Detail:`,result.error,result.details);appState.chapterStructuredDetailData[chapterNumber]=null;displayChapterDetail(chapterNumber,{error:result.error||`Erreur HTTP ${response.status}`,details:result.details});throw new Error(result.error||`Erreur HTTP ${response.status}`);} if(result&&result.scenarioText){try{console.log(`Parsing scenario C${chapterNumber}...`);const structuredData=parseScenarioText(result.scenarioText);appState.chapterStructuredDetailData[chapterNumber]=structuredData;console.log(`Stored structure C${chapterNumber}`,structuredData);}catch(parseError){console.error(`Error parsing C${chapterNumber}:`,parseError);appState.chapterStructuredDetailData[chapterNumber]={parsingError:parseError.message,rawText:result.scenarioText};}}else{appState.chapterStructuredDetailData[chapterNumber]=null;} if(!result.error)appState.currentStep='chapter_detail_generated'; displayChapterDetail(chapterNumber,result);}catch(error){console.error(`Fetch/Catch C${chapterNumber} Detail:`,error);if(!appState.chapterDetailData[chapterNumber]?.error){appState.chapterDetailData[chapterNumber]={error:error.message};appState.chapterStructuredDetailData[chapterNumber]=null;displayChapterDetail(chapterNumber,{error:error.message});}}finally{button.disabled=false;button.textContent='Générer Détail';updateUI();} } // updateUI appelle updateCopyAllButtonState
            async function handleGenerateStoryboard() { const selectedChapterNumber=storyboardChapterSelect.value;if(!selectedChapterNumber){alert("Sélectionnez chap.");return;}const chapterDetail=appState.chapterDetailData[selectedChapterNumber];if(!chapterDetail||chapterDetail.error||!chapterDetail.scenarioText){alert(`Détail C${selectedChapterNumber} non dispo/erreur.`);return;}if(!appState.outlineData){alert("Erreur: Ossature?");return;} const currentInputs={keywords:keywordsInput.value.trim(),genre:genreSelect.value,style:styleSelect.value,tone:toneSelect.value,details:detailsInput.value.trim()};appState.lastInputData=currentInputs; console.log(`Requesting SB C${selectedChapterNumber}`);showStoryboardLoading(true);storyboardOutput.innerHTML=`<p>Génération SB C${selectedChapterNumber}...</p>`;generateStoryboardBtn.disabled=true;storyboardChapterSelect.disabled=true; const requestData={...currentInputs,globalTitle:appState.outlineData.title,chapterNumber:parseInt(selectedChapterNumber,10),chapterTitle:appState.outlineData.chapters.find(ch=>ch.chapter==selectedChapterNumber)?.title||'',detailedScenarioText:chapterDetail.scenarioText}; try{const response=await fetch('/api/generate-storyboard-chapter',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestData)});if(!response.ok){let e=`HTTP Error: ${response.status}`;try{const b=await response.json();e+=` - ${b.error||'Server Error'}${b.details?` (${b.details})`:''}`}catch(p){}throw new Error(e);}const result=await response.json();console.log("SB data:",result);appState.storyboardData[selectedChapterNumber]=result.storyboard;if(result.storyboard?.parsingError)console.warn(`SB parse err C${selectedChapterNumber}:`,result.storyboard.parsingError);displayStoryboard(selectedChapterNumber,result.storyboard);if(result.storyboard&&!result.storyboard.error&&!result.storyboard.parsingError)appState.currentStep='storyboard_generated';}catch(error){console.error(`Error SB C${selectedChapterNumber}:`,error);appState.storyboardData[selectedChapterNumber]={error:error.message};storyboardOutput.innerHTML=`<p class="text-danger">Erreur SB: ${escapeHtml(error.message)}</p>`;}finally{showStoryboardLoading(false);generateStoryboardBtn.disabled=false;storyboardChapterSelect.disabled=false;updateUI();} }
            async function handleGeneratePrompts() { const selectedChapterNumber=promptsChapterSelect.value;if(!selectedChapterNumber){alert("Sélectionnez chap.");return;}const storyboardChapterData=appState.storyboardData[selectedChapterNumber];if(!storyboardChapterData||storyboardChapterData.error||storyboardChapterData.parsingError||!Array.isArray(storyboardChapterData)||storyboardChapterData.length===0){alert(`SB C${selectedChapterNumber} non dispo/err/vide.`);return;}if(!appState.outlineData){alert("Erreur: Ossature?");return;} const currentInputs={genre:genreSelect.value,style:styleSelect.value,tone:toneSelect.value,details:detailsInput.value.trim()};appState.lastInputData={...appState.lastInputData,...currentInputs}; console.log(`Requesting prompts C${selectedChapterNumber}`);showPromptsLoading(true);promptsOutput.innerHTML=`<p>Génération prompts C${selectedChapterNumber}...</p>`;generatePromptsBtn.disabled=true;promptsChapterSelect.disabled=true; const requestData={genre:currentInputs.genre,style:currentInputs.style,tone:currentInputs.tone,details:currentInputs.details,globalTitle:appState.outlineData.title,chapterNumber:parseInt(selectedChapterNumber,10),chapterTitle:appState.outlineData.chapters.find(ch=>ch.chapter==selectedChapterNumber)?.title||'',storyboardDataForChapter:storyboardChapterData}; try{const response=await fetch('/api/generate-prompts-chapter',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestData)});if(!response.ok){let e=`HTTP Error: ${response.status}`;try{const b=await response.json();e+=` - ${b.error||'Server Error'}${b.details?` (${b.details})`:''}`}catch(p){}throw new Error(e);}const result=await response.json();console.log("Prompts data:",result);appState.promptData[selectedChapterNumber]=result.prompts||{error:result.error||"Unexpected API response."};displayPrompts(selectedChapterNumber,appState.promptData[selectedChapterNumber]);if(Array.isArray(appState.promptData[selectedChapterNumber]))appState.currentStep='prompts_generated';}catch(error){console.error(`Error prompts C${selectedChapterNumber}:`,error);appState.promptData[selectedChapterNumber]={error:error.message};displayPrompts(selectedChapterNumber,appState.promptData[selectedChapterNumber]);}finally{showPromptsLoading(false);generatePromptsBtn.disabled=false;promptsChapterSelect.disabled=false;updateUI();} }

            // --- Event Handlers ---
            function handleApproveOutline(){if(!appState.outlineData||appState.outlineData.parsingError){alert("Cannot approve invalid outline.");return;}const hasAnyDetails=Object.values(appState.chapterDetailData).some(d=>d&&!d.error&&d.scenarioText);if(!hasAnyDetails&&!confirm("No details generated. Proceed anyway?")){return;}appState.currentStep='outline_approved';appState.activeTab='storyboard';updateUI();const firstDetailKey=Object.keys(appState.chapterDetailData).find(k=>appState.chapterDetailData[k]&&!appState.chapterDetailData[k].error&&appState.chapterDetailData[k].scenarioText);if(firstDetailKey&&storyboardChapterSelect){storyboardChapterSelect.value=firstDetailKey;generateStoryboardBtn.disabled=false;storyboardOutput.innerHTML='<p>Ready to generate storyboard.</p>';}else if(storyboardChapterSelect?.options.length>1){storyboardOutput.innerHTML='<p>Select chapter.</p>';}else{storyboardOutput.innerHTML='<p>Generate chapter detail first.</p>';}}
            function handleModifyOutlineRequest(){scenarioModificationArea.style.display='block';scenarioControls.style.display='none';}
            async function handleSubmitOutlineModification(){const modReq=scenarioModificationInput.value.trim();if(!modReq){alert("Describe changes.");return;}console.warn("Mod submit not implemented:",modReq);alert("Not implemented.");scenarioModificationInput.value='';scenarioModificationArea.style.display='none';updateUI();}
            function handleRegenerateOutline(){if(confirm("Regenerate outline? Work lost.")){if(appState.lastInputData)handleGenerateOutline();else{alert("Initial data needed.");appState.activeTab='home';updateUI();}}}
            async function handleCopyAllDetails(){const button=document.getElementById('copy-all-details-btn');if(!appState.outlineData?.chapters){alert("No outline.");return;}let fullTextToCopy="";let chaptersCopiedCount=0;if(appState.outlineData.title&&appState.outlineData.title!=="N/A"){fullTextToCopy+=`TITRE GLOBAL : ${appState.outlineData.title}\n====================================\n\n`;}const sortedChapters=[...appState.outlineData.chapters].sort((a,b)=>a.chapter-b.chapter);sortedChapters.forEach(chInfo=>{const chNum=chInfo.chapter;const chDetail=appState.chapterDetailData[chNum];if(chDetail&&!chDetail.error&&chDetail.scenarioText){fullTextToCopy+=`CHAPITRE ${chNum} : ${escapeHtml(chInfo.title||'?')}\n------------------------------------\n`;fullTextToCopy+=chDetail.scenarioText;fullTextToCopy+="\n\n====================================\n\n";chaptersCopiedCount++;}});if(chaptersCopiedCount===0){alert("No details generated yet.");return;}try{await navigator.clipboard.writeText(fullTextToCopy);const o=button.innerHTML;button.innerHTML=`<i class="fas fa-check"></i> ${chaptersCopiedCount} Chap. Copié(s)!`;button.disabled=true;setTimeout(()=>{button.innerHTML=`<i class="fas fa-copy"></i> Copier Tous Détails`;updateCopyAllButtonState();},2500);}catch(err){console.error('Err copy all:',err);alert('Erreur copie.');}}
            function updateCopyAllButtonState(){const button=document.getElementById('copy-all-details-btn');if(!button)return;const hasAnyDetails=Object.values(appState.chapterDetailData).some(d=>d&&!d.error&&d.scenarioText);button.disabled=!hasAnyDetails;}

            // --- Event Listeners Setup ---
            tabBtns.forEach(btn=>{btn.addEventListener('click',function(){if(this.classList.contains('disabled'))return;appState.activeTab=this.getAttribute('data-tab');updateUI();});});
            generateScenarioBtn.addEventListener('click',handleGenerateOutline);
            approveScenarioBtn.addEventListener('click',handleApproveOutline);
            modifyScenarioRequestBtn.addEventListener('click',handleModifyOutlineRequest);
            submitScenarioModificationBtn.addEventListener('click',handleSubmitOutlineModification);
            regenerateScenarioBtn.addEventListener('click',handleRegenerateOutline);
            if(copyAllDetailsBtn)copyAllDetailsBtn.addEventListener('click',handleCopyAllDetails);
            if(storyboardChapterSelect){storyboardChapterSelect.addEventListener('change',function(){generateStoryboardBtn.disabled=!this.value;if(this.value){const sbData=appState.storyboardData[this.value];if(sbData&&!sbData.error&&!sbData.parsingError)displayStoryboard(this.value,sbData);else if(sbData?.error||sbData?.parsingError)displayStoryboard(this.value,sbData);else storyboardOutput.innerHTML='<p>Prêt à générer storyboard.</p>';}else storyboardOutput.innerHTML='<p>Sélectionnez chapitre.</p>';});}
            if(generateStoryboardBtn)generateStoryboardBtn.addEventListener('click',handleGenerateStoryboard);
            if(promptsChapterSelect){promptsChapterSelect.addEventListener('change',function(){generatePromptsBtn.disabled=!this.value;if(this.value){if(appState.promptData[this.value])displayPrompts(this.value,appState.promptData[this.value]);else promptsOutput.innerHTML='<p>Prêt à générer prompts.</p>';}else promptsOutput.innerHTML='<p>Sélectionnez chapitre.</p>';});}
            if(generatePromptsBtn)generatePromptsBtn.addEventListener('click',handleGeneratePrompts);

             // Session Management Listeners
             document.getElementById('new-session').addEventListener('click',function(){if(confirm('Nouvelle session?')){appState={currentStep:'idea',outlineData:null,chapterDetailData:{},chapterStructuredDetailData:{},storyboardData:{},promptData:{},lastInputData:null,activeTab:'home'};keywordsInput.value='';genreSelect.selectedIndex=0;styleSelect.selectedIndex=0;toneSelect.selectedIndex=0;detailsInput.value='';if(outlineDisplayArea)outlineDisplayArea.innerHTML='<p>Générez ossature...</p>';if(chapterDetailArea){chapterDetailArea.innerHTML='';chapterDetailArea.style.display='none';}if(scenarioOutput&&!outlineDisplayArea)scenarioOutput.innerHTML='<p>Générez ossature...</p>';if(storyboardOutput)storyboardOutput.innerHTML='<p>Sélectionnez chapitre...</p>';if(promptsOutput)promptsOutput.innerHTML='<p>Générez storyboard...</p>';updateUI();}});
             document.getElementById('save-session').addEventListener('click',function(){appState.lastInputData={keywords:keywordsInput.value.trim(),genre:genreSelect.value,style:styleSelect.value,tone:toneSelect.value,details:detailsInput.value.trim()};const sessionName=prompt('Nom session:',`Session_${new Date().toISOString().slice(0,10)}`);if(sessionName){try{const sessionDataString=JSON.stringify(appState);if(sessionDataString.length>4*1024*1024)alert("Session large!");localStorage.setItem(`bdcreator_session_${sessionName}`,sessionDataString);alert(`Session "${sessionName}" sauvegardée.`);}catch(e){alert(`Erreur sauvegarde: ${e.message}.`);console.error("Save error:",e);}}});
             document.getElementById('load-session').addEventListener('click',function(){const sessions=[];try{for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key?.startsWith('bdcreator_session_'))sessions.push(key.replace('bdcreator_session_',''));}}catch(e){alert("Erreur accès stockage.");console.error("LS error:",e);return;}if(sessions.length===0){alert('Aucune session.');return;}const sessionName=prompt(`Charger session:\n\n${sessions.join('\n')}`,sessions[0]);if(sessionName&&sessions.includes(sessionName)){try{const sessionString=localStorage.getItem(`bdcreator_session_${sessionName}`);if(!sessionString)throw new Error("Données vides.");const loadedState=JSON.parse(sessionString);if(!loadedState?.currentStep||!loadedState?.activeTab)throw new Error("Format invalide.");appState=loadedState;if(appState.chapterStructuredDetailData===undefined)appState.chapterStructuredDetailData={};if(appState.promptData===undefined)appState.promptData={}; const inputs=appState.lastInputData||{};keywordsInput.value=inputs.keywords||'';genreSelect.value=inputs.genre||'Fantastique';styleSelect.value=inputs.style||'Manga';toneSelect.value=inputs.tone||'Épique';detailsInput.value=inputs.details||'';alert(`Session "${sessionName}" chargée.`);if(outlineDisplayArea)outlineDisplayArea.innerHTML='';if(chapterDetailArea){chapterDetailArea.innerHTML='';chapterDetailArea.style.display='none';}if(scenarioOutput&&!outlineDisplayArea)scenarioOutput.innerHTML='';if(storyboardOutput)storyboardOutput.innerHTML='';if(promptsOutput)promptsOutput.innerHTML='';updateUI();if(appState.activeTab==='scenario'&&appState.outlineData){displayOutline(appState.outlineData);const firstDetailKey=Object.keys(appState.chapterDetailData).find(k=>appState.chapterDetailData[k]&&!appState.chapterDetailData[k].error&&appState.chapterDetailData[k].scenarioText);if(firstDetailKey)displayChapterDetail(firstDetailKey,appState.chapterDetailData[firstDetailKey]);}if(appState.activeTab==='storyboard'){const selSB=storyboardChapterSelect.value;if(selSB&&appState.storyboardData[selSB])displayStoryboard(selSB,appState.storyboardData[selSB]);}if(appState.activeTab==='prompts'){const selPr=promptsChapterSelect.value;if(selPr&&appState.promptData[selPr])displayPrompts(selPr,appState.promptData[selPr]);}}catch(e){alert(`Erreur chargement "${sessionName}" : ${e.message}.`);console.error("Load error:",e);}}else if(sessionName){alert(`Session invalide: "${sessionName}"`);}});

            // --- Initial UI Setup ---
            updateUI();

        });
    </script>

</body>
</html>
