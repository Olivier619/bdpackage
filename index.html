<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD Creator - Créez des bandes dessinées avec l'IA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- Styles CSS (identiques à avant, y compris les styles pour #outline-display-area, #chapter-detail-area, etc.) --- */
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FF9800;
            --dark-color: #333;
            --light-color: #f4f4f4;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --disabled-color: #ccc;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; background-color: #f8f9fa; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header { background-color: var(--primary-color); color: white; padding: 1rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo { font-size: 1.8rem; font-weight: bold; display: flex; align-items: center; margin-bottom: 0.5rem; }
        .logo i { margin-right: 10px; font-size: 2rem; }
        nav ul { display: flex; list-style: none; flex-wrap: wrap; justify-content: center; }
        nav ul li { margin-left: 10px; margin-right: 10px; margin-bottom: 0.5rem; }
        nav ul li a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s; }
        nav ul li a:hover { color: var(--secondary-color); }
        .hero { background: linear-gradient(135deg, var(--primary-color) 0%, #64b5f6 100%); color: white; padding: 4rem 0; text-align: center; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        .hero p { font-size: 1.2rem; max-width: 800px; margin: 0 auto 2rem; }
        .btn { display: inline-block; background: var(--secondary-color); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; transition: background 0.3s, transform 0.2s; text-decoration: none; font-weight: 500; }
        .btn:hover { background: #e68a00; transform: translateY(-2px); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        .btn-primary { background: var(--primary-color); }
        .btn-primary:hover { background: #0b7dda; }
        .btn-primary:disabled { background-color: #a0cff8; }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .features { padding: 4rem 0; background-color: white; }
        .section-title { text-align: center; margin-bottom: 3rem; }
        .section-title h2 { font-size: 2rem; color: var(--dark-color); margin-bottom: 1rem; }
        .section-title p { color: #666; max-width: 800px; margin: 0 auto; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .feature-card { background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; text-align: center; }
        .feature-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .feature-card i { font-size: 3rem; color: var(--primary-color); margin-bottom: 1.5rem; }
        .feature-card h3 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--dark-color); }
        .feature-card p { color: #666; }
        .how-it-works { padding: 4rem 0; background-color: #f8f9fa; }
        .steps { display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem; margin-top: 3rem; }
        .step { flex: 1; min-width: 250px; max-width: 350px; text-align: center; position: relative; }
        .step-number { width: 50px; height: 50px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; margin: 0 auto 1.5rem; }
        .step h3 { margin-bottom: 1rem; color: var(--dark-color); }
        .step p { color: #666; }
        .app { padding: 4rem 0; background-color: white; }
        .tabs { display: flex; justify-content: center; margin-bottom: 2rem; border-bottom: 1px solid #ddd; padding-bottom: 1rem; flex-wrap: wrap; }
        .tab-btn { background: none; border: none; padding: 0.8rem 1.5rem; margin: 0 0.5rem 0.5rem 0.5rem; font-size: 1rem; cursor: pointer; border-radius: 5px 5px 0 0; transition: background 0.3s, color 0.3s; font-weight: 500; }
        .tab-btn.active { background-color: var(--primary-color); color: white; }
        .tab-content { display: none; padding: 2rem; background: white; border-radius: 0 0 8px 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); min-height: 200px; }
        .tab-content.active { display: block; }
        .input-group { margin-bottom: 1.5rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; font-family: inherit; }
        .input-group textarea { min-height: 80px; resize: vertical; }
        footer { background-color: var(--dark-color); color: white; padding: 2rem 0; text-align: center; margin-top: 4rem; }
        footer p { margin-bottom: 1rem; }
        .social-links { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
        .social-links a { color: white; font-size: 1.5rem; transition: color 0.3s; }
        .social-links a:hover { color: var(--secondary-color); }
        .footer-links { display: flex; justify-content: center; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1rem; }
        .footer-links a { color: #ddd; text-decoration: none; transition: color 0.3s; }
        .footer-links a:hover { color: var(--secondary-color); }
        /* Application Specific Styles */
        .scenario-section, .scenario-chapter, .storyboard-page, .prompt-item { margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border-left: 4px solid var(--primary-color); }
        #outline-display-area { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        #outline-display-area h4 { margin-bottom: 15px; color: var(--dark-color); }
        #outline-display-area ul { list-style: none; padding-left: 0; }
        #outline-display-area li { padding: 10px; border: 1px solid #e0e0e0; margin-bottom: 10px; border-radius: 5px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        #outline-display-area li div { flex-grow: 1; margin-right: 10px; margin-bottom: 5px; }
        #outline-display-area li button { flex-shrink: 0; }
        #chapter-detail-area { margin-top: 20px; padding: 15px; background-color: #f0f8ff; border-radius: 5px; border: 1px solid #d1e7fd; display: none; }
        #chapter-detail-area h4 { color: var(--primary-color); margin-bottom: 10px; }
        #chapter-detail-area pre { white-space: pre-wrap; background-color: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px; max-height: 500px; overflow-y: auto; margin-top: 10px; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; font-size: 0.9em; }
        .storyboard-page { margin-bottom: 20px; padding: 15px; background-color: #fffaf0; border-radius: 8px; border-left: 4px solid var(--secondary-color); }
        .storyboard-page h5 { color: var(--secondary-color); margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .storyboard-panel-display { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #fafafa; }
        .storyboard-panel-display h6 { color: var(--dark-color); margin-bottom: 8px; }
        .storyboard-panel-details p { margin-bottom: 5px; font-size: 0.95em; }
        .storyboard-panel-details p strong { color: var(--dark-color); }
        /* .storyboard-visual-placeholder removed */
        .prompt-item { border-left-color: var(--success-color); }
        .prompt-item h6 { color: var(--success-color); margin-bottom: 8px; } /* Style for prompt title */
        .prompt-item pre { background-color: #333; color: white; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 10px; margin-bottom: 10px; white-space: pre-wrap; word-break: break-all; }
        .prompt-item button.copy-prompt-btn { background-color: var(--secondary-color); border: none; color: white; }
        .prompt-item button.copy-prompt-btn:hover { background-color: #e68a00; }
        .prompt-item button.copy-prompt-btn:disabled { background-color: #ccc; }
        .session-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .session-controls button { flex: 1 1 auto; min-width: 150px; }
        #loading-indicator, #storyboard-loading-indicator, #prompts-loading-indicator { display: none; text-align: center; margin: 20px 0; padding: 15px; background-color: rgba(255, 255, 255, 0.8); border-radius: 8px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .app-controls { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; display: none; gap: 10px; flex-wrap: wrap; }
        .app-controls button { margin-right: 10px; margin-bottom: 10px; }
        .modification-area { margin-top: 1rem; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa; display: none; }
        .modification-area label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modification-area textarea { width: 100%; min-height: 80px; margin-bottom: 0.5rem; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .tab-btn.disabled { color: var(--disabled-color); cursor: not-allowed; background: #eee; }
        .chapter-selector { margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .chapter-selector label { margin-bottom: 0; font-weight: 500; white-space: nowrap; }
        .chapter-selector select { flex-grow: 1; max-width: 400px; padding: 0.6rem; }
        .chapter-selector button { flex-shrink: 0; }
        .progress-indicator { display: flex; justify-content: space-around; margin-bottom: 2rem; padding: 1rem; background-color: #e9ecef; border-radius: 5px; flex-wrap: wrap; gap: 10px; }
        .progress-step { text-align: center; color: #adb5bd; flex: 1; min-width: 80px; }
        .progress-step.active { color: var(--primary-color); font-weight: bold; }
        .progress-step.completed { color: var(--success-color); font-weight: bold; }
        .progress-step .icon { display: block; font-size: 1.5rem; margin-bottom: 0.5rem; }
        .input-group-inline { display: flex; gap: 20px; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .input-group-inline .input-group { flex: 1; min-width: 200px; margin-bottom: 0; }
        .text-danger { color: var(--danger-color); font-weight: bold; }
        /* Media Queries */
        @media (max-width: 768px) {
             header .container { flex-direction: column; text-align: center; }
             nav ul { margin-top: 1rem; justify-content: center; }
             nav ul li { margin-left: 10px; margin-right: 10px; }
            .hero h1 { font-size: 2rem; } .hero p { font-size: 1rem; }
            .features-grid { grid-template-columns: 1fr; }
            .steps { flex-direction: column; align-items: center; }
            .step { margin-bottom: 2rem; max-width: 90%; }
            .tabs { justify-content: flex-start; }
            .tab-btn { flex-grow: 1; margin-left: 0; margin-right: 0; }
            .session-controls { justify-content: center; }
            .input-group-inline { flex-direction: column; gap: 1rem; }
            .chapter-selector { flex-direction: column; align-items: flex-start; gap: 5px;}
            .chapter-selector select { max-width: 100%; }
             .chapter-selector button { width: 100%; margin-top: 5px; }
            .progress-indicator { gap: 5px; } .progress-step .icon { font-size: 1.2rem; }
            #outline-display-area li { flex-direction: column; align-items: flex-start;}
            #outline-display-area li div { margin-right: 0; }
            #outline-display-area li button { width: 100%; margin-top: 10px;}
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-book-open"></i>
                <span>BD Creator</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#features">Fonctionnalités</a></li>
                    <li><a href="#how-it-works">Comment ça marche</a></li>
                    <li><a href="#app">Créer ma BD</a></li>
                    <li><a href="#" id="login-btn">Connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <h1>Créez des bandes dessinées incroyables avec l'IA</h1>
            <p>Transformez vos idées en scénarios complets, storyboards détaillés et prompts optimisés en quelques clics grâce à l'IA côté serveur.</p>
            <a href="#app" class="btn">Commencer maintenant</a>
        </div>
    </section>

    <section class="features" id="features">
        <!-- Contenu des fonctionnalités -->
         <div class="container">
             <div class="section-title"><h2>Fonctionnalités</h2><p>Découvrez ce que BD Creator peut faire pour vous.</p></div>
             <div class="features-grid">
                 <div class="feature-card"><i class="fas fa-lightbulb"></i><h3>Idée Initiale & Options</h3><p>Démarrez avec une simple idée, phrase ou mots-clés. Choisissez le genre, le style visuel et le ton pour guider l'IA.</p></div>
                 <div class="feature-card"><i class="fas fa-server"></i><h3>Génération Scénario via API</h3><p>Notre IA côté serveur transforme votre idée en une ossature complète (titre, chapitres, résumés), puis génère le détail de chaque chapitre.</p></div>
                 <div class="feature-card"><i class="fas fa-pencil-alt"></i><h3>Storyboard Assisté</h3><p>Visualisez votre histoire avec des suggestions de cadrage, composition et style pour chaque case, basées sur le scénario détaillé.</p></div>
                 <div class="feature-card"><i class="fas fa-image"></i><h3>Prompts Optimisés</h3><p>Générez des prompts en anglais prêts pour Midjourney, Dall-E ou Stable Diffusion, basés sur votre storyboard et le style visuel choisi.</p></div>
                 <div class="feature-card"><i class="fas fa-tasks"></i><h3>Workflow Guidé</h3><p>Suivez un processus étape par étape, de l'idée initiale à la génération des prompts, avec des indicateurs de progression clairs.</p></div>
                 <div class="feature-card"><i class="fas fa-save"></i><h3>Sauvegarde de Sessions</h3><p>Ne perdez jamais votre travail. Sauvegardez et chargez vos sessions de création directement dans votre navigateur.</p></div>
             </div>
         </div>
    </section>

    <section class="how-it-works" id="how-it-works">
        <!-- Comment ça marche -->
         <div class="container">
             <div class="section-title"><h2>Comment ça marche</h2><p>Un processus simple en 4 étapes pour donner vie à vos histoires.</p></div>
             <div class="steps">
                 <div class="step"><div class="step-number">1</div><h3>Décrivez votre idée</h3><p>Fournissez le concept de base de votre BD et sélectionnez les options clés (genre, style, ton).</p></div>
                 <div class="step"><div class="step-number">2</div><h3>Générez & Validez l'Ossature</h3><p>L'IA crée l'ossature (titres, résumés). Générez ensuite le détail des chapitres qui vous intéressent.</p></div>
                 <div class="step"><div class="step-number">3</div><h3>Générez le Storyboard</h3><p>Pour chaque chapitre détaillé, obtenez des suggestions visuelles (plan, angle...) pour chaque case clé.</p></div>
                 <div class="step"><div class="step-number">4</div><h3>Obtenez les Prompts</h3><p>Recevez les prompts d'IA générative d'image optimisés (en anglais) pour chaque case du storyboard généré.</p></div>
             </div>
         </div>
    </section>

    <section class="app" id="app">
        <div class="container">
            <div class="section-title">
                <h2>Créez votre BD maintenant</h2>
                <p>Utilisez notre application pour transformer vos idées en bandes dessinées complètes.</p>
            </div>

            <div class="session-controls">
                <button class="btn" id="new-session">Nouvelle session</button>
                <button class="btn" id="save-session">Sauvegarder la session</button>
                <button class="btn" id="load-session">Charger une session</button>
            </div>

            <!-- Progress Indicator -->
             <div class="progress-indicator">
                <div class="progress-step active" id="step-idea"><span class="icon"><i class="fas fa-lightbulb"></i></span>Idée</div>
                <div class="progress-step" id="step-scenario"><span class="icon"><i class="fas fa-file-alt"></i></span>Scénario</div>
                <div class="progress-step" id="step-storyboard"><span class="icon"><i class="fas fa-border-all"></i></span>Storyboard</div>
                <div class="progress-step" id="step-prompts"><span class="icon"><i class="fas fa-magic"></i></span>Prompts</div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="home">1. Idée & Options</button>
                <button class="tab-btn disabled" data-tab="scenario">2. Scénario</button>
                <button class="tab-btn disabled" data-tab="storyboard">3. Storyboard</button>
                <button class="tab-btn disabled" data-tab="prompts">4. Prompts</button>
            </div>

            <!-- Tab 1: Home / Idea Input -->
            <div class="tab-content active" id="home-content">
                <h3>Entrez les détails de votre projet</h3>
                <p>Commencez par décrire votre idée et choisissez les options pour guider l'IA.</p>
                <div class="input-group">
                    <label for="keywords">Idée initiale (mots-clés, phrase, ou courte histoire)</label>
                    <textarea id="keywords" placeholder="Ex: Aventure spatiale avec des chats pirates cherchant une planète de thon légendaire." rows="3"></textarea>
                </div>
                <div class="input-group-inline">
                     <div class="input-group"><label for="genre">Genre</label><select id="genre"><option value="Fantastique">Fantastique</option><option value="Science-Fiction">Science-Fiction</option><option value="Policier">Policier</option><option value="Humour">Humour</option><option value="Drame">Drame</option><option value="Aventure">Aventure</option><option value="Slice of Life">Slice of Life</option><option value="Horreur">Horreur</option><option value="Historique">Historique</option><option value="Western">Western</option></select></div>
                     <div class="input-group"><label for="style">Style Visuel Cible</label><select id="style"><option value="Manga">Manga</option><option value="Franco-Belge">Franco-Belge (Ligne Claire)</option><option value="Comics US">Comics US (Super-héros)</option><option value="Réaliste">Réaliste / Peinture Numérique</option><option value="Cartoon">Cartoon / Animation</option><option value="Aquarelle">Aquarelle</option><option value="Pixel Art">Pixel Art</option><option value="Noir et Blanc">Noir et Blanc (Ink)</option></select></div>
                     <div class="input-group"><label for="tone">Ton</label><select id="tone"><option value="Épique">Épique</option><option value="Sérieux">Sérieux</option><option value="Léger / Humoristique">Léger / Humoristique</option><option value="Sombre / Mature">Sombre / Mature</option><option value="Mystérieux">Mystérieux</option><option value="Poétique">Poétique</option><option value="Satirique">Satirique</option><option value="Action">Action</option></select></div>
                </div>
                 <div class="input-group">
                    <label for="details">Détails Optionnels (Personnages principaux, Univers, Éléments clés)</label>
                    <textarea id="details" placeholder="Ex: Capitaine Moustache (chat roux borgne), Second Patte-de-Velours (chat noir agile). Vaisseau: Le Sardine Volante. Cherchent la planète Catlantic." rows="4"></textarea>
                </div>
                <button class="btn btn-primary" id="generate-scenario">Générer l'Ossature</button>
                <div id="loading-indicator"><div class="spinner"></div><p>Génération en cours via l'API...</p></div>
            </div>

            <!-- Tab 2: Scenario -->
            <div class="tab-content" id="scenario-content">
                <h3>Votre Ossature / Scénario</h3>
                <div id="scenario-output">
                    <div id="outline-display-area"><p>L'ossature de votre scénario (titre, chapitres, résumés) s'affichera ici après la génération initiale.</p></div>
                    <hr style="margin: 20px 0;">
                    <div id="chapter-detail-area"><p>Le contenu détaillé du chapitre sélectionné s'affichera ici après sa génération.</p></div>
                </div>

                <!-- NOUVEAU BOUTON AJOUTÉ ICI -->
                <div style="text-align: right; margin-top: 15px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" id="copy-all-details-btn" disabled>
                        <i class="fas fa-copy"></i> Copier Tous les Détails Générés
                    </button>
                </div>
                <!-- FIN NOUVEAU BOUTON -->

                <div class="app-controls" id="scenario-controls">
                    <button class="btn btn-success" id="approve-scenario">Passer au Storyboard</button>
                    <button class="btn btn-primary" id="modify-scenario-request">Demander Modifications (Ossature)</button>
                    <button class="btn btn-danger" id="regenerate-scenario">Régénérer Ossature</button>
                </div>
                <div class="modification-area" id="scenario-modification-area">
                    <label for="scenario-modification-input">Décrivez les modifications souhaitées pour l'ossature :</label>
                    <textarea id="scenario-modification-input"></textarea>
                    <button class="btn btn-primary" id="submit-scenario-modification">Soumettre Modification</button>
                </div>
            </div>

            <!-- Tab 3: Storyboard -->
             <div class="tab-content" id="storyboard-content">
                 <h3>Votre Storyboard</h3>
                 <div class="chapter-selector" id="storyboard-chapter-selector-container" style="display: none;">
                     <label for="storyboard-chapter-select">Choisir le chapitre :</label>
                     <select id="storyboard-chapter-select"><option value="">-- Sélectionnez --</option></select>
                     <button class="btn btn-primary btn-sm" id="generate-storyboard-btn" disabled>Générer Storyboard Chapitre</button>
                 </div>
                 <div id="storyboard-loading-indicator" style="display: none; margin-top: 15px;">
                     <div class="spinner"></div>
                     <p>Génération du storyboard pour ce chapitre...</p>
                 </div>
                 <div id="storyboard-output">
                     <p>Sélectionnez un chapitre dont le détail a été généré, puis cliquez sur "Générer Storyboard Chapitre".</p>
                 </div>
             </div>


             <!-- Tab 4: Prompts -->
             <div class="tab-content" id="prompts-content">
                 <h3>Vos Prompts Midjourney</h3>
                 <!-- Sélecteur de Chapitre pour Prompts -->
                 <div class="chapter-selector" id="prompts-chapter-selector-container" style="display: none;">
                     <label for="prompts-chapter-select">Choisir le chapitre :</label>
                     <select id="prompts-chapter-select"><option value="">-- Sélectionnez --</option></select>
                     <button class="btn btn-primary btn-sm" id="generate-prompts-btn" disabled>Générer Prompts Chapitre</button>
                 </div>
                 <!-- Indicateur de Chargement pour Prompts -->
                 <div id="prompts-loading-indicator" style="display: none; margin-top: 15px;">
                     <div class="spinner" style="border-left-color: var(--success-color);"></div> <!-- Spinner vert -->
                     <p>Génération des prompts pour ce chapitre...</p>
                 </div>
                 <!-- Zone d'Affichage des Prompts -->
                 <div id="prompts-output" style="margin-top: 20px;">
                     <p>Sélectionnez un chapitre dont le storyboard a été généré, puis cliquez sur "Générer Prompts Chapitre".</p>
                     <!-- Les prompts générés s'afficheront ici -->
                 </div>
             </div>
        </div>
    </section>

    <footer>
        <!-- Contenu du footer -->
         <div class="container">
            <p>© 2025 BD Creator. Tous droits réservés.</p>
            <div class="social-links">
                <a href="#" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
            </div>
            <div class="footer-links">
                <a href="#">Politique de confidentialité</a>
                <a href="#">Conditions d'utilisation</a>
                <a href="#">Contact</a>
            </div>
        </div>
    </footer>

    <!-- Inline script includes all necessary JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const loadingIndicator = document.getElementById('loading-indicator');
            const keywordsInput = document.getElementById('keywords');
            const genreSelect = document.getElementById('genre');
            const styleSelect = document.getElementById('style');
            const toneSelect = document.getElementById('tone');
            const detailsInput = document.getElementById('details');
            const generateScenarioBtn = document.getElementById('generate-scenario');

            // Scenario/Outline Tab Elements
            const scenarioOutput = document.getElementById('scenario-output');
            const outlineDisplayArea = document.getElementById('outline-display-area');
            const chapterDetailArea = document.getElementById('chapter-detail-area');
            const scenarioControls = document.getElementById('scenario-controls');
            const approveScenarioBtn = document.getElementById('approve-scenario');
            const modifyScenarioRequestBtn = document.getElementById('modify-scenario-request');
            const regenerateScenarioBtn = document.getElementById('regenerate-scenario');
            const scenarioModificationArea = document.getElementById('scenario-modification-area');
            const scenarioModificationInput = document.getElementById('scenario-modification-input');
            const submitScenarioModificationBtn = document.getElementById('submit-scenario-modification');
            const copyAllDetailsBtn = document.getElementById('copy-all-details-btn'); // Nouveau bouton

            // Storyboard Tab Elements
            const storyboardChapterSelectorContainer = document.getElementById('storyboard-chapter-selector-container');
            const storyboardChapterSelect = document.getElementById('storyboard-chapter-select');
            const generateStoryboardBtn = document.getElementById('generate-storyboard-btn');
            const storyboardLoadingIndicator = document.getElementById('storyboard-loading-indicator');
            const storyboardOutput = document.getElementById('storyboard-output');

            // Prompts Tab Elements
            const promptsChapterSelectorContainer = document.getElementById('prompts-chapter-selector-container');
            const promptsChapterSelect = document.getElementById('prompts-chapter-select');
            const generatePromptsBtn = document.getElementById('generate-prompts-btn');
            const promptsLoadingIndicator = document.getElementById('prompts-loading-indicator');
            const promptsOutput = document.getElementById('prompts-output');

            // Progress Indicator Steps
            const progressSteps = {
                idea: document.getElementById('step-idea'),
                scenario: document.getElementById('step-scenario'),
                storyboard: document.getElementById('step-storyboard'),
                prompts: document.getElementById('step-prompts'),
            };

            // Tab Buttons Map
            const tabs = {
                home: document.querySelector('[data-tab="home"]'),
                scenario: document.querySelector('[data-tab="scenario"]'),
                storyboard: document.querySelector('[data-tab="storyboard"]'),
                prompts: document.querySelector('[data-tab="prompts"]'),
            };

            // --- Application State ---
             let appState = {
                 currentStep: 'idea',
                 outlineData: null,
                 chapterDetailData: {},
                 storyboardData: {},
                 promptData: {},
                 lastInputData: null,
                 activeTab: 'home'
             };

            // --- Helper Functions ---

            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return unsafe;
                return unsafe
                     .replace(/&/g, "&")
                     .replace(/</g, "<")
                     .replace(/>/g, ">")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "'");
             }

             function showLoadingIndicator(show) { if (loadingIndicator) loadingIndicator.style.display = show ? 'block' : 'none'; }
             function showStoryboardLoading(show) { if (storyboardLoadingIndicator) storyboardLoadingIndicator.style.display = show ? 'block' : 'none'; }
             function showPromptsLoading(show) { if (promptsLoadingIndicator) promptsLoadingIndicator.style.display = show ? 'block' : 'none'; }

            // --- Display Functions ---

            function displayOutline(outlineData) {
                 outlineDisplayArea.innerHTML = '';
                 if (!outlineData) { outlineDisplayArea.innerHTML = '<p>Aucune donnée d\'ossature à afficher.</p>'; return; }
                 if (outlineData.parsingError) { console.warn("Backend outline parsing failed:", outlineData.parsingError); outlineDisplayArea.innerHTML = `<h4>Erreur d'Analyse de l'Ossature</h4><p>L'IA a répondu, mais le format n'a pas pu être analysé automatiquement. Voici le texte brut :</p><pre style="white-space: pre-wrap; background-color: #eee; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;">${escapeHtml(outlineData.rawText || 'N/A')}</pre>`; return; }
                 const globalTitle = outlineData.title || "Titre non défini";
                 const titleElement = document.createElement('h4'); titleElement.style.marginBottom = '15px'; titleElement.textContent = `Titre Global : ${globalTitle}`; outlineDisplayArea.appendChild(titleElement);
                 const chaptersArray = outlineData.chapters;
                 if (Array.isArray(chaptersArray) && chaptersArray.length > 0) {
                     const chapterList = document.createElement('ul');
                     chaptersArray.forEach(chapter => {
                         const listItem = document.createElement('li'); const chapterInfo = document.createElement('div'); chapterInfo.innerHTML = `<b>Chapitre ${chapter.chapter}: ${escapeHtml(chapter.title || '')}</b><br><small><i>${escapeHtml(chapter.summary || 'Résumé non fourni.')}</i></small>`; listItem.appendChild(chapterInfo);
                         const generateButton = document.createElement('button'); generateButton.textContent = `Générer Détail`; generateButton.classList.add('btn', 'btn-sm', 'btn-secondary'); generateButton.dataset.chapterNumber = chapter.chapter; generateButton.dataset.chapterTitle = chapter.title || ''; generateButton.onclick = handleGenerateChapterDetail; listItem.appendChild(generateButton); chapterList.appendChild(listItem);
                     });
                     outlineDisplayArea.appendChild(chapterList);
                 } else { outlineDisplayArea.innerHTML += '<p>Aucun chapitre trouvé dans l\'ossature.</p>'; }
            }

            function displayChapterDetail(chapterNumber, detailData) {
                console.log("Début displayChapterDetail pour chap:", chapterNumber);
                const chapterDetailOutputArea = document.getElementById('chapter-detail-area'); if (!chapterDetailOutputArea) { console.error("ERREUR CRITIQUE: Impossible de trouver #chapter-detail-area !"); return; }
                chapterDetailOutputArea.innerHTML = ''; chapterDetailOutputArea.style.display = 'block'; console.log("Zone vidée et display mis à 'block'.");
                try { const titleElement = document.createElement('h4'); titleElement.textContent = `Détail Chapitre ${chapterNumber}`; chapterDetailOutputArea.appendChild(titleElement); console.log("Titre H4 ajouté."); } catch (e) { console.error("Erreur lors de l'ajout du H4:", e); }
                if (detailData && detailData.scenarioText) { try { const preElement = document.createElement('pre'); preElement.textContent = detailData.scenarioText; chapterDetailOutputArea.appendChild(preElement); console.log("Texte du scénario (<pre>) ajouté à la page."); } catch (e) { console.error("Erreur lors de l'ajout du <pre>:", e); } }
                else if (detailData && detailData.error) { try { const errorElement = document.createElement('p'); errorElement.classList.add('text-danger'); errorElement.textContent = `Erreur reçue du serveur : ${detailData.error} ${detailData.details ? '(' + detailData.details + ')' : ''}`; chapterDetailOutputArea.appendChild(errorElement); console.error("Erreur serveur affichée:", detailData); } catch (e) { console.error("Erreur lors de l'ajout du <p> d'erreur serveur:", e); } }
                else { try { const errorElement = document.createElement('p'); errorElement.style.color = 'orange'; errorElement.textContent = `Impossible d'afficher le détail : données reçues inattendues ou vides.`; chapterDetailOutputArea.appendChild(errorElement); console.warn("Données inattendues reçues:", detailData); } catch (e) { console.error("Erreur lors de l'ajout du <p> de données inattendues:", e); } }
                console.log("Fin de displayChapterDetail.");
            }

            function displayStoryboard(chapterNumber, storyboardData) {
                storyboardOutput.innerHTML = '';
                if (!storyboardData) { storyboardOutput.innerHTML = `<p class="text-danger">Aucune donnée de storyboard reçue pour le chapitre ${chapterNumber}.</p>`; return; }
                if (storyboardData.parsingError) { storyboardOutput.innerHTML = `<h4>Erreur d'Analyse du Storyboard (Chap. ${chapterNumber})</h4><p>L'IA a répondu, mais le format n'a pas pu être analysé automatiquement. Voici le texte brut reçu :</p><pre style="white-space: pre-wrap; background-color: #eee; padding: 10px; border-radius: 4px; max-height: 400px; overflow-y: auto;">${escapeHtml(storyboardData.rawText || 'N/A')}</pre>`; return; }
                if (Array.isArray(storyboardData) && storyboardData.length > 0) {
                     let currentPage = -1; let pageContainer = null;
                     storyboardData.forEach(panelData => {
                          if (panelData.page !== currentPage) { currentPage = panelData.page; pageContainer = document.createElement('div'); pageContainer.classList.add('storyboard-page'); pageContainer.innerHTML = `<h5>Page ${currentPage}</h5>`; storyboardOutput.appendChild(pageContainer); }
                          if(pageContainer) { const panelElement = document.createElement('div'); panelElement.classList.add('storyboard-panel-display'); panelElement.innerHTML = `<h6>Case ${panelData.panel}</h6><div class="storyboard-panel-details"><p><strong>Description:</strong> ${escapeHtml(panelData.description || 'N/A')}</p><p><strong>Type Plan:</strong> ${escapeHtml(panelData.shotType || 'N/A')}</p><p><strong>Angle:</strong> ${escapeHtml(panelData.angle || 'N/A')}</p>${panelData.notes ? `<p><i>Notes: ${escapeHtml(panelData.notes)}</i></p>` : ''}</div>`; pageContainer.appendChild(panelElement); }
                     });
                 } else if (Array.isArray(storyboardData) && storyboardData.length === 0) { storyboardOutput.innerHTML = `<p>Aucune case de storyboard n'a pu être extraite pour le chapitre ${chapterNumber}.</p>`; }
                 else { storyboardOutput.innerHTML = `<h4>Storyboard Chapitre ${chapterNumber} (Format Inconnu)</h4><pre>${escapeHtml(JSON.stringify(storyboardData, null, 2))}</pre>`; }
             }

            function displayPrompts(chapterNumber, promptData) {
                 promptsOutput.innerHTML = '';
                 if (!promptData) { promptsOutput.innerHTML = `<p class="text-danger">Aucune donnée de prompt reçue pour le chapitre ${chapterNumber}.</p>`; return; }
                 if (promptData.parsingError) { promptsOutput.innerHTML = `<h4>Erreur d'Analyse des Prompts (Chap. ${chapterNumber})</h4><p>L'IA a répondu, mais le format des prompts n'a pas pu être analysé correctement (attendait "PAGE X - CASE Y PROMPT: ..."). Voici le texte brut reçu :</p><pre style="white-space: pre-wrap; background-color: #eee; padding: 10px; border-radius: 4px; max-height: 400px; overflow-y: auto;">${escapeHtml(promptData.rawText || 'N/A')}</pre>`; return; }
                 if (promptData.error) { promptsOutput.innerHTML = `<p class="text-danger">Erreur lors de la génération des prompts pour le chapitre ${chapterNumber}: ${escapeHtml(promptData.error)} ${promptData.details ? '(' + escapeHtml(promptData.details) + ')' : ''}</p>`; return; }
                 if (Array.isArray(promptData) && promptData.length > 0) {
                      promptData.forEach(item => {
                           if (item.page === undefined || item.panel === undefined) { console.warn("Prompt item skipped due to missing page/panel number:", item); return; }
                           const promptElement = document.createElement('div'); promptElement.classList.add('prompt-item'); const promptText = item.prompt || 'Prompt vide.';
                           promptElement.innerHTML = `<h6>Page ${item.page} - Case ${item.panel} Prompt:</h6><pre>${escapeHtml(promptText)}</pre><button class="btn btn-sm btn-secondary copy-prompt-btn" data-prompt="${escapeHtml(promptText)}"><i class="fas fa-copy"></i> Copier</button>`;
                           promptsOutput.appendChild(promptElement);
                      });
                      addCopyButtonListeners();
                 } else if (Array.isArray(promptData) && promptData.length === 0) { promptsOutput.innerHTML = `<p>Aucun prompt n'a pu être extrait pour le chapitre ${chapterNumber}, bien que l'API ait répondu.</p>`; }
                 else { promptsOutput.innerHTML = `<h4>Prompts Chapitre ${chapterNumber} (Format Inconnu)</h4><pre>${escapeHtml(JSON.stringify(promptData, null, 2))}</pre>`; }
             }

             function addCopyButtonListeners() {
                 promptsOutput.querySelectorAll('.copy-prompt-btn').forEach(btn => { btn.replaceWith(btn.cloneNode(true)); });
                 promptsOutput.querySelectorAll('.copy-prompt-btn').forEach(btn => { btn.addEventListener('click', handleCopyPrompt); });
             }

             async function handleCopyPrompt(event) {
                 const button = event.currentTarget; const promptToCopy = button.dataset.prompt; if (!promptToCopy) { console.error("Impossible de copier : prompt non trouvé dans data-prompt."); return; }
                 try { await navigator.clipboard.writeText(promptToCopy); const originalText = button.innerHTML; button.innerHTML = '<i class="fas fa-check"></i> Copié !'; button.disabled = true; setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 1500); }
                 catch (err) { console.error('Erreur copie prompt: ', err); alert('Erreur copie. Vérifiez permissions/console.'); }
             }

            // --- UI Update Logic ---
            function updateUI() {
                console.log("Updating UI, current step:", appState.currentStep, "active tab:", appState.activeTab);

                // Progress Indicator
                Object.values(progressSteps).forEach(step => step.classList.remove('active', 'completed'));
                const stepsCompleted = ['idea'];
                if (['outline_generated', 'chapter_detail_generated', 'outline_approved', 'storyboard_generated', 'prompts_generated'].includes(appState.currentStep)) stepsCompleted.push('scenario');
                if (['outline_approved', 'storyboard_generated', 'prompts_generated'].includes(appState.currentStep)) stepsCompleted.push('storyboard');
                if (appState.currentStep === 'prompts_generated') stepsCompleted.push('prompts');
                stepsCompleted.forEach(step => { if(progressSteps[step]) progressSteps[step].classList.add('completed'); });
                if (appState.currentStep === 'idea') progressSteps.idea.classList.add('active');
                else if (appState.currentStep === 'outline_generated' || appState.currentStep === 'chapter_detail_generated') progressSteps.scenario.classList.add('active');
                else if (appState.currentStep === 'outline_approved' || appState.currentStep === 'storyboard_generated') progressSteps.storyboard.classList.add('active');
                else if (appState.currentStep === 'prompts_generated') progressSteps.prompts.classList.add('active');

                // Tabs Activation/Disabling
                const hasValidOutline = !!appState.outlineData && !appState.outlineData.parsingError;
                const hasGeneratedAnyDetails = Object.values(appState.chapterDetailData).some(detail => detail && !detail.error);
                const canAccessStoryboard = hasValidOutline && (appState.currentStep === 'outline_approved' || hasGeneratedAnyDetails);
                const hasGeneratedAnyValidStoryboard = Object.values(appState.storyboardData).some(sb => sb && !sb.error && !sb.parsingError && Array.isArray(sb) && sb.length > 0);
                const canAccessPrompts = hasGeneratedAnyValidStoryboard;

                tabs.scenario.classList.toggle('disabled', !appState.outlineData);
                tabs.storyboard.classList.toggle('disabled', !canAccessStoryboard);
                tabs.prompts.classList.toggle('disabled', !canAccessPrompts);

                // Tab Content Display
                tabContents.forEach(content => { content.style.display = content.id === `${appState.activeTab}-content` ? 'block' : 'none'; });
                tabBtns.forEach(btn => { btn.classList.toggle('active', btn.getAttribute('data-tab') === appState.activeTab); });

                // Scenario Tab
                if (appState.activeTab === 'scenario') {
                    if (appState.outlineData) {
                        displayOutline(appState.outlineData);
                        if (Object.keys(appState.chapterDetailData).length > 0 || chapterDetailArea.innerHTML !== '') { chapterDetailArea.style.display = 'block'; }
                        else { chapterDetailArea.innerHTML = '<p>Sélectionnez un chapitre ci-dessus pour générer son contenu détaillé.</p>'; chapterDetailArea.style.display = 'block'; }
                        scenarioControls.style.display = 'flex'; scenarioModificationArea.style.display = 'none'; approveScenarioBtn.disabled = !hasValidOutline || appState.currentStep === 'outline_approved'; modifyScenarioRequestBtn.disabled = !hasValidOutline; regenerateScenarioBtn.disabled = false;
                    } else {
                        outlineDisplayArea.innerHTML = '<p>Générez d\'abord une ossature depuis l\'onglet "Idée & Options".</p>'; chapterDetailArea.innerHTML = ''; chapterDetailArea.style.display = 'none'; scenarioControls.style.display = 'none'; scenarioModificationArea.style.display = 'none';
                    }
                } else { if(scenarioControls) scenarioControls.style.display = 'none'; if(scenarioModificationArea) scenarioModificationArea.style.display = 'none'; }

                // Storyboard Tab
                if (appState.activeTab === 'storyboard' && canAccessStoryboard && storyboardChapterSelectorContainer) {
                    storyboardChapterSelectorContainer.style.display = 'flex'; const previouslySelected = storyboardChapterSelect.value; storyboardChapterSelect.innerHTML = '<option value="">-- Sélectionnez --</option>'; let hasChaptersWithDetails = false;
                    if (appState.outlineData?.chapters) { appState.outlineData.chapters.forEach(chapter => { if (appState.chapterDetailData[chapter.chapter] && !appState.chapterDetailData[chapter.chapter].error) { const option = document.createElement('option'); option.value = chapter.chapter; option.textContent = `Chapitre ${chapter.chapter}: ${escapeHtml(chapter.title || 'Sans titre')}`; storyboardChapterSelect.appendChild(option); hasChaptersWithDetails = true; } }); }
                    if (!hasChaptersWithDetails) { storyboardChapterSelect.innerHTML = '<option value="">Générez d\'abord le détail d\'un chapitre</option>'; generateStoryboardBtn.disabled = true; }
                    else { if (Array.from(storyboardChapterSelect.options).some(opt => opt.value === previouslySelected)) { storyboardChapterSelect.value = previouslySelected; } else { storyboardChapterSelect.value = ""; } generateStoryboardBtn.disabled = !storyboardChapterSelect.value; }
                    if (!storyboardChapterSelect.value && storyboardOutput.innerHTML.includes('Sélectionnez un chapitre')) {}
                    else if (storyboardChapterSelect.value && storyboardOutput.innerHTML.includes('Prêt à générer')) {}
                    else if (!storyboardChapterSelect.value && !hasChaptersWithDetails) { storyboardOutput.innerHTML = '<p>Générez d\'abord le détail d\'un chapitre dans l\'onglet Scénario.</p>'; }
                    else if (!storyboardChapterSelect.value && hasChaptersWithDetails) { storyboardOutput.innerHTML = '<p>Sélectionnez un chapitre ci-dessus pour générer son storyboard.</p>'; }
                } else if (storyboardChapterSelectorContainer) { storyboardChapterSelectorContainer.style.display = 'none'; }

                 // Prompts Tab
                 if (appState.activeTab === 'prompts') {
                      if (canAccessPrompts && promptsChapterSelectorContainer) {
                          promptsChapterSelectorContainer.style.display = 'flex'; const previouslySelected = promptsChapterSelect.value; promptsChapterSelect.innerHTML = '<option value="">-- Sélectionnez --</option>'; let hasChaptersWithStoryboard = false;
                          if (appState.outlineData?.chapters) { appState.outlineData.chapters.forEach(chapter => { const sbData = appState.storyboardData[chapter.chapter]; if (sbData && !sbData.error && !sbData.parsingError && Array.isArray(sbData) && sbData.length > 0) { const option = document.createElement('option'); option.value = chapter.chapter; option.textContent = `Chapitre ${chapter.chapter}: ${escapeHtml(chapter.title || 'Sans titre')}`; promptsChapterSelect.appendChild(option); hasChaptersWithStoryboard = true; } }); }
                          if (!hasChaptersWithStoryboard) { promptsChapterSelect.innerHTML = '<option value="">Générez d\'abord un storyboard valide</option>'; generatePromptsBtn.disabled = true; }
                          else { if (Array.from(promptsChapterSelect.options).some(opt => opt.value === previouslySelected)) { promptsChapterSelect.value = previouslySelected; } else { promptsChapterSelect.value = ""; } generatePromptsBtn.disabled = !promptsChapterSelect.value; }
                           const selectedChapter = promptsChapterSelect.value;
                          if (!selectedChapter && promptsOutput.innerHTML.includes('Sélectionnez un chapitre')) {}
                          else if (selectedChapter && !appState.promptData[selectedChapter]) { promptsOutput.innerHTML = '<p>Prêt à générer les prompts pour ce chapitre.</p>'; }
                          else if (!selectedChapter && !hasChaptersWithStoryboard) { promptsOutput.innerHTML = '<p>Générez d\'abord le storyboard valide d\'un chapitre dans l\'onglet Storyboard.</p>'; }
                          else if (!selectedChapter && hasChaptersWithStoryboard) { promptsOutput.innerHTML = '<p>Sélectionnez un chapitre ci-dessus pour générer ses prompts.</p>'; }
                      } else if (promptsChapterSelectorContainer) { promptsChapterSelectorContainer.style.display = 'none'; promptsOutput.innerHTML = '<p>Générez d\'abord le storyboard valide d\'un chapitre.</p>'; }
                  } else if (promptsChapterSelectorContainer) { promptsChapterSelectorContainer.style.display = 'none'; }

                console.log("UI Update finished.");
                updateCopyAllButtonState(); // Mettre à jour état bouton copier tout
            }

            // --- Backend Call Functions ---

            async function handleGenerateOutline() {
                 appState.lastInputData = { keywords: keywordsInput.value.trim(), genre: genreSelect.value, style: styleSelect.value, tone: toneSelect.value, details: detailsInput.value.trim() }; if (!appState.lastInputData.keywords) { alert('Veuillez entrer une idée initiale.'); return; }
                 showLoadingIndicator(true); generateScenarioBtn.disabled = true; appState.outlineData = null; appState.chapterDetailData = {}; appState.storyboardData = {}; appState.promptData = {}; appState.activeTab = 'scenario'; updateUI(); outlineDisplayArea.innerHTML = '<p>Envoi de la requête pour l\'ossature...</p>'; chapterDetailArea.style.display = 'none';
                 try { const response = await fetch('/api/generate-story', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(appState.lastInputData) }); if (!response.ok) { let e = `HTTP Error: ${response.status}`; try{ const b=await response.json();e+=` - ${b.error||'Server Error'}${b.details?` (${b.details})`:''}`}catch(p){} throw new Error(e); } const result = await response.json(); if (result.outline) { appState.outlineData = result.outline; appState.currentStep = 'outline_generated'; if (result.outline.parsingError) console.warn("Outline parsing error:", result.outline.parsingError); } else if (result.error) { throw new Error(`API Error: ${result.error}${result.details?` (${result.details})`:''}`); } else { throw new Error("Unexpected server response."); } }
                 catch (error) { console.error("Error handleGenerateOutline:", error); outlineDisplayArea.innerHTML = `<p class="text-danger">Erreur: ${escapeHtml(error.message)}</p>`; chapterDetailArea.style.display = 'none'; appState.outlineData = null; appState.currentStep = 'idea'; }
                 finally { showLoadingIndicator(false); generateScenarioBtn.disabled = false; updateUI(); } // updateUI appelle updateCopyAllButtonState
            }

            async function handleGenerateChapterDetail(event) {
                 const button = event.target; const chapterNumber = button.dataset.chapterNumber; const chapterTitle = button.dataset.chapterTitle; if (!chapterNumber || !appState.outlineData || !appState.lastInputData) { console.error("Data missing for detail gen"); alert("Internal error."); return; } const chapterSummary = appState.outlineData.chapters?.find(ch => ch.chapter == chapterNumber)?.summary || '';
                 console.log(`Requesting detail C${chapterNumber}`); chapterDetailArea.innerHTML = `<p>Génération détail C${chapterNumber}...</p>`; chapterDetailArea.style.display = 'block'; button.disabled = true; button.textContent = '...'; const requestData = { ...appState.lastInputData, globalTitle: appState.outlineData.title, totalChapters: appState.outlineData.chapters.length, chapterNumber: parseInt(chapterNumber, 10), chapterTitle, chapterSummary };
                 try { const response = await fetch('/api/generate-chapter-detail', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) }); if (!response.ok) { let e = `HTTP Error: ${response.status}`; try{ const b=await response.json();e+=` - ${b.error||'Server Error'}${b.details?` (${b.details})`:''}`}catch(p){} throw new Error(e); } const result = await response.json(); appState.chapterDetailData[chapterNumber] = result; if (!result.error) { appState.currentStep = 'chapter_detail_generated'; } displayChapterDetail(chapterNumber, result); }
                 catch (error) { console.error(`Error detail C${chapterNumber}:`, error); appState.chapterDetailData[chapterNumber] = { error: error.message }; displayChapterDetail(chapterNumber, { error: error.message }); }
                 finally { button.disabled = false; button.textContent = 'Générer Détail'; updateUI(); } // updateUI appelle updateCopyAllButtonState
            }

            async function handleGenerateStoryboard() {
                const selectedChapterNumber = storyboardChapterSelect.value; if (!selectedChapterNumber) { alert("Sélectionnez chapitre."); return; } const chapterDetail = appState.chapterDetailData[selectedChapterNumber]; if (!chapterDetail || chapterDetail.error || !chapterDetail.scenarioText) { alert(`Détail C${selectedChapterNumber} non dispo/erreur.`); return; }
                console.log(`Requesting storyboard C${selectedChapterNumber}`); showStoryboardLoading(true); storyboardOutput.innerHTML = `<p>Génération storyboard C${selectedChapterNumber}...</p>`; generateStoryboardBtn.disabled = true; storyboardChapterSelect.disabled = true; const requestData = { ...appState.lastInputData, globalTitle: appState.outlineData.title, chapterNumber: parseInt(selectedChapterNumber, 10), chapterTitle: appState.outlineData.chapters.find(ch => ch.chapter == selectedChapterNumber)?.title || '', detailedScenarioText: chapterDetail.scenarioText };
                try { const response = await fetch('/api/generate-storyboard-chapter', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) }); if (!response.ok) { let e = `HTTP Error: ${response.status}`; try{ const b=await response.json();e+=` - ${b.error||'Server Error'}${b.details?` (${b.details})`:''}`}catch(p){} throw new Error(e); } const result = await response.json(); console.log("Storyboard data:", result); appState.storyboardData[selectedChapterNumber] = result.storyboard; if (result.storyboard?.parsingError) console.warn(`Storyboard parsing error C${selectedChapterNumber}:`, result.storyboard.parsingError); displayStoryboard(selectedChapterNumber, result.storyboard); if (result.storyboard && !result.storyboard.error && !result.storyboard.parsingError) appState.currentStep = 'storyboard_generated'; }
                catch(error) { console.error(`Error storyboard C${selectedChapterNumber}:`, error); appState.storyboardData[selectedChapterNumber] = { error: error.message }; storyboardOutput.innerHTML = `<p class="text-danger">Erreur storyboard: ${escapeHtml(error.message)}</p>`; }
                finally { showStoryboardLoading(false); generateStoryboardBtn.disabled = false; storyboardChapterSelect.disabled = false; updateUI(); }
            }

            async function handleGeneratePrompts() {
                 const selectedChapterNumber = promptsChapterSelect.value; if (!selectedChapterNumber) { alert("Sélectionnez chapitre."); return; } const storyboardChapterData = appState.storyboardData[selectedChapterNumber]; if (!storyboardChapterData || storyboardChapterData.error || storyboardChapterData.parsingError || !Array.isArray(storyboardChapterData) || storyboardChapterData.length === 0) { alert(`Storyboard C${selectedChapterNumber} non dispo/erreur/vide.`); return; }
                 console.log(`Requesting prompts C${selectedChapterNumber}`); showPromptsLoading(true); promptsOutput.innerHTML = `<p>Génération prompts C${selectedChapterNumber}...</p>`; generatePromptsBtn.disabled = true; promptsChapterSelect.disabled = true; const requestData = { style: appState.lastInputData?.style||'?', genre: appState.lastInputData?.genre||'?', tone: appState.lastInputData?.tone||'?', globalTitle: appState.outlineData?.title||'', chapterNumber: parseInt(selectedChapterNumber, 10), chapterTitle: appState.outlineData?.chapters.find(ch => ch.chapter == selectedChapterNumber)?.title||'', storyboardDataForChapter: storyboardChapterData };
                 try { const response = await fetch('/api/generate-prompts-chapter', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) }); if (!response.ok) { let e = `HTTP Error: ${response.status}`; try{ const b=await response.json();e+=` - ${b.error||'Server Error'}${b.details?` (${b.details})`:''}`}catch(p){} throw new Error(e); } const result = await response.json(); console.log("Prompts data:", result); appState.promptData[selectedChapterNumber] = result.prompts || { error: result.error || "Unexpected API response." }; displayPrompts(selectedChapterNumber, appState.promptData[selectedChapterNumber]); if (Array.isArray(appState.promptData[selectedChapterNumber])) appState.currentStep = 'prompts_generated'; }
                 catch(error) { console.error(`Error prompts C${selectedChapterNumber}:`, error); appState.promptData[selectedChapterNumber] = { error: error.message }; displayPrompts(selectedChapterNumber, appState.promptData[selectedChapterNumber]); }
                 finally { showPromptsLoading(false); generatePromptsBtn.disabled = false; promptsChapterSelect.disabled = false; updateUI(); }
            }

            // --- Event Handlers ---
            function handleApproveOutline() { if (!appState.outlineData || appState.outlineData.parsingError) { alert("Cannot approve invalid outline."); return; } const hasAnyDetails = Object.values(appState.chapterDetailData).some(d => d && !d.error); if (!hasAnyDetails) { if (!confirm("No chapter details generated yet. Proceed to Storyboard anyway?")) return; } appState.currentStep = 'outline_approved'; appState.activeTab = 'storyboard'; updateUI(); const firstDetailKey = Object.keys(appState.chapterDetailData).find(k => appState.chapterDetailData[k] && !appState.chapterDetailData[k].error); if (firstDetailKey && storyboardChapterSelect) { storyboardChapterSelect.value = firstDetailKey; generateStoryboardBtn.disabled = false; storyboardOutput.innerHTML = '<p>Ready to generate storyboard.</p>'; } else if (storyboardChapterSelect?.options.length > 1) { storyboardOutput.innerHTML = '<p>Select chapter above.</p>'; } else { storyboardOutput.innerHTML = '<p>Generate chapter detail first.</p>'; } }
            function handleModifyOutlineRequest() { scenarioModificationArea.style.display = 'block'; scenarioControls.style.display = 'none'; }
            async function handleSubmitOutlineModification() { const modReq = scenarioModificationInput.value.trim(); if (!modReq) { alert("Describe modifications."); return; } console.warn("Mod submit not implemented:", modReq); alert("Not implemented yet."); scenarioModificationInput.value = ''; scenarioModificationArea.style.display = 'none'; updateUI(); }
            function handleRegenerateOutline() { if (confirm("Regenerate outline? Current work lost.")) { if(appState.lastInputData) handleGenerateOutline(); else { alert("Initial data not found. Fill inputs."); appState.activeTab = 'home'; updateUI(); } } }

            // *** NOUVELLE FONCTION pour copier tous les détails générés ***
             async function handleCopyAllDetails() {
                 const button = document.getElementById('copy-all-details-btn');
                 if (!appState.outlineData || !appState.outlineData.chapters) { alert("Aucune ossature de chapitre trouvée."); return; }
                 let fullTextToCopy = ""; let chaptersCopiedCount = 0;
                 if (appState.outlineData.title && appState.outlineData.title !== "N/A") { fullTextToCopy += `TITRE GLOBAL : ${appState.outlineData.title}\n====================================\n\n`; }
                 const sortedChapters = [...appState.outlineData.chapters].sort((a, b) => a.chapter - b.chapter);
                 sortedChapters.forEach(chapterInfo => {
                     const chapterNumber = chapterInfo.chapter; const chapterDetail = appState.chapterDetailData[chapterNumber];
                     if (chapterDetail && !chapterDetail.error && chapterDetail.scenarioText) {
                         fullTextToCopy += `CHAPITRE ${chapterNumber} : ${escapeHtml(chapterInfo.title || 'Sans Titre')}\n------------------------------------\n`;
                         fullTextToCopy += chapterDetail.scenarioText; fullTextToCopy += "\n\n====================================\n\n"; chaptersCopiedCount++;
                     }
                 });
                 if (chaptersCopiedCount === 0) { alert("Aucun détail de chapitre généré."); return; }
                 try { await navigator.clipboard.writeText(fullTextToCopy); const originalText = button.innerHTML; button.innerHTML = `<i class="fas fa-check"></i> ${chaptersCopiedCount} Chapitre(s) Copié(s) !`; button.disabled = true; setTimeout(() => { button.innerHTML = `<i class="fas fa-copy"></i> Copier Tous les Détails Générés`; updateCopyAllButtonState(); }, 2500); }
                 catch (err) { console.error('Erreur copie tous détails: ', err); alert('Erreur copie.'); }
             }

             // *** NOUVELLE FONCTION UTILITAIRE pour gérer l'état du bouton ***
             function updateCopyAllButtonState() {
                 const button = document.getElementById('copy-all-details-btn'); if (!button) return;
                 const hasAnyDetails = Object.values(appState.chapterDetailData).some(detail => detail && !detail.error && detail.scenarioText);
                 button.disabled = !hasAnyDetails;
             }

            // --- Event Listeners Setup ---
            tabBtns.forEach(btn => { btn.addEventListener('click', function() { if (this.classList.contains('disabled')) return; appState.activeTab = this.getAttribute('data-tab'); updateUI(); }); });
            generateScenarioBtn.addEventListener('click', handleGenerateOutline);
            approveScenarioBtn.addEventListener('click', handleApproveOutline);
            modifyScenarioRequestBtn.addEventListener('click', handleModifyOutlineRequest);
            submitScenarioModificationBtn.addEventListener('click', handleSubmitOutlineModification);
            regenerateScenarioBtn.addEventListener('click', handleRegenerateOutline);
            if (copyAllDetailsBtn) copyAllDetailsBtn.addEventListener('click', handleCopyAllDetails); // Listener pour nouveau bouton

            if(storyboardChapterSelect) { storyboardChapterSelect.addEventListener('change', function() { generateStoryboardBtn.disabled = !this.value; if(this.value) { if (appState.storyboardData[this.value] && !appState.storyboardData[this.value].error && !appState.storyboardData[this.value].parsingError) displayStoryboard(this.value, appState.storyboardData[this.value]); else if (appState.storyboardData[this.value]?.error || appState.storyboardData[this.value]?.parsingError) displayStoryboard(this.value, appState.storyboardData[this.value]); else storyboardOutput.innerHTML = '<p>Prêt à générer storyboard.</p>'; } else storyboardOutput.innerHTML = '<p>Sélectionnez chapitre.</p>'; }); }
            if(generateStoryboardBtn) generateStoryboardBtn.addEventListener('click', handleGenerateStoryboard);

             if(promptsChapterSelect) { promptsChapterSelect.addEventListener('change', function() { generatePromptsBtn.disabled = !this.value; if(this.value) { if (appState.promptData[this.value]) displayPrompts(this.value, appState.promptData[this.value]); else promptsOutput.innerHTML = '<p>Prêt à générer prompts.</p>'; } else promptsOutput.innerHTML = '<p>Sélectionnez chapitre.</p>'; }); }
             if(generatePromptsBtn) generatePromptsBtn.addEventListener('click', handleGeneratePrompts);

             // Session Management Listeners
             document.getElementById('new-session').addEventListener('click', function() { if (confirm('Nouvelle session ?')) { appState = { currentStep: 'idea', outlineData: null, chapterDetailData: {}, storyboardData: {}, promptData: {}, lastInputData: null, activeTab: 'home' }; keywordsInput.value = ''; genreSelect.selectedIndex = 0; styleSelect.selectedIndex = 0; toneSelect.selectedIndex = 0; detailsInput.value = ''; if(outlineDisplayArea) outlineDisplayArea.innerHTML = '<p>Générez ossature...</p>'; if(chapterDetailArea) { chapterDetailArea.innerHTML = ''; chapterDetailArea.style.display = 'none'; } if(scenarioOutput && !outlineDisplayArea) scenarioOutput.innerHTML = '<p>Générez ossature...</p>'; if(storyboardOutput) storyboardOutput.innerHTML = '<p>Sélectionnez chapitre...</p>'; if(promptsOutput) promptsOutput.innerHTML = '<p>Générez storyboard...</p>'; updateUI(); } }); // updateUI appelle updateCopyAllButtonState
             document.getElementById('save-session').addEventListener('click', function() { appState.lastInputData = { keywords: keywordsInput.value.trim(), genre: genreSelect.value, style: styleSelect.value, tone: toneSelect.value, details: detailsInput.value.trim() }; const sessionName = prompt('Nom session:', `Session_${new Date().toISOString().slice(0,10)}`); if (sessionName) { try { const sessionDataString = JSON.stringify(appState); if (sessionDataString.length > 4*1024*1024) alert("Session large, sauvegarde lente/échec possible."); localStorage.setItem(`bdcreator_session_${sessionName}`, sessionDataString); alert(`Session "${sessionName}" sauvegardée.`); } catch (e) { alert(`Erreur sauvegarde: ${e.message}.`); console.error("Save error:", e); } } });
             document.getElementById('load-session').addEventListener('click', function() {
                 const sessions = []; try { for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key?.startsWith('bdcreator_session_')) sessions.push(key.replace('bdcreator_session_', '')); } } catch(e) { alert("Erreur accès stockage."); console.error("LS error:", e); return; } if (sessions.length === 0) { alert('Aucune session.'); return; } const sessionName = prompt(`Charger session:\n\n${sessions.join('\n')}`, sessions[0]);
                 if (sessionName && sessions.includes(sessionName)) {
                     try { const sessionString = localStorage.getItem(`bdcreator_session_${sessionName}`); if (!sessionString) throw new Error("Données vides."); const loadedState = JSON.parse(sessionString); if (!loadedState?.currentStep || !loadedState?.activeTab) throw new Error("Format invalide."); appState = loadedState; const inputs = appState.lastInputData || {}; keywordsInput.value = inputs.keywords || ''; genreSelect.value = inputs.genre || 'Fantastique'; styleSelect.value = inputs.style || 'Manga'; toneSelect.value = inputs.tone || 'Épique'; detailsInput.value = inputs.details || ''; alert(`Session "${sessionName}" chargée.`);
                         if(outlineDisplayArea) outlineDisplayArea.innerHTML = ''; if(chapterDetailArea) { chapterDetailArea.innerHTML = ''; chapterDetailArea.style.display = 'none';} if(scenarioOutput && !outlineDisplayArea) scenarioOutput.innerHTML = ''; if(storyboardOutput) storyboardOutput.innerHTML = ''; if(promptsOutput) promptsOutput.innerHTML = '';
                         updateUI(); // Met à jour UI + état bouton copier
                         if(appState.activeTab === 'scenario' && appState.outlineData) { displayOutline(appState.outlineData); const firstDetailKey = Object.keys(appState.chapterDetailData).find(k => appState.chapterDetailData[k] && !appState.chapterDetailData[k].error); if(firstDetailKey) displayChapterDetail(firstDetailKey, appState.chapterDetailData[firstDetailKey]); }
                         if(appState.activeTab === 'storyboard') { const selSB = storyboardChapterSelect.value; if (selSB && appState.storyboardData[selSB]) displayStoryboard(selSB, appState.storyboardData[selSB]); }
                         if(appState.activeTab === 'prompts') { const selPr = promptsChapterSelect.value; if (selPr && appState.promptData[selPr]) displayPrompts(selPr, appState.promptData[selPr]); }
                     } catch (e) { alert(`Erreur chargement "${sessionName}" : ${e.message}.`); console.error("Load error:", e); }
                 } else if (sessionName) { alert(`Session invalide: "${sessionName}"`); }
             });

            // --- Initial UI Setup ---
            updateUI(); // Appelle aussi updateCopyAllButtonState

        });
    </script>

</body>
</html>
